<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="React, 顾冷的博客">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>React | 顾冷的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="顾冷的博客" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                        <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                        
                            <span class="logo-span">
                                顾冷的博客
                            </span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">顾冷的博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wuhongzhi5/wuhongzhi5.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #ef6b63;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {

        0%,
        to {
            transform: rotate(0);
        }

        20%,
        60% {
            transform: rotate(-25deg);
        }

        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wuhongzhi5/wuhongzhi5.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
    data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path
            d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
            fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path
            d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
            fill="currentColor" class="octo-body"></path>
    </svg>
</a>
                
    </nav>

</header>
    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">React</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
        /* bottom: 100px;
        overflow-y: scroll; */
    }

    .toc-fixed2 {
        position: fixed;
        top: 64px;
        bottom: 100px;
        overflow-y: scroll;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 30px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/React/">
                                <span class="chip bg-color">React</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-08-24
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="React-终极课程"><a href="#React-终极课程" class="headerlink" title="React 终极课程"></a>React 终极课程</h1><h2 id="1-React-极速入门"><a href="#1-React-极速入门" class="headerlink" title="1. React 极速入门"></a>1. React 极速入门</h2><h3 id="1-1-React-概述"><a href="#1-1-React-概述" class="headerlink" title="1.1 React 概述"></a>1.1 React 概述</h3><h4 id="1-1-1-React-是什么"><a href="#1-1-1-React-是什么" class="headerlink" title="1.1.1 React 是什么"></a>1.1.1 React 是什么</h4><blockquote>
<p>A JavaScript library for building user interfaces</p>
<p>一个用于构建用户界面的 JavaScript 库</p>
</blockquote>
<p>React 是一个开源的 JavaScript 库，用于构建 web 应用中的视图层，实际上就是 web 应用中的前端用户界面。</p>
<img src="/medias/assets/images/01.jpeg" align="left" width="70%">

<p>使用 React 构建的客户端 web 应用可以快速响应用户操作，使 web 应用的使用体验近乎于移动 App。</p>
<p>React 允许开发人员将用户界面代码和逻辑代码进行完美融合，以更加灵活的方式创建用户界面。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import React from "react"
function Welcome(props) {
  return &lt;h1&gt;Hello, {props.name}&lt;/h1&gt;;
  return React.createELement('h1', null , 'hello')
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>了解：React 除了可以构建运行在浏览器中的 web 应用以外，还可以构建在移动端运行的原生 App 应用。</p>
<h4 id="1-1-2-它的背景与生态"><a href="#1-1-2-它的背景与生态" class="headerlink" title="1.1.2 它的背景与生态"></a>1.1.2 它的背景与生态</h4><p>它是由 Facebook 的软件工程师在 2012 年创建，于 2013 年 5 月开源，目前由 Facebook 以及个人开发人员和公司组成的社区维护。</p>
<p>React 生态圈异常活跃，在构建客户端 web 应用的过程中你遇到的问题几乎都可以在社区中找到答案。</p>
<table>
<thead>
<tr>
<th><a target="_blank" rel="noopener" href="https://redux.js.org/">Redux</a></th>
<th><a target="_blank" rel="noopener" href="https://mobx.js.org/README.html">MobX</a></th>
<th><a target="_blank" rel="noopener" href="https://recoiljs.org/">Recoil</a></th>
<th><a target="_blank" rel="noopener" href="https://formik.org/">Formik</a></th>
<th><a target="_blank" rel="noopener" href="https://react-table.tanstack.com/">React Table</a></th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://nextjs.org/">Next.js</a></td>
<td><a target="_blank" rel="noopener" href="https://www.gatsbyjs.com/">Gatsby</a></td>
<td><a target="_blank" rel="noopener" href="https://react-query.tanstack.com/">React Query</a></td>
<td><a target="_blank" rel="noopener" href="https://swr.vercel.app/zh-CN">SWR</a></td>
<td><a target="_blank" rel="noopener" href="https://reactrouter.com/">React Router</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://react-spring.io/">React Spring</a></td>
<td><a target="_blank" rel="noopener" href="https://styled-components.com/">Styled-Components</a></td>
<td><a target="_blank" rel="noopener" href="https://ant.design/docs/react/introduce-cn">Ant Design</a></td>
<td><a target="_blank" rel="noopener" href="https://mui.com/zh/">Material UI</a></td>
<td><a target="_blank" rel="noopener" href="https://mswjs.io/">MSW</a></td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://reactjs.org/">官方文档</a></p>
<img src="/medias/assets/images/14.png">

<h3 id="1-2-React-初体验"><a href="#1-2-React-初体验" class="headerlink" title="1.2 React 初体验"></a>1.2 React 初体验</h3><h4 id="1-2-1-引包-浏览器环境"><a href="#1-2-1-引包-浏览器环境" class="headerlink" title="1.2.1 引包(浏览器环境)"></a>1.2.1 引包(浏览器环境)</h4><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcdn.net/ajax/libs/react/17.0.2/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.bootcdn.net/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>React 可以构建在浏览器中运行的 web 应用，也可以构建在移动端运行的原生应用，React 在构建这两种应用时会有一些通用方法和一些非通用方法，通用方法都被放置在了 <code>react</code> 文件中，非通用方法比如实现 web 应用的方法被放置在了 <code>react-dom</code> 中，实现移动端应用的方法被放置在了 <code>react-native-web</code> 文件中。</p>
<p>react：核心库，包含了构建 web 应用和构建移动端应用的通用方法。</p>
<p>react-dom：只包含了构建 web 应用的方法。</p>
<p>react-native-web：只包含构建移动端应用的方法。</p>
<h4 id="1-2-2-createElement"><a href="#1-2-2-createElement" class="headerlink" title="1.2.2 createElement"></a>1.2.2 createElement</h4><p>引入 <code>react</code> 后，window 对象下会多出一个 <code>React</code> 的对象，对象下面的 <code>createElement</code> 方法用于创建元素。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// type: 标签名称, 字符串.
// props: 元素属性, 对象, 无属性填入 null
// children: 子元素, 普通文本或 createElement 方法返回的元素对象
// 返回值: 元素对象 (虚拟 DOM 对象) 
React.createElement(type, props, children)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"button"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"保存"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="1-2-3-render"><a href="#1-2-3-render" class="headerlink" title="1.2.3 render"></a>1.2.3 render</h4><p>引入 <code>react-dom</code> 后，window 下会多出一个叫做 <code>ReactDOM</code> 的对象，对象下面的 <code>render</code> 方法用于渲染元素。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// element: 待渲染元素对象, 就是通过 createElement 方法创建的虚拟 DOM 对象</span>
<span class="token comment">// container: 虚拟 DOM 对象的渲染位置. 真实 DOM 对象.</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">ReactDOM.render(button, document.getElementById("root"))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="1-2-4-练习"><a href="#1-2-4-练习" class="headerlink" title="1.2.4 练习"></a>1.2.4 练习</h4><p>需求：将指定的 HTML 结构使用 React 提供的方式渲染出来。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>main</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>My Blog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>My first blog post<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>This is the content of my post<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>main</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> paragraph <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"p"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> className<span class="token operator">:</span> <span class="token string">"text"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"This is the content of my post"</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> articleHeader <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"h2"</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">"My first blog post"</span>
<span class="token punctuation">)</span>
<span class="token keyword">const</span> article <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"article"</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  articleHeader<span class="token punctuation">,</span>
  paragraph
<span class="token punctuation">)</span>
<span class="token keyword">const</span> mainHeader <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"h1"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"My Blog"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> main <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
  <span class="token string">"main"</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">"main"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mainHeader<span class="token punctuation">,</span>
  article
<span class="token punctuation">)</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>main<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-3-初识-JSX-语法"><a href="#1-3-初识-JSX-语法" class="headerlink" title="1.3 初识 JSX 语法"></a>1.3 初识 JSX 语法</h3><h4 id="1-3-1-已知问题"><a href="#1-3-1-已知问题" class="headerlink" title="1.3.1  已知问题"></a>1.3.1  已知问题</h4><p>由于 React 内部的优化机制所致, 它必须使用 <code>createElement</code> 方法构建用户界面, 但对于开发者来说该方法又确实增加了编写代码的复杂度。</p>
<p>为了解决以上问题, React 为 <code>createElement</code> 方法创造了替代语法，这种语法和传统的 HTML 语法相似度极高, 这样开发者就可以使用熟悉的语法构建界面了。在应用构建阶段, 再使用 <code>balbel</code> 将这种替代语法转换为 <code>createElement</code> 方法, 这样 React 又可以使用它创建元素了。</p>
<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">const</span> button <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">button</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">"button"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"button"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="1-3-2-JSX-是什么"><a href="#1-3-2-JSX-是什么" class="headerlink" title="1.3.2 JSX 是什么"></a>1.3.2 JSX 是什么</h4><p>JSX 是 JavaScript 编程语言的语法扩充，是由 Facebook 创建的，用于在 React 中构建用户界面。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const button = &lt;button&gt;保存&lt;/button&gt;
ReactDOM.render(button, document.getElementById("root"))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>但是这种语法浏览器是不识别的，所以我们需要借助 Babel 对其进行转换，将其转换为 <code>React.createElement</code> 方法的调用，所以说 JSX 的本质就是 JavaScript。<a target="_blank" rel="noopener" href="https://babeljs.io/repl">Babel REPL</a></p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/@babel/standalone@7.13.17/babel.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="1-3-3-JSX-语法规则"><a href="#1-3-3-JSX-语法规则" class="headerlink" title="1.3.3 JSX 语法规则"></a>1.3.3 JSX 语法规则</h4><h5 id="1-根标记"><a href="#1-根标记" class="headerlink" title="1. 根标记"></a>1. 根标记</h5><p>在使用 JSX 语法创建元素时，元素的最外层必须要有一个根标记。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 错误写法
const jsx = (
	&lt;p&gt;Hello&lt;/p&gt;
  &lt;p&gt;world&lt;/p&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 正确写法
const jsx = (
	&lt;div&gt;
  	&lt;p&gt;Hello&lt;/p&gt;
    &lt;p&gt;world&lt;/p&gt;
  &lt;/div&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为避免因为要满足规定而出现无意义标记，React 提供了占位符标记，占位符标记在渲染后不会产生真实 DOM 对象</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 使用占位符标记充当根元素
// 避免渲染结果出现无意义标记
const jsx = (
	&lt;React.Fragment&gt;
  	&lt;p&gt;Hello&lt;/p&gt;
    &lt;p&gt;world&lt;/p&gt;
  &lt;/React.Fragment&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 占位符标记的简写语法
const jsx = (
	&lt;&gt;
  	&lt;p&gt;Hello&lt;/p&gt;
    &lt;p&gt;world&lt;/p&gt;
  &lt;/&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-单标记自闭合"><a href="#2-单标记自闭合" class="headerlink" title="2. 单标记自闭合"></a>2. 单标记自闭合</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;input type="text"/&gt;
&lt;img src="" alt="" /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="3-属性命名规则"><a href="#3-属性命名规则" class="headerlink" title="3. 属性命名规则"></a>3. 属性命名规则</h5><p>属性名称遵循驼峰式命名法 (小驼峰)</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- HTML 写法 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span> <span class="token attr-name">autofoucs</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// JSX 写法
&lt;input maxLength="10" readOnly autoFocus /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="4-className-属性"><a href="#4-className-属性" class="headerlink" title="4. className 属性"></a>4. className 属性</h5><p>添加类名使用 className 属性，因为 class 在 JavaScript 中是保留关键字</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;!-- HTML 写法 --&gt;
&lt;input class="todos"&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token comment">// JSX 写法</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>todos<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="5-htmlFor-属性"><a href="#5-htmlFor-属性" class="headerlink" title="5. htmlFor 属性"></a>5. htmlFor 属性</h5><p>label 标记使用 htmlFor 属性，因为 for 在 JavaScript 中是保留关键字</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- HTML 写法 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>demo<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>This is a test input<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// JSX 写法
&lt;label htmlFor="demo"&gt;This is a test input&lt;/label&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h5 id="6-JSX-格式美化"><a href="#6-JSX-格式美化" class="headerlink" title="6. JSX 格式美化"></a>6. JSX 格式美化</h5><p>在多个 JSX 标记同时使用时避免不了一定会换行，此时最外层可以加上一组小括号，使标记格式对其避免因格式混乱产生的错误。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const element = (
  &lt;&gt;
    &lt;div&gt;header&lt;/div&gt;
    &lt;div&gt;footer&lt;/div&gt;
  &lt;/&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="7-注释"><a href="#7-注释" class="headerlink" title="7. 注释"></a>7. 注释</h5><p>JSX 中的注释写法为 <code>{/**/}</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const element = (
	&lt;&gt;
  	{/* 头部 */}
    &lt;div&gt;header&lt;/div&gt;
		{/* 底部 */}
    &lt;div&gt;footer&lt;/div&gt;
  &lt;/&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="8-插值语法"><a href="#8-插值语法" class="headerlink" title="8. 插值语法"></a>8. 插值语法</h5><p>在 JSX 中可以使用插值语法将动态数据插入到指定位置。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 插入文本
const someClass = "some-class"
const someText = "I am interpolating text"
const text_jsx = &lt;p className={someClass}&gt;{someText}&lt;/p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 执行计算
const x = 10
const y = 20
const paragraph = &lt;p&gt;{x * y}&lt;/p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 渲染函数返回值
function getValue() {
  return "some value from getValue function"
}
const text = &lt;p&gt;{getValue()}&lt;/p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 插入对象
const other = &lt;p style={{width: 200}}&gt;{{name: "李四"}}&lt;/p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="1-4-create-react-app"><a href="#1-4-create-react-app" class="headerlink" title="1.4 create-react-app"></a>1.4 create-react-app</h3><p><code>create-react-app</code> 是 React 官方提供的用于创建 React 应用的脚手架工具。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> create-react-app -g
create-react-app react-demo
<span class="token function">npm</span> init react-app react-demo
npx create-react-app react-demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-组件化开发基础"><a href="#2-组件化开发基础" class="headerlink" title="2. 组件化开发基础"></a>2. 组件化开发基础</h2><h3 id="2-1-组件概述"><a href="#2-1-组件概述" class="headerlink" title="2.1 组件概述"></a>2.1 组件概述</h3><h4 id="2-1-1-什么是组件"><a href="#2-1-1-什么是组件" class="headerlink" title="2.1.1 什么是组件"></a>2.1.1 什么是组件</h4><p>React 中的组件就是页面中的一小块区域，组件内部会包含这块区域中的视图代码、样式代码以及逻辑代码。</p>
<img src="/medias/assets/images/04.png">

<p>React 采用组件化开发的方式构建用户界面。</p>
<img src="/medias/assets/images/02.png">

<h4 id="2-1-2-组件的设计思想"><a href="#2-1-2-组件的设计思想" class="headerlink" title="2.1.2 组件的设计思想"></a>2.1.2 组件的设计思想</h4><p>组件的核心思想之一就是复用, 定义一次, 到处使用。组件用来封装用户界面中的重复区块，复用重复区块。</p>
<img src="/medias/assets/images/03.png">

<p>组件的另外一个核心思想是解耦, 默认情况下每个组件都有自己的作用域, 内部代码在外部不可见, 这意味着组件之间的代码不会发生冲突, 从而避免在传统开发模式中经常出现的改A坏B的问题。</p>
<img src="/medias/assets/images/05.png">

<h4 id="2-1-3-如何创建组件"><a href="#2-1-3-如何创建组件" class="headerlink" title="2.1.3 如何创建组件"></a>2.1.3 如何创建组件</h4><p>在 React 中组件以函数的形式存在，组件最基本的特征就是一个返回视图(JSX)的函数。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 注意：组件名称首字母必须大写。
function Paragraph() {
  return &lt;p&gt;Hello, React Component&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 React 中，组件以自定义标签的形式进行调用。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">ReactDOM.render(&lt;Paragraph /&gt;, document.getElementById("root"))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">const jsx = (
  &lt;&gt;
    &lt;Paragraph /&gt;
    &lt;Paragraph /&gt;
  &lt;/&gt;
)
ReactDOM.render(jsx, document.getElementById("root"))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>组件和 HTML 一样，都是以树状结构存在的。</p>
<img src="/medias/assets/images/06.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function TextOne() {
  return &lt;b&gt;I am a TextOne Component&lt;/b&gt;
}
function TextTwo () {
  return &lt;b&gt;I am a TextTwo Component&lt;/b&gt;
}
function Paragraph() {
  return (	
    &lt;p&gt;
      &lt;TextOne /&gt;
      &lt;TextTwo /&gt;
    &lt;/p&gt;
  )
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-复用组件"><a href="#2-2-复用组件" class="headerlink" title="2.2 复用组件"></a>2.2 复用组件</h3><h4 id="2-2-1-props"><a href="#2-2-1-props" class="headerlink" title="2.2.1 props"></a>2.2.1 props</h4><p>在调用组件时，可以通过为组件标签添加属性的方式向组件内部传递数据，实现差异化组件复用。</p>
<img src="/medias/assets/images/07.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Paragraph msg="I am first" /&gt;
&lt;Paragraph msg="I am second" /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在组件内部，通过组件函数参数接收组件外部传递进来的数据，组件函数的第一个参数是对象类型，存储了所有外部通过属性的方式传递进来的数据。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Paragraph(props) {
  return &lt;p&gt;{props.msg}&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>组件的 props 参数可以设置默认值, 这样在调用组件时就可以根据需要向组件内部传递数据, 传递了就使用传递值, 没传递就使用默认值。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Person (props) {
  return &lt;div&gt;{props.name}&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">Person.defaultProps = {
  name: "张三"
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person name="李四"/&gt; // 李四
&lt;Person /&gt; // 张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>组件的 props 默认值可以防止组件内部代码执行出错。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Person (props) {
  return &lt;div&gt;{props.info.name}&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person /&gt; // 报错, 因为组件内部代码执行时, 通过 props 获取到的 info 为 undefined, 不能再通过 undefined 获取 name
&lt;Person info={{name: "张三"}}/&gt; // 张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">Person.defaultProps = {
  info: {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person /&gt; // 不会报错, 因为在 JSX 中渲染 undefined 是合法的
&lt;Person info={{name: "张三"}}/&gt; // 张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="2-2-2-children"><a href="#2-2-2-children" class="headerlink" title="2.2.2 children"></a>2.2.2 children</h4><p>在调用组件时，可以向组件标签内部添加 JSX，实现差异化组件复用，相比 props, 使用 children 可以向组件内部传递更加复杂的数据。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person&gt;
  Hello, React Children
&lt;/Person&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person&gt;
  &lt;p&gt;single child&lt;/p&gt;
&lt;/Person&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person&gt;
  &lt;p&gt;multiple childs&lt;/p&gt;
  &lt;p&gt;multiple childs&lt;/p&gt;
  &lt;p&gt;multiple childs&lt;/p&gt;
&lt;/Person&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Person (props) {
  return &lt;div&gt;{props.children}&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>children 的其中一个经典应用场景是辅助创建布局组件。布局组件可以增强组件复用能力。</p>
<img src="/medias/assets/images/03.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function HomePage() {
  return &lt;div&gt;HomePage&lt;/div&gt;;
}
function AboutPage() {
  return &lt;div&gt;AboutPage&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Header() {
  return &lt;div&gt;Header&lt;/div&gt;;
}
function Footer() {
  return &lt;div&gt;Footer&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Layout(props) {
  return (
    &lt;&gt;
      &lt;Header /&gt;
      &lt;div&gt;{props.children}&lt;/div&gt;
      &lt;Footer /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function HomePage() {
  return &lt;Layout&gt;HomePage&lt;/Layout&gt;;
}
function AboutPage() {
  return &lt;Layout&gt;AboutPage&lt;/Layout&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-组件模板"><a href="#2-3-组件模板" class="headerlink" title="2.3 组件模板"></a>2.3 组件模板</h3><h4 id="2-3-1-事件程序"><a href="#2-3-1-事件程序" class="headerlink" title="2.3.1 事件程序"></a>2.3.1 事件程序</h4><h5 id="1-添加事件"><a href="#1-添加事件" class="headerlink" title="1. 添加事件"></a>1. 添加事件</h5><p>在 JSX 中，为元素添加事件，事件名称采用驼峰使命名法，事件处理函数通过插值的方式指定。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App () {
  const onClickHandler = () =&gt; {
    console.log('Hello, Event')
    r
  }
  return &lt;button onClick={onClickHandler}&gt;按钮&lt;/button&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-事件传参"><a href="#2-事件传参" class="headerlink" title="2. 事件传参"></a>2. 事件传参</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App () {
  const onClickHandler = (arg1, arg2) =&gt; {}
  return &lt;button onClick={() =&gt; onClickHandler('a', 'b')}&gt;按钮&lt;/button&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-事件对象"><a href="#3-事件对象" class="headerlink" title="3. 事件对象"></a>3. 事件对象</h5><p>事件处理函数在没有传递参数的情况下，第一个参数默认就是事件对象。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App () {
  const onClickHandler = (event) =&gt; {}
  return &lt;button onClick={onClickHandler}&gt;按钮&lt;/button&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在调用事件处理函数时，可以将事件对象作为参数显式传递。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App () {
  const onClickHandler = (arg1, event, arg2) =&gt; {}
  return &lt;button onClick={(event) =&gt; onClickHandler('a', event, 'b')}&gt;按钮&lt;/button&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-3-2-条件渲染"><a href="#2-3-2-条件渲染" class="headerlink" title="2.3.2 条件渲染"></a>2.3.2 条件渲染</h4><p>在组件模板中, 根据条件的不同渲染不同的视图元素。</p>
<h5 id="1-if-条件判断"><a href="#1-if-条件判断" class="headerlink" title="1. if 条件判断"></a>1. if 条件判断</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function OnMessage() {
  return &lt;span&gt;The Machine is On&lt;/span&gt;
}
function OffMessage() {
  return &lt;span&gt;The Machine is Off&lt;/span&gt;
}
function OnOff() {
  if (true) {
    return &lt;OnMessage /&gt;
  } else {
    return &lt;OffMessage /&gt;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Machine() {
  const getMessage = () =&gt; {
    if (true) {
      return &lt;OnMessage /&gt;
    } else {
      return &lt;OffMessage /&gt;
    }
  }
  return &lt;p&gt;{getMessage()}&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Machine() {
  let message = null
  if (true) {
    message = &lt;OnMessage /&gt;
  } else {
    message = &lt;OffMessage /&gt;
  }
  return &lt;p&gt;{message}&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-三元运算符"><a href="#2-三元运算符" class="headerlink" title="2. 三元运算符"></a>2. 三元运算符</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function Machine() {
  return &lt;p&gt;{true ? &lt;OnMessage /&gt; : &lt;OffMessage /&gt;}&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">const isError = true
const errorContainer = (
  &lt;div className={isError ? "error" : "standard"}&gt;
    {isError ? &lt;p&gt;Something went wrong...&lt;/p&gt; : &lt;p&gt;Everythis is ok&lt;/p&gt;}
  &lt;/div&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-AND-运算符"><a href="#3-AND-运算符" class="headerlink" title="3. AND 运算符"></a>3. AND 运算符</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function ErrorMessage() {
  return &lt;span&gt;Something went wrong&lt;/span&gt;
}
function Machine() {
  return &lt;p&gt;{true &amp;&amp; &lt;ErrorMessage /&gt;}&lt;/p&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-3-3-列表渲染"><a href="#2-3-3-列表渲染" class="headerlink" title="2.3.3 列表渲染"></a>2.3.3 列表渲染</h4><h5 id="1-数组自动展开"><a href="#1-数组自动展开" class="headerlink" title="1. 数组自动展开"></a>1. 数组自动展开</h5><p>在 JSX 中，可以将数组直接放入插值表达式，数组将会被自动展开，数组中的元素会被直接渲染到该位置。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const data = ["The beach", "The mountains", "Vibrant cities", "Roughing it"]
const jsx = &lt;div&gt;{data}&lt;/div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>


<pre class="line-numbers language-react" data-language="react"><code class="language-react">const jsxArray = [
  &lt;li&gt;list-item-1&lt;/li&gt;,
  &lt;li&gt;list-item-2&lt;/li&gt;,
  &lt;li&gt;list-item-3&lt;/li&gt;,
];
const jsx = &lt;ul&gt;{jsxArray}&lt;/ul&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：不能直接将对象数组放置在插值语法中，因为当数组被展开后，JSX 不知道要如何渲染对象。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const data = [
  { name: "The beach" },
  { name: "The mountains" },
  { name: "Vibrant cities" },
  { name: "Roughing it" }
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-列表渲染-map"><a href="#2-列表渲染-map" class="headerlink" title="2. 列表渲染(map)"></a>2. 列表渲染(map)</h5><p>map 方法用于对列表中的每一项数据进行转换，转换后的结果被存放在一个新的数组中。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> newArray <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item <span class="token operator">*</span> index<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArray<span class="token punctuation">)</span> <span class="token comment">// [0, 2, 6, 12]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>map 方法内部会对原始数组进行遍历，在遍历过程中不断调用传递到 map 方法中的回调函数，并将当前遍历的值和索引传递给回调函数，回调函数的返回值会被存储到一个新的数组中，遍历结束后返回新数组。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myMap</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>map 方法在 JSX 中的应用：将数组中的内容渲染到 ul 标签中, 内容使用 li 标签包裹。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">let data = ["Data1", "Data2", "Data3"]
let result = (
	&lt;ul&gt;
  	{data.map(item =&gt; (
      &lt;li&gt;{item}&lt;/li&gt;
    ))}
  &lt;/ul&gt;
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/images/08.png">

<h5 id="3-key-属性"><a href="#3-key-属性" class="headerlink" title="3. key 属性"></a>3. key 属性</h5><p>在列表渲染的过程中，React 建议开发者为列表项添加 key 属性，否则在控制台中输出警告。</p>
<img src="/medias/assets/images/16.png">

<p>key 属性用于为列表中的元素提供标识，React 使用该标识识别列表中的哪些元素发生了变化，实现只操作发生更改的元素，以此来提升渲染性能。</p>
<p>下列代码在没有 key 属性的情况下，当数据发生更新以后，所有元素重新渲染。</p>
<img src="/medias/assets/images/18.png" align="left" width="50%">

<p>下列代码在有 key 属性的情况下，当数据发生更新以后，只有发生变化的元素被重新渲染了，其他元素被复用。</p>
<img src="/medias/assets/images/19.png" align="left" width="64%">

<p>key 属性值的值必须是不重复的，一般使用数据 id 作为 key 属性的值。</p>
<p>如果列表只在组件初始化的时候渲染一次，后续不发生变化，也可以使用循环索引作为 key 属性的值。</p>
<img src="/medias/assets/images/17.png" align="left" width="85%">

<h5 id="4-列表过滤-filter"><a href="#4-列表过滤-filter" class="headerlink" title="4. 列表过滤(filter)"></a>4. 列表过滤(filter)</h5><p>filter 方法用于对列表元素进行过滤，根据过滤条件将符合的元素存放到一个新的数组中。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"The beach"</span><span class="token punctuation">,</span> topDestination<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"The mountains"</span><span class="token punctuation">,</span> topDestination<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Vibrant cities"</span><span class="token punctuation">,</span> topDestination<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Roughing it"</span><span class="token punctuation">,</span> topDestination<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> newArray <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>topDestination<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>filter 方法内部会对原始数组进行遍历, 在遍历过程中会不断调用传递给 filter 方法的回调函数, 并且会将当前遍历值和索引传递给回调函数, 如果回调函数返回 true, 将当前遍历值留下, 否则排除当前遍历值。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">myFilter</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">const</span> newArray <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">myFilter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>topDestination<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>filter 方法在 JSX 中的应用: 对数据进行过滤然后再通过 map 方法对数据进行转换, 最终渲染数据。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const list = [
  { id: 1, name: "The beach", topDestination: true },
  { id: 2, name: "The mountains", topDestination: false },
  { id: 3, name: "Vibrant cities", topDestination: true },
  { id: 4, name: "Roughing it", topDestination: false },
];
const result = (
  &lt;ul&gt;
    {list
      .filter((item) =&gt; item.topDestination)
      .map((item) =&gt; (
      	&lt;li key={item.id}&gt;{item.name}&lt;/li&gt;
    	))}
  &lt;/ul&gt;
);
ReactDOM.render(result, document.getElementById("root"));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-组件状态"><a href="#2-4-组件状态" class="headerlink" title="2.4 组件状态"></a>2.4 组件状态</h3><h4 id="2-4-1-组件状态概述"><a href="#2-4-1-组件状态概述" class="headerlink" title="2.4.1 组件状态概述"></a>2.4.1 组件状态概述</h4><p>在现实世界中，状态通常是指人或事物表现出来的形态。</p>
<p>由于组件执行的最终结果就是用户界面，所以组件状态指的就是用户界面的状态。</p>
<img src="/medias/assets/images/20.gif" align="left" width="50%">

<p><a target="_blank" rel="noopener" href="https://codepen.io/davidkpiano/pen/WZYXKv">Gallery app with Finite State Machines</a></p>
<img src="/medias/assets/images/21.png" align="left" width="55%">

<p>React 遵循数据驱动 DOM 的理念，数据的变化会引起视图的自动更新。</p>
<p>这里所说的数据其实就是组件状态数据，组件状态数据其实就是组件内部维护的能够驱动视图更新的数据。</p>
<p>React 将组件看成是状态机，用户与绑定了组件状态数据的视图进行交互，从而产生新的状态，React 再使用新的状态数据渲染新的视图状态。</p>
<h4 id="2-4-2-钩子函数概述"><a href="#2-4-2-钩子函数概述" class="headerlink" title="2.4.2 钩子函数概述"></a>2.4.2 钩子函数概述</h4><p>React 使用函数作为组件，但是函数自身有重大限制，就是不能持续保存状态，因为函数在执行完成以后内部的局部变量就被释放了。</p>
<p>但是作为组件，它必须具备保存状态的功能，因为只有状态被保存了，我们才可以基于现有状态计算新状态，使用新的状态更新视图。</p>
<p>为了对函数组件功能进行增强，React 提供了钩子函数，你想要在函数组件内部使用什么功能，就使用钩子函数将该功能”钩”进函数组件内部。</p>
<p>所有的钩子都是为函数引入外部功能，所以 React 约定，钩子一律使用 <code>use</code> 前缀命名，便于识别。</p>
<h4 id="2-4-3-useState"><a href="#2-4-3-useState" class="headerlink" title="2.4.3 useState"></a>2.4.3 useState</h4><p><code>React.useState</code> 方法用于声明组件状态数据，通过该方法声明的状态数据被更改后会触发视图更新。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  // initialState 参数是初始渲染期间使用的状态，在随后的渲染中，它被忽略。
  // 返回值是一个数组，从数组中结构出来的第一个值是状态变量，第二个值是更改状态的方法。
  const [value, setValue] = React.useState("initialState");  
  return (
    &lt;&gt;
      &lt;p&gt;{value}&lt;/p&gt;
      &lt;button onClick={() =&gt; setValue("state is changed")}&gt;
        更改视图状态
      &lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>React.useState</code> 方法可以在组件中多次被调用，用于声明多个状态数据。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [value, setValue] = React.useState("initial state value");
  const [count, setCount] = React.useState(0);
  return (
    &lt;&gt;
      &lt;p&gt;{value}&lt;/p&gt;
      &lt;button onClick={() =&gt; setValue("state is changed")}&gt;
        更改视图状态
      &lt;/button&gt;
      &lt;p&gt;{count}&lt;/p&gt;
      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;+1&lt;/button&gt;
      &lt;button onClick={() =&gt; setCount(count - 1)}&gt;-1&lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改状态的方法可以接收回调函数作为参数，在参数回调函数中返回最新状态，好处是可以将修改状态的逻辑包裹在一起。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = React.useState(0);
  const onClickHandler = () =&gt; {
    setCount((currentCount) =&gt; {
      return currentCount + 1;
    });
  }
  return &lt;button onClick={onClickHandler}&gt;{value}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>钩子函数只能在组件内部第一层作用域中调用，不能组件内部的方法中调用，也不能在 if 条件判断中调用。</p>
<img src="/medias/assets/images/33.png">

<h4 id="2-4-4-useEffect"><a href="#2-4-4-useEffect" class="headerlink" title="2.4.4 useEffect"></a>2.4.4 useEffect</h4><h5 id="1-副作用概述"><a href="#1-副作用概述" class="headerlink" title="1. 副作用概述"></a>1. 副作用概述</h5><p>在现实生活中副作用指的就是不良反应，比如吃了过期食品导致的上吐下泻，吃头孢喝酒产生的心力衰竭等都属于副作用。</p>
<p>组件的职责就围绕 props 和 state 计算用户界面所需要的状态数据，其他的和渲染用户界面逻辑没有关系的操作都属于副作用。</p>
<p>比如 Ajax Request、手动修改 DOM、localStorage、console.log、setInterval 等。</p>
<p>副作用本身不是错误代码，但是如果副作用代码在组件中放置的不是最佳位置，可能导致组件的性能变差。</p>
<h5 id="2-useEffect-方法"><a href="#2-useEffect-方法" class="headerlink" title="2. useEffect 方法"></a>2. useEffect 方法</h5><p>useEffect 方法的作用就是确保将副作用代码在正确的时机被执行，消除不必要的性能消耗。</p>
<p>在以下代码中，设置网页标题的代码属于副作用代码，该代码放置的不是最佳位置，导致它在不需要执行的时候被执行，导致组件性能变差。同步网页标题的代码只用到了 count，只有 count 状态发生变化以后，同步网页标题的代码才需要被执行，但目前的结果是无论 count 发生变化还是 value 发生变化，同步网页标题的代码都会被执行。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = React.useState(0);
  const [value, setValue] = React.useState(99);
  // 以下两句代码都属于副作用代码
  document.title = count;
  console.log("网页标题同步成功");
  return (
    &lt;&gt;
      &lt;p&gt;{count}&lt;/p&gt;
      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;+1&lt;/button&gt;
      &lt;button onClick={() =&gt; setValue(value - 1)}&gt;{value}&lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 useEffect 方法监听特定状态的变化，从而执行和该状态相关的副作用代码。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = React.useState(0);
  const [value, setValue] = React.useState(99);
  // 组件初始渲染后执行, 特定状态发生变化后执行
  // 第一个参数是函数类型, 监听的状态发生变化后该回调函数被执行
  // 第二个参数是数组类型, 数组中填写的是要监听的状态
  React.useEffect(() =&gt; {
    document.title = count;
    console.log("网页标题同步成功");
  }, [count]);
  return (
    &lt;&gt;
      &lt;p&gt;{count}&lt;/p&gt;
      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;+1&lt;/button&gt;
      &lt;button onClick={() =&gt; setValue(value - 1)}&gt;{value}&lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在以下代码中，Ajax 请求代码属于副作用代码，该代码放置的不是最佳位置，导致只要组件状态变化请求就会重新发送，但是我们希望请求只发送一次。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = React.useState(0);
  axios.get("https://api.github.com/users/defunkt").then((response) =&gt; {
    console.log(response.data);
  });
  return &lt;button onClick={() =&gt; setCount(count + 1)}&gt;{count}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>使用 useEffect 方法设置指定的副作用代码只在组件第一次渲染完成后执行一次。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = React.useState(0);
  React.useEffect(() =&gt; {
    axios.get("https://api.github.com/users/defunkt").then((response) =&gt; {
      console.log(response.data);
    });
  }, []);
  return &lt;button onClick={() =&gt; setCount(count + 1)}&gt;{count}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在以下代码中定时器属于副作用代码，虽然定时器只会被开启一次，但是在组件被卸载后定时器仍然在执行。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  React.useEffect(() =&gt; {
    setInterval(() =&gt; {
      console.log("hello");
    }, 1000);
  }, []);
  return &lt;button onClick={() =&gt;  ReactDOM.unmountComponentAtNode(document.getElementById("root"))}&gt;卸载组件&lt;/button&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 useEffect 方法指定组件卸载前执行的清理函数，用于执行副作用清理操作。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  React.useEffect(() =&gt; {
    const timer = setInterval(() =&gt; {
      console.log("hello");
    }, 1000);
    // 该函数在组件卸载前被执行
    return () =&gt; clearInterval(timer);
  }, []);
  return (
    &lt;&gt;
      &lt;button onClick={() =&gt; setCount(count + 1)}&gt;{count}&lt;/button&gt;
      &lt;button onClick={() =&gt;  ReactDOM.unmountComponentAtNode(document.getElementById("root"))}&gt;卸载组件&lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-5-组件通讯"><a href="#2-5-组件通讯" class="headerlink" title="2.5 组件通讯"></a>2.5 组件通讯</h3><h4 id="3-1-1-父子通讯"><a href="#3-1-1-父子通讯" class="headerlink" title="3.1.1 父子通讯"></a>3.1.1 父子通讯</h4><p>在 React 应用中，组件与组件之间传递状态数据采用的是单向数据流架构，这是构建 React 应用必须遵循的状态数据传递规范。</p>
<p>单向数据流指的是状态数据只能在一个方向上传递，就是从上到下，即从父组件到子组件。状态数据不能反向传递，也不能横传递。</p>
<img src="/medias/assets/images/24.png" align="left" width="55%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [msg, setMsg] = React.useState("Hello React");
  // 将 msg 状态数据传递到子组件
  return &lt;Message msg={msg} /&gt;;
}
function Message(props) {
  // 接收来自父组件的 msg 状态数据
  return &lt;div&gt;{props.msg}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>单向数据流意味着子组件不能直接更新父组件传递下来的状态数据以达到更新视图的目的，事实上 props 参数也是只读的不能被修改。</p>
<p>在子组件中若想修改父组件传递的下来的状态数据，父组件必须一并将修改状态的方法传递到子组件，子组件通过调用该方法先更新父组件状态，父组件再将状态传递到子组件以触发视图更新。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [msg, setMsg] = React.useState("Hello React");
  // 将 msg 状态数据传递到子组件
  return &lt;Message msg={msg} setMsg={setMsg} /&gt;;
}
function Message(props) {
  // 接收来自父组件的 msg 状态数据
  return (
    &lt;&gt;
      &lt;p&gt;{props.msg}&lt;/p&gt;
      &lt;button onClick={() =&gt; props.setMsg("Hi Data Flow")}&gt;button&lt;/button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/images/23.png" align="left" width="75%">

<p>父组件将初始状态的快照传递给子组件。</p>
<p>子组件根据当前的 prop 值渲染用户界面。</p>
<p>用户与用户界面进行交互，例如点击按钮或输入文字。</p>
<p>用户的操作不会直接更新视图，它会先触发父组件中状态的更新。</p>
<p>更新之后的状态数据通过 props 向下传递到子组件。</p>
<p>用户界面被重新渲染以同步当前状态。</p>
<h4 id="3-1-2-兄弟通讯"><a href="#3-1-2-兄弟通讯" class="headerlink" title="3.1.2 兄弟通讯"></a>3.1.2 兄弟通讯</h4><p>在 React 中若要实现兄弟组件通讯需要借助组件状态提升思想。组件状态提升指的是将兄弟组件之间的共享状态提升到最近的公共父级组件中，由公共父级组件维护这个状态和修改状态的方法，父级组件再通过 props 的方式将状态数据传递到两个子组件中。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [person, setPerson] = React.useState({ name: "张三" });
  return (
    &lt;&gt;
      &lt;Message person={person} /&gt;
      &lt;Machine person={person} /&gt;
    &lt;/&gt;
  );
}
function Message(props) {
  return &lt;p&gt;Message: {props.person.name}&lt;/p&gt;;
}
function Machine(props) {
  return &lt;p&gt;Machine: {props.person.name}&lt;/p&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-13-JSX-扩展运算符"><a href="#3-13-JSX-扩展运算符" class="headerlink" title="3.13 JSX 扩展运算符"></a>3.13 JSX 扩展运算符</h4><p>在 JSX 中可以使用扩展运算符将对象展开，对象展开后将对象中的每个属性直接传入组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 以下两种写法是等价的
function App() {
  const greeting = { sayHello: "Hello", sayHi: "hi" };
  return &lt;Message sayHello={greeting.sayHello} sayHi={greeting.sayHi} /&gt;;
}
function App() {
  const greeting = { sayHello: "Hello", sayHi: "hi" };
  return &lt;Message {...greeting} /&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 放置数据在传递的过程中增加层级
function App() {
  const values = { sayHello: "Hello", sayHi: "hi" };
  return &lt;Message {...values} /&gt;;
}

function Message(props) {
  return &lt;Button {...props} /&gt;;
}

function Button(props) {
  return &lt;pre&gt;{JSON.stringify(props, null, 2)}&lt;/pre&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// JSX 扩展运算符的另一种使用场景
function Button (props) {
  const { kind, ...other } = props;
  const className = kind === "primary" ? "PrimaryButton" : "SecondaryButton";
  return &lt;button className={className} {...other} /&gt;;
}

function App () {
  return (
    &lt;div&gt;
      &lt;Button kind="primary"&gt;
        Hello World!
      &lt;/Button&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-1-4-Context"><a href="#3-1-4-Context" class="headerlink" title="3.1.4  Context"></a>3.1.4  Context</h4><h5 id="1-prop-drilling-概述"><a href="#1-prop-drilling-概述" class="headerlink" title="1. prop drilling 概述"></a>1. prop drilling 概述</h5><p>在 React 中，为了让兄弟组件实现状态共享，我们通常会将状态进行提升，提升至它们最近的公共父级，但是当组件层级关系比较复杂时，这种方式并不理想，因为在这个过程中有很多组件并不需要使用该状态，但是却参与了状态的传递。我们通常将这种情况称之为 prop drilling。</p>
<img src="/medias/assets/images/25.jpeg" align="left" width="60%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// Application: 应用页面级组件
function Application() {
  const userName = "John Smith";
  return &lt;Layout userName={userName}&gt;Main content&lt;/Layout&gt;;
}
// Layout: 应用布局组件
function Layout({ children, userName }) {
  return (
    &lt;div&gt;
      &lt;Header userName={userName} /&gt;
      &lt;main&gt;{children}&lt;/main&gt;
    &lt;/div&gt;
  );
}
// Header 头部组件
function Header({ userName }) {
  return (
    &lt;header&gt;
      &lt;UserInfo userName={userName} /&gt;
    &lt;/header&gt;
  );
}
// UserInfo: 用户信息组件
function UserInfo({ userName }) {
  return &lt;span&gt;{userName}&lt;/span&gt;;
}
// 渲染应用级页面组件 Application
ReactDOM.render(&lt;Application /&gt;, document.getElementById("root"));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-Context-概述"><a href="#2-Context-概述" class="headerlink" title="2. Context 概述"></a>2. Context 概述</h5><p>为了解决以上问题，React 提供了 Context (上下文)，它允许组件访问全局状态并在全局状态发生更改时重新渲染组件。</p>
<p>无论需要数据的组件被嵌套的层级有多深，Context 都可以轻松为该组件传递状态。</p>
<img src="/medias/assets/images/26.jpeg" align="left" width="60%">

<h5 id="3-Context-使用教程"><a href="#3-Context-使用教程" class="headerlink" title="3.  Context 使用教程"></a>3.  Context 使用教程</h5><p>在 React 中使用 Context 需要三个步骤：创建 Context、通过 Context 提供状态、组件通过 Context 获取状态。</p>
<p>第一步：通过 <code>React.createContext</code> 方法创建 Context，并提供默认状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 创建 Context 对象
// createContext 方法的参数就是默认的状态值
const Context = React.createContext("Default Value");<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第二步：组件通过 <code>React.useContext</code> 方法获取默认状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  // 组件通过 useContext 方法获取 Context 提供的默认状态
  const value = React.useContext(Context);
  return &lt;div&gt;{value}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三步：通过 <code>Context.Provider</code> 组件提供全局状态，实现组件访问。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 创建 Context 对象存储默认状态值
const Context = React.createContext("Default Value");

function App() {
  const value = "My Context Value";
  // 通过 Context.Provider 组件提供状态, 该状态值会覆盖默认状态值
  return (
    &lt;Context.Provider value={value}&gt;
      &lt;MyComponent /&gt;
    &lt;/Context.Provider&gt;
  );
}

function MyComponent() {
  // 下层组件获取 Context 全局状态值
  const value = React.useContext(Context);
  return &lt;div&gt;{value}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="4-Context-使用示例"><a href="#4-Context-使用示例" class="headerlink" title="4.  Context 使用示例"></a>4.  Context 使用示例</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">const UserContext = React.createContext({
  userName: "",
  setUserName: () =&gt; {},
});
function Application() {
  const [userName, setUserName] = React.useState("John Smith");
  return (
    &lt;UserContext.Provider value={{ userName, setUserName }}&gt;
      &lt;UserInfo /&gt;
      &lt;UserNameInput /&gt;
    &lt;/UserContext.Provider&gt;
  );
}
function UserInfo() {
  const { userName } = React.useContext(UserContext);
  return &lt;p&gt;{userName}&lt;/p&gt;;
}
function UserNameInput() {
  const { userName, setUserName } = React.useContext(UserContext);
  const changeHandler = (event) =&gt; setUserName(event.target.value);
  return &lt;input type="text" value={userName} onChange={changeHandler} /&gt;;
}
ReactDOM.render(&lt;Application /&gt;, document.getElementById("root"));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-6-表单控制"><a href="#2-6-表单控制" class="headerlink" title="2.6  表单控制"></a>2.6  表单控制</h3><h4 id="2-6-1-受控表单组件"><a href="#2-6-1-受控表单组件" class="headerlink" title="2.6.1 受控表单组件"></a>2.6.1 受控表单组件</h4><p>在 React 组件中使用表单元素时，为了方便获取表单控件的值，通常都会将表单控件和组件状态进行绑定，通过该方式使用表单的组件叫做受控表单组件。</p>
<h5 id="1-text"><a href="#1-text" class="headerlink" title="1. text"></a>1. text</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [username, setUsername] = React.useState("");
  return (
    &lt;input
      type="text"
      value={username}
      onChange={(event) =&gt; setUsername(event.target.value)}
    /&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-password"><a href="#2-password" class="headerlink" title="2. password"></a>2. password</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// 优化前
function App() {
  const [formState, setFormState] = React.useState({
    username: "",
    password: "",
  });
  return (
    &lt;&gt;
      &lt;input
        type="text"
        value={formState.username}
        onChange={(event) =&gt; setFormState({ ...formState, username: event.target.value })}/&gt;
      &lt;input
        type="password"
        value={formState.password}
        onChange={(event) =&gt; setFormState({ ...formState, password: event.target.value })}/&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 优化后
function App() {
  const [formState, setFormState] = React.useState({
    username: "",
    password: "",
  });
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  return (
    &lt;&gt;
      &lt;input type="text" name="username" value={formState.username} onChange={onChangeHandler} /&gt;
      &lt;input type="password" name="password" value={formState.password} onChange={onChangeHandler} /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-textarea"><a href="#3-textarea" class="headerlink" title="3. textarea"></a>3. textarea</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [formState, setFormState] = React.useState({
    biography: "",
  });
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  return &lt;textarea name="biography" value={formState.biography} onChange={onChangeHandler}&gt;&lt;/textarea&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="4-select"><a href="#4-select" class="headerlink" title="4. select"></a>4. select</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [formState, setFormState] = React.useState({
    transport: "",
  });
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  return (
    &lt;select
      name="transport"
      value={formState.transport}
      onChange={onChangeHandler}
      &gt;
      &lt;option value=""&gt;请选择交通方式&lt;/option&gt;
      &lt;option value="0"&gt;火车&lt;/option&gt;
      &lt;option value="1"&gt;飞机&lt;/option&gt;
    &lt;/select&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="5-radio"><a href="#5-radio" class="headerlink" title="5. radio"></a>5. radio</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [formState, setFormState] = React.useState({
    size: "",
  });
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  return (
    &lt;&gt;
    	&lt;input type="radio" name="size" value="m"  onChange={onChangeHandler} /&gt;
    	&lt;span&gt;M&lt;/span&gt;
    	&lt;input type="radio" name="size" value="s" onChange={onChangeHandler} /&gt;
    	&lt;span&gt;S&lt;/span&gt;
		&lt;/&gt;
	);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="6-checkbox"><a href="#6-checkbox" class="headerlink" title="6. checkbox"></a>6. checkbox</h5><p>checkbox 单独使用，比如是否同意协议、是否记住密码、是否保持登录状态等等，在这种情况下 checkbox 绑定布尔值。</p>
<p>当前的需求是查看用户是否同意了网站协议。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [formState, setFormState] = React.useState({
    agree: false,
  });
  const onChangeHandler = (event) =&gt; {
    // 如果表单控件是复选框, 获取 checked 属性的值作为 value
    const value =
          event.target.type === "checkbox"
    ? event.target.checked
    : event.target.value;
    setFormState({
      ...formState,
      [event.target.name]: value,
    });
  };
  return (
    &lt;input
      type="checkbox"
      name="agree"
      checked={formState.agree}
      onChange={onChangeHandler}
      /&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>多个复选框一起使用，比如选择兴趣爱好、多选题等。</p>
<p>当前的需求是使用模拟爱好数组生成用户界面，当用户选择爱好后，存储用户选择的爱好ID。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 模拟数据 爱好数组
const data = [
  { id: 1, title: "足球" },
  { id: 2, title: "篮球" },
  { id: 3, title: "橄榄球" },
];
function App() {
  // 声明表单状态
  const [formState, setFormState] = React.useState({
    hobbies: [],
  });
  // 爱好数组映射, 爱好数组中有多少爱好, 该状态数组中就有多少布尔值与之对应, 表示对应的爱好当前的选中状态是什么
  const [checkedState, setCheckedState] = React.useState(
    new Array(data.length).fill(false)
  );
  // 用于选择爱好后执行的事件处理函数
  const hobbyChangeHandler = (index) =&gt; {
    // index 为用户更改的爱好在原数组中的索引
    // 根据 index 找到爱好对应的布尔值, 取反, 返回新的爱好数组对应的是否选中的状态布尔值数组
    const updatedCheckedState = checkedState.map((checked, i) =&gt;  i === index ? !checked : checked);
    // 更新爱好状态布尔值数组, 供下次用户选择时使用
    setCheckedState(updatedCheckedState);
    // 根据爱好布尔值状态数组, 从原数组中找到用户选中的爱好 id
    const udpatedHobbies = updatedCheckedState.reduce(
      (result, checked, index) =&gt; {
        if (checked) result.push(data[index].id);
        return result;
      },
      []
    );
    // 更新表单状态
    setFormState({ ...formState, hobbies: udpatedHobbies });
  };
  return (
    &lt;&gt;
      {data.map((item, index) =&gt; (
        &lt;p key={item.id}&gt;
          &lt;input
            type="checkbox"
            onChange={() =&gt; hobbyChangeHandler(index)}
            /&gt;
          {item.title}
        &lt;/p&gt;
    	))}
  	&lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="7-submit"><a href="#7-submit" class="headerlink" title="7. submit"></a>7. submit</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [formState, setFormState] = React.useState({
    username: "",
  });
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  const onSubmitHandler = (event) =&gt; {
    event.preventDefault();
    console.log(formState);
  };
  return (
    &lt;form onSubmit={onSubmitHandler}&gt;
      &lt;input
        type="text"
        name="username"
        value={formState.username}
        onChange={onChangeHandler}
        /&gt;
      &lt;input type="submit" /&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="8-reset"><a href="#8-reset" class="headerlink" title="8. reset"></a>8. reset</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">const initialState = {
  username: "",
};
function App() {
  const [formState, setFormState] = React.useState(initialState);
  const onChangeHandler = (event) =&gt; {
    setFormState({
      ...formState,
      [event.target.name]: event.target.value,
    });
  };
  const onResetHandler = (event) =&gt; {
    setFormState(initialState);
  };
  return (
    &lt;form&gt;
      &lt;input
        type="text"
        name="username"
        value={formState.username}
        onChange={onChangeHandler}
        /&gt;
      &lt;button type="button" onClick={onResetHandler}&gt;
        重置
      &lt;/button&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-6-2-非受控表单组件"><a href="#2-6-2-非受控表单组件" class="headerlink" title="2.6.2 非受控表单组件"></a>2.6.2 非受控表单组件</h4><h5 id="1-useRef"><a href="#1-useRef" class="headerlink" title="1. useRef"></a>1. useRef</h5><p>通过 useRef 方法可以实现 DOM 对象的获取。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRef } from 'react';

function App () {
  const username = useRef();
  const handler = () =&gt; console.log(username); // {current: input}
  return &lt;input ref={username} onChange={handler}/&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-forwardRef"><a href="#2-forwardRef" class="headerlink" title="2. forwardRef"></a>2. forwardRef</h5><p>通过 forwardRef 方法可以实现获取子组件中的 DOM 元素 。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import { useEffect, useRef } from "react";
import Message from "./Message";

function App() {
  const messageRef = useRef();
  useEffect(() =&gt; {
    console.log(messageRef.current);
  }, []);
  return &lt;Message ref={messageRef} /&gt;;
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Message.js
import { forwardRef } from "react";

function Message(props, ref) {
  return &lt;span ref={ref}&gt;I am span&lt;/span&gt;;
}

export default forwardRef(Message);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-非受控表单组件"><a href="#3-非受控表单组件" class="headerlink" title="3. 非受控表单组件"></a>3. 非受控表单组件</h5><p>在 React 中受控表单组件使用起来很方便但也相对复杂，如果表单本身比较简单也可以使用非受控表单组件，非受控表单组件就是表单控件不和组件状态进行绑定，就使用原生的表单 DOM 对象存储用户输入的值。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const usernameRef = React.useRef();
  const onSubmitHandler = (event) =&gt; {
    event.preventDefault();
    console.log(usernameRef.current.value);
  };
  return (
    &lt;form onSubmit={onSubmitHandler}&gt;
      &lt;input type="text" ref={usernameRef} /&gt;
      &lt;input type="submit" /&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-7-样式控制"><a href="#2-7-样式控制" class="headerlink" title="2.7 样式控制"></a>2.7 样式控制</h3><h4 id="2-7-1-CSS-stylesheets"><a href="#2-7-1-CSS-stylesheets" class="headerlink" title="2.7.1 CSS stylesheets"></a>2.7.1 CSS stylesheets</h4><p>在 JS 文件中可以通过 import 关键字导入 CSS 样式表，样式表的作用范围为全局。</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* src/styles.css */</span>
<span class="token selector">.button</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #5cb85c<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 6px 12px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 1.42857143<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/index.js</span>
<span class="token keyword">import</span> <span class="token string">"./styles.css"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
function App() {
  return &lt;button className="button"&gt;button&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-7-2-Inline-styling"><a href="#2-7-2-Inline-styling" class="headerlink" title="2.7.2 Inline styling"></a>2.7.2 Inline styling</h4><p>通过 style 属性为元素添加行内样式，在样式参与逻辑时行内样式具有高度优势。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function App() {
  const [state, setState] = useState({
    colors: ["palevioletred", "yellow", "papayawhip"],
    index: 0,
  });
  const styles = {
    width: 200,
    padding: "50px 0",
    background: state.colors[state.index],
    textAlign: "center",
  };
  const onClickHandler = () =&gt; {
    setState({
      ...state,
      index: state.index + 1 &gt; 2 ? 0 : state.index + 1,
    });
  };
  return (
    &lt;div style={styles} onClick={onClickHandler}&gt;
      Hello React
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-7-3-CSS-Modules"><a href="#2-7-3-CSS-Modules" class="headerlink" title="2.7.3 CSS Modules"></a>2.7.3 CSS Modules</h4><p>通过 CSS 模块可以实现组件级样式，样式文件名称约定格式: [name].module.css</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* App.module.css */</span>
<span class="token selector">.button</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #5cb85c<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 6px 12px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">line-height</span><span class="token punctuation">:</span> 1.42857143<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// App.js
import styles from "./App.module.css";

function App() {
  return &lt;button className={styles.button}&gt;button&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-7-4-classnames"><a href="#2-7-4-classnames" class="headerlink" title="2.7.4 classnames"></a>2.7.4 classnames</h4><p>通过 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/classnames">classnames</a> 第三方库可以实现 <code>className</code> 属性值的动态绑定。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 下载 classnames 第三方库
<span class="token function">npm</span> <span class="token function">install</span> classnames<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 注意: classNames 方法的参数个数没有限制
classNames('foo', { bar: true }); // =&gt; 'foo bar'
classNames({ 'bar': true }); // =&gt; 'foo-bar'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import classNames from "classnames";

function App() {
  return &lt;div className={classNames("foo", { bar: true })}&gt;App works&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-8-传送门组件"><a href="#2-8-传送门组件" class="headerlink" title="2.8 传送门组件"></a>2.8 传送门组件</h3><h4 id="2-8-1-已知问题"><a href="#2-8-1-已知问题" class="headerlink" title="2.8.1  已知问题"></a>2.8.1  已知问题</h4><p>需求: 在 App 组件中点击按钮渲染弹框组件。</p>
<p>问题: 弹框组件被渲染到 App  组件内部，弹框组件的样式受到了 App 组件元素的影响，导致布局错乱。</p>
<p><span style="color: skyblue">期望的结果如下 ↓</span></p>
<img src="/medias/assets/images/28.png" width="65%" align="left">

<p><span style="color: skyblue">实际的结果如下 ↓</span></p>
<img src="/medias/assets/images/29.png" width="65%" align="left">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import { useState } from "react";
import Modal from "./Modal";

function App() {
  const [isOpen, setIsOpen] = useState(false);
  const appStyles = { width: "60%", height: 400, transform: "translate(0,0)" };
  return (
    &lt;div style={appStyles}&gt;
      &lt;button onClick={() =&gt; setIsOpen(!isOpen)}&gt;open modal&lt;/button&gt;
      {isOpen ? &lt;Modal /&gt; : null}
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Modal.js
import styles from "./Modal.module.css";

function Modal() {
  return (
    &lt;div className={styles.overlayer}&gt;
      &lt;div className={styles.content}&gt;&lt;/div&gt;
    &lt;/div&gt;
  );
}
export default Modal;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* src/Modal.module.css */</span> 
<span class="token selector">.overlayer</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.content</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
  <span class="token property">left</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">top</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
  <span class="token property">transform</span><span class="token punctuation">:</span> <span class="token function">translate</span><span class="token punctuation">(</span>-50%<span class="token punctuation">,</span> -50%<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-8-2-传送门"><a href="#2-8-2-传送门" class="headerlink" title="2.8.2 传送门"></a>2.8.2 传送门</h4><p>通过 <code>ReactDOM.createPortal</code> 方法可以将指定组件渲染到指定位置。</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token comment">&lt;!-- public/index.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>portal-root<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Modal.js
import styles from "./Modal.module.css";
import ReactDOM from "react-dom";

function Modal() {
  return ReactDOM.createPortal(
    &lt;div className={styles.overlayer}&gt;
      &lt;div className={styles.content}&gt;&lt;/div&gt;
    &lt;/div&gt;,
    document.getElementById("portal-root")
  );
}
export default Modal;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-组件化开发进阶"><a href="#3-组件化开发进阶" class="headerlink" title="3. 组件化开发进阶"></a>3. 组件化开发进阶</h2><h3 id="3-1-useState"><a href="#3-1-useState" class="headerlink" title="3.1 useState"></a>3.1 useState</h3><h4 id="3-1-1-状态异步更新"><a href="#3-1-1-状态异步更新" class="headerlink" title="3.1.1 状态异步更新"></a>3.1.1 状态异步更新</h4><p>设置状态的方法在调用后不会立即更新视图，而是要等到当前执行栈中所有代码执行完成以后再去更新视图，这是为了防止视图被频繁更新导致性能变差。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function App() {
  const [count, setCount] = useState(0);
  const onClickHandler = () =&gt; {
    setCount(count + 1);
    console.log(count); // 此处的输出 count 值总是未更新前的
  };
  return &lt;button onClick={onClickHandler}&gt;{count}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>题外话：如果开发者就想在 count 被更新后执行一些操作，可以通过 useEffect 方法监听状态变化。</p>
<h4 id="3-1-2-状态覆盖"><a href="#3-1-2-状态覆盖" class="headerlink" title="3.1.2 状态覆盖"></a>3.1.2 状态覆盖</h4><p>当多次调用更新状态的方法时，如果参数类型不是函数，React 内部会进行状态的整体覆盖，即只有最后一次设置生效。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = useState(0);
  const onClickHandler = () =&gt; {
    setCount(count + 1);
    setCount(count + 1);
    setCount(count + 1);
    setCount(count + 1);
  };
  return &lt;button onClick={onClickHandler}&gt;{count}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-1-3-状态合并"><a href="#3-1-3-状态合并" class="headerlink" title="3.1.3 状态合并"></a>3.1.3 状态合并</h4><p>当多次调用更新状态的方法时，如果参数是函数类型，React 允许对状态进行合并操作，而不是整体无脑覆盖。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [count, setCount] = useState(0);
  const onClickHandler = () =&gt; {
    setCount((count) =&gt; count + 1);
    setCount((count) =&gt; count + 1);
    setCount((count) =&gt; count + 1);
    setCount((count) =&gt; count + 1);
  };
  return &lt;button onClick={onClickHandler}&gt;{count}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-1-4-初始状态函数"><a href="#3-1-4-初始状态函数" class="headerlink" title="3.1.4 初始状态函数"></a>3.1.4 初始状态函数</h4><p>在使用 useState 方法声明状态时，状态初始值只在组件初始渲染时用到，在以后的每次组件渲染中都不会用到，但是如果初始值中包含昂贵的计算，在每次组件重新渲染时都会被执行，导致组件性能变差。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function App() {
  let inialState = 0;
  for (let i = 0; i &lt; 100000000; i++) {
    inialState += i;
  }
  const [number, setNumber] = useState(inialState);
  return (
    &lt;button onClick={() =&gt; setNumber((prev) =&gt; prev + 1)}&gt;{number}&lt;/button&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码中的问题可以使用初始状态函数解决，可以将初始状态的计算代码放入初始状态函数，因为初始状态函数只会被调用一次。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function App() {
  const [number, setNumber] = useState(() =&gt; {
    let inialState = 0;
    for (let i = 0; i &lt; 100000000; i++) {
      inialState += i;
    }
    return inialState;
  });
  return (
    &lt;button onClick={() =&gt; setNumber((prev) =&gt; prev + 1)}&gt;{number}&lt;/button&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-useReducer"><a href="#3-2-useReducer" class="headerlink" title="3.2 useReducer"></a>3.2 useReducer</h3><h4 id="3-2-1-概述"><a href="#3-2-1-概述" class="headerlink" title="3.2.1 概述"></a>3.2.1 概述</h4><p><code>useReducer</code> 是另一种在组件中声明状态管理状态的方式，它比较适合于处于复杂状态逻辑的场景，它是 useState 的增强方案。</p>
<p>当你在组件中使用 useState 方法来管理列表状态时，你需在状态列表中进行添加、更新、删除操作，此时你会发现管理状态的逻辑占据了组件主体的很大部分，这就是问题。因为 React 组件本身只应该包含用户界面的渲染逻辑，而状态管理不是，所以它应该被放在一个单独的地方进行管理，否则你的组件就会混合状态管理逻辑和渲染逻辑，这样的组件很难阅读和维护。</p>
<p>为了帮助开发者分离组件状态管理逻辑和用户界面渲染逻辑，React 提供了 <code>useReducer</code> 方法帮助开发者进行关注点分离。</p>
<h4 id="3-2-2-工作方式"><a href="#3-2-2-工作方式" class="headerlink" title="3.2.2 工作方式"></a>3.2.2 工作方式</h4><p>要使用 useReducer 方法就必须遵循它的使用规则、了解它的工作流程。</p>
<p>action 对象：用于描述对组件状态进行怎样的操作。 </p>
<p>dispatch 方法：用于触发对状态的操作，接收 action 对象作为参数。</p>
<p>reducer 方法：用于对状态进行集中操作的地方，返回操作之后的最新状态。</p>
<img src="/medias/assets/images/30.png" align="left" width="62%">

<h4 id="3-2-3-计数器"><a href="#3-2-3-计数器" class="headerlink" title="3.2.3 计数器"></a>3.2.3 计数器</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useReducer } from "react";

function reducer(state, action) {
  switch (action.type) {
    case "increment":
      return state + 1;
    case "decrement":
      return state - 1;
    default:
      return state;
  }
}

function Counter() {
  const [count, dispatch] = useReducer(reducer, 0);
  return (
    &lt;&gt;
      &lt;button onClick={() =&gt; dispatch({ type: "increment" })}&gt;{count}&lt;/button&gt;
      &lt;button onClick={() =&gt; dispatch({ type: "decrement" })}&gt;{count}&lt;/button&gt;
    &lt;/&gt;
  );
}

export default Counter;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-3-useLayoutEffect"><a href="#3-3-useLayoutEffect" class="headerlink" title="3.3 useLayoutEffect"></a>3.3 useLayoutEffect</h3><h4 id="3-3-1-概述"><a href="#3-3-1-概述" class="headerlink" title="3.3.1 概述"></a>3.3.1 概述</h4><p><code>useLayoutEffect</code> 和 <code>useEffect</code> 两个方法的作用和使用方式都是一样的，都是用来处理副作用代码的，它们之间唯一的区别就是回调函数的执行时机不同。</p>
<img src="/medias/assets/images/31.png" align="left" width="40%">



<p><code>useEffect</code> 在组件视图更新完成后执行，组件状态发生变化 -&gt; 比较状态差异 -&gt; 视图更新 -&gt; useEffect</p>
<img src="/medias/assets/images/32.png" align="left" width="48%">



<p><code>useLayoutEffect</code> 在组件视图更新前执行，组件状态发生变化 -&gt; 比较状态差异 -&gt; useEffectLayout -&gt; 更新视图</p>
<h4 id="3-3-2-基本使用"><a href="#3-3-2-基本使用" class="headerlink" title="3.3.2 基本使用"></a>3.3.2 基本使用</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useLayoutEffect, useRef, useState } from "react";

function App() {
  const [isShow, setIsShow] = useState(false);
  const divRef = useRef();
  // 此处如果使用 useEffect 就是出现元素闪烁问题
  // 就是元素先出现在原始位置, 再出现在目标位置
  useLayoutEffect(() =&gt; {
    if (!divRef.current) return;
    divRef.current.style.top = "100px";
  }, [isShow]);
  return (
    &lt;&gt;
      &lt;button onClick={() =&gt; setIsShow(!isShow)}&gt;button&lt;/button&gt;
      {isShow ? (
        &lt;div ref={divRef} style={{ position: "absolute" }}&gt;
          div
        &lt;/div&gt;
      ) : null}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为什么在视图更新前可以获取到 <code>divRef.current</code> 并设置样式? 因为 React 内部在比较状态差异的过程中已经在内存中创建/更新了真实DOM对象。</p>
<h3 id="3-4-useRef"><a href="#3-4-useRef" class="headerlink" title="3.4 useRef"></a>3.4 useRef</h3><h4 id="3-4-1-概述及示例"><a href="#3-4-1-概述及示例" class="headerlink" title="3.4.1 概述及示例"></a>3.4.1 概述及示例</h4><p>通过 <code>useRef</code> 方法不仅可以获取 DOM 对象，它还可以用于保存数据。</p>
<p>使用它保存的数据脱离组件渲染，也就是说，即使组件重新渲染值依然存在，而且值的改变不会引发视图更新。</p>
<p>需求：记录组件渲染次数</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useRef, useState } from "react";

function App() {
  const [text, setText] = useState("");
  const renderCount = useRef(0);
  useEffect(() =&gt; {
    renderCount.current += 1;
  });
  return (
    &lt;&gt;
      &lt;input
        type="text"
        value={text}
        onChange={(event) =&gt; setText(event.target.value)}
      /&gt;
      {renderCount.current}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-4-2-疑惑"><a href="#3-4-2-疑惑" class="headerlink" title="3.4.2 疑惑"></a>3.4.2 疑惑</h4><p>能不能不使用 useRef 方法而使用 useState 方法记录组件渲染次数 ?</p>
<p>答案是不能，因为通过 <code>useState</code> 方法声明的是组件状态，组件状态被改变会触发视图更新，一旦视图更新就要通过 count 记录更新次数，count 被改变又会触发视图更新，从而引发组件的无限次循环渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useState } from "react";

function App() {
  const [text, setText] = useState("");
  const [count, setCount] = useState(0);
  useEffect(() =&gt; {
    setCount(count + 1);
  });
  return (
    &lt;&gt;
      &lt;input
        type="text"
        value={text}
        onChange={(event) =&gt; setText(event.target.value)}
      /&gt;
      {count}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-5-memo"><a href="#3-5-memo" class="headerlink" title="3.5 memo"></a>3.5 memo</h3><h4 id="3-5-1-问题代码示例"><a href="#3-5-1-问题代码示例" class="headerlink" title="3.5.1 问题代码示例"></a>3.5.1 问题代码示例</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import { useEffect, useState } from "react";
import ShowName from "./ShowName";

function App() {
  const [index, setIndex] = useState(0);
  useEffect(() =&gt; {
    const timer = setInterval(() =&gt; {
      setIndex((prev) =&gt; prev + 1);
    }, 1000);
    return () =&gt; clearInterval(timer);
  }, []);
  return (
    &lt;&gt;
      &lt;p&gt;{index}&lt;/p&gt;
      &lt;ShowName name="张三" /&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/ShowName.js
import { useEffect } from "react";

function ShowName({ name }) {
  useEffect(() =&gt; {
    console.log("ShowName rendered");
  });
  return &lt;div&gt;{name}&lt;/div&gt;;
}

export default ShowName;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码的问题在于父组件更新引起了子组件的不必要更新，因为子组件本身是没有任何变化的是没有必要更新的。</p>
<h4 id="3-5-2-基本使用"><a href="#3-5-2-基本使用" class="headerlink" title="3.5.2 基本使用"></a>3.5.2 基本使用</h4><p>memo 方法可以为组件添加输入数据 (props) 的比对逻辑，如果当前渲染时的输入数据和上一次渲染时的输入数据一致，阻止组件重新渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { memo } from "react";

export default memo(ShowName);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>memo 方法内部采用的是浅层比较，比较基本数据类型的值是否相同，比较引用类型是否为相同的引用地址。</p>
<p>以下代码在父组件每次重新渲染时都会生成新的 person 对象，memo 方法在内部比较时每次得到的都是不同的对象，所以每次子组件也会跟着重新渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;ShowPerson person={{ name: "张三" }} /&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>memo 方法的第二个参数即为比较函数，可以通过它解决以上问题。比较函数的第一个参数为 prevProps，比较函数的第二个参数为 nextProps, 比较函数返回 true 不进行渲染，比较函数返回 false 组件重新渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default memo(ShowName, compareFunction);

function compareFunction(prevProps, nextProps) {
  if (prevProps.person.name === nextProps.person.name) {
    return true;
  }
  return false;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-6-useMemo"><a href="#3-6-useMemo" class="headerlink" title="3.6 useMemo"></a>3.6 useMemo</h3><h4 id="3-6-1-问题代码示例"><a href="#3-6-1-问题代码示例" class="headerlink" title="3.6.1 问题代码示例"></a>3.6.1 问题代码示例</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function App() {
  const [number, setNumber] = useState(0);
  const [dark, setDark] = useState(false);
  const styles = {
    background: dark ? "black" : "white",
    color: dark ? "white" : "black",
  };
  const double = slowFunction(number);
  return (
    &lt;div&gt;
      &lt;input
        type="number"
        value={number}
        onChange={(event) =&gt; setNumber(event.target.value)}
      /&gt;
      &lt;div style={styles} onClick={() =&gt; setDark(!dark)}&gt;
        {double}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function slowFunction(n) {
  for (let i = 0; i &lt; 1000000000; i++) {}
  return n * 2;
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码的问题之一在于每次组件重新渲染都会调用 <code>slowFunction</code> 方法导致组件渲染性能变差。</p>
<p>但其实只有 <code>number</code> 发生变化后才需要调用 <code>slowFunction</code>，而现在 <code>dark</code> 发生变化也会重新调用它。</p>
<p>以上代码的问题之二是每次组件重新渲染都会生成新的 <code>styles</code> 对象，导致不能在组件中有效监听 <code>styles</code> 对象的变化。</p>
<h4 id="3-6-2-基本使用"><a href="#3-6-2-基本使用" class="headerlink" title="3.6.2 基本使用"></a>3.6.2 基本使用</h4><p>通过 <code>useMemo</code> 方法可以对组件中的值进行缓存，就是说在每次组件重新渲染时都返回相同的值，也可以指定哪些状态发生改变时重新计算该值。</p>
<p><code>useMemo</code> 有助于避免在每个渲染上进行昂贵的计算，提升组件性能。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useMemo, useState } from "react";

function App() {
  const [number, setNumber] = useState(0);
  const [dark, setDark] = useState(false);
  const double = useMemo(() =&gt; {
    return slowFunction(number);
  }, [number]);
  const styles = useMemo(() =&gt; {
    return {
      background: dark ? "black" : "white",
      color: dark ? "white" : "black",
    };
  }, [dark]);
  useEffect(() =&gt; {
    console.log("styles");
  }, [styles]);
  return (
    &lt;div&gt;
      &lt;input
        type="number"
        value={number}
        onChange={(event) =&gt; setNumber(event.target.value)}
      /&gt;
      &lt;div style={styles} onClick={() =&gt; setDark(!dark)}&gt;
        {double}
      &lt;/div&gt;
    &lt;/div&gt;
  );
}

function slowFunction(n) {
  for (let i = 0; i &lt; 1000000000; i++) {}
  return n * 2;
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-7-useCallback"><a href="#3-7-useCallback" class="headerlink" title="3.7 useCallback"></a>3.7 useCallback</h3><h4 id="3-7-1-问题代码示例"><a href="#3-7-1-问题代码示例" class="headerlink" title="3.7.1 问题代码示例"></a>3.7.1 问题代码示例</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useState } from "react";

function App() {
  const [number, setNumber] = useState(1);
  const [dark, setDark] = useState(false);
  const styles = {
    background: dark ? "black" : "white",
    color: dark ? "white" : "black",
  };
  const getItems = () =&gt; {
    return [number, number + 1, number + 2];
  };
  return (
    &lt;div style={styles}&gt;
      &lt;input
        type="number"
        value={number}
        onChange={() =&gt; setNumber((prev) =&gt; prev + 1)}
      /&gt;
      &lt;button onClick={() =&gt; setDark((dark) =&gt; !dark)}&gt;button&lt;/button&gt;
      &lt;List getItems={getItems} /&gt;
    &lt;/div&gt;
  );
}

function List({ getItems }) {
  const [items, setItems] = useState([]);
  
  useEffect(() =&gt; {
    setItems(getItems());
    console.log("update items");
  }, [getItems]);

  return (
    &lt;div&gt;
      {items.map((item) =&gt; (
        &lt;p key={item}&gt;{item}&lt;/p&gt;
      ))}
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码的问题在于每次组件重新渲染都会生成一个新的 getItems 方法，所以每次 List 组件接收的都是不一样的 getItems 方法，导致组件在不该被渲染的时候被渲染了。实际上只有 number 发生变化后 List 组件才需要被重新渲染，dark 发生变化 List 组件没必要重新渲染。</p>
<h4 id="3-7-2-基本使用"><a href="#3-7-2-基本使用" class="headerlink" title="3.7.2  基本使用"></a>3.7.2  基本使用</h4><p>通过 <code>useCallback</code> 方法可以缓存函数，使用组件每次重新渲染都返回相同的函数实例，也可以指定当某个状态发生变化后返回新的函数实例。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useCallback } from "react";

function App () {
  const getItems = useCallback(() =&gt; {
    return [number, number + 1, number + 2];
  }, [number]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-8-useImperativeHandle"><a href="#3-8-useImperativeHandle" class="headerlink" title="3.8 useImperativeHandle"></a>3.8 useImperativeHandle</h3><h4 id="3-8-1-概述"><a href="#3-8-1-概述" class="headerlink" title="3.8.1 概述"></a>3.8.1 概述</h4><p>虽然 React 遵循单项数据流原则，但凡事总有特殊情况，React 也提供了子组件向父组件传递数据方法。</p>
<p>通过 useImperativeHandle 方法可以实现父组件获取子组件的数据或者调用子组件的里声明的函数。</p>
<p>父组件通过 useRef 方法创建了一个钩子，用于钩取子组件的数据，子组件在获取到钩子以后，通过 useImperativeHandle 向钩子上暴露数据。</p>
<h4 id="3-8-2-代码示例"><a href="#3-8-2-代码示例" class="headerlink" title="3.8.2 代码示例"></a>3.8.2 代码示例</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import { useRef } from "react";
import Message from "./Message";

function App() {
  const messageRef = useRef();
  const onClickHandler = () =&gt; {
    console.log(messageRef.current.getText());
    console.log(messageRef.current.input);
  };
  return (
    &lt;&gt;
      &lt;Message ref={messageRef} /&gt;
      &lt;button onClick={onClickHandler}&gt;button&lt;/button&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Message.js
import { forwardRef, useImperativeHandle, useRef, useState } from "react";

function Message(props, ref) {
  const [text, setText] = useState("");
  const inputRef = useRef();
  useImperativeHandle(ref, () =&gt; {
    return {
      getText() {
        return text;
      },
      input: inputRef.current,
    };
  });
  return (
    &lt;input
      ref={inputRef}
      type="text"
      value={text}
      onChange={(event) =&gt; setText(event.target.value)}
    /&gt;
  );
}

export default forwardRef(Message);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-9-Custom-Hooks"><a href="#3-9-Custom-Hooks" class="headerlink" title="3.9 Custom Hooks"></a>3.9 Custom Hooks</h3><h4 id="3-9-1-概述"><a href="#3-9-1-概述" class="headerlink" title="3.9.1 概述"></a>3.9.1 概述</h4><p>React 允许开发者创建自定义钩子函数用于向组件中添加功能。</p>
<p>自定义钩子函数其实就是应用逻辑和内置钩子函数的组合。</p>
<h4 id="3-9-2-useLocalStorage"><a href="#3-9-2-useLocalStorage" class="headerlink" title="3.9.2 useLocalStorage"></a>3.9.2 useLocalStorage</h4><p>用于将组件状态实时同步到本地存储 localStorage。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

export function useLocalStorage(key, initialValue) {
  // 声明状态
  const [storedValue, setStoredValue] = useState(function () {
    // 看看本地是否存在已有状态值
    const item = window.localStorage.getItem(key);
    // 如果本地已经有了就用本地的, 否则使用 initialValue
    return item ? JSON.parse(item) : initialValue;
  });
  // 对设置状态的方法进行增强, 添加状态同步到本地存储的功能
  const setState = (value) =&gt; {
    // 获取新的状态值
    // 如果 value 是函数类型, 调用函数传递现有状态, 从返回值中获取新的状态
    // 如果 value 是其他类型, 直接作为状态值使用
    const valueToStore = value instanceof Function ? value(storedValue) : value;
    // 设置状态
    setStoredValue(valueToStore);
    // 将状态值同步到 localStorage
    localStorage.setItem(key, JSON.stringify(valueToStore));
  };
  // 返回状态及设置状态的方法
  return [storedValue, setState];
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [name, setName] = useLocalStorage("name", "Bob");
  
  return (
    &lt;div&gt;
      &lt;input
        type="text"
        placeholder="Enter your name"
        value={name}
        onChange={(e) =&gt; setName(e.target.value)}
      /&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-9-3-useToggle"><a href="#3-9-3-useToggle" class="headerlink" title="3.9.3 useToggle"></a>3.9.3 useToggle</h4><p>用于实现布尔值状态的切换。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useCallback, useState } from "react";

export default function useToggle(initialValue = false) {
  const [state, setState] = useState(initialValue);
  const toggle = useCallback(() =&gt; {
    setState((state) =&gt; !state);
  }, []);
  return [state, toggle];
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const [isTextChanged, setIsTextChanged] = useToggle();
  return (
    &lt;button onClick={setIsTextChanged}&gt;
      {isTextChanged ? "Toggled" : "Click to Toggle"}
    &lt;/button&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-9-4-useAsync"><a href="#3-9-4-useAsync" class="headerlink" title="3.9.4 useAsync"></a>3.9.4 useAsync</h4><p>用于执行异步代码并为异步过程添加状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useCallback, useEffect, useState } from "react";

export default function useAsync(asyncFunction, immediate = false) {
  // idle: 空闲 pending: 等待 success: 成功 error: 失败
  const [status, setStatus] = useState("idle");
  const [value, setValue] = useState(null);
  const [error, setError] = useState(null);

  const execute = useCallback(() =&gt; {
    setStatus("pending");
    setValue(null);
    setError(null);

    return asyncFunction()
      .then((response) =&gt; {
        setValue(response);
        setStatus("success");
      })
      .catch((error) =&gt; {
        setError(error);
        setStatus("error");
      });
  }, [asyncFunction]);

  useEffect(() =&gt; {
    if (immediate) {
      execute();
    }
  }, [execute, immediate]);

  return { execute, status, value, error };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import useAsync from "./useAsync";

const myFunction = () =&gt; {
  return new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; {
      const rnd = Math.random() * 10;
      rnd &lt;= 5 ? resolve("成功 🙌") : reject("失败 😞");
    }, 2000);
  });
};

function App() {
  const { status, value, error, execute } = useAsync(myFunction);
  return (
    &lt;div&gt;
      {status === "idle" &amp;&amp; &lt;div&gt;Start your journey by clicking a button&lt;/div&gt;}
      {status === "success" &amp;&amp; &lt;div&gt;{value}&lt;/div&gt;}
      {status === "error" &amp;&amp; &lt;div&gt;{error}&lt;/div&gt;}
      &lt;button onClick={execute} disabled={status === "pending"}&gt;
        {status !== "pending" ? "Click me" : "Loading..."}
      &lt;/button&gt;
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-9-5-useHover"><a href="#3-9-5-useHover" class="headerlink" title="3.9.5 useHover"></a>3.9.5 useHover</h4><p>用于检测元素的鼠标移入移出操作。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useRef, useState } from "react";

export default function useHover() {
  const [value, setValue] = useState(false);
  const elementRef = useRef();

  useEffect(() =&gt; {
    const node = elementRef.current;
    if (!node) return;
    const handleMouseEnter = () =&gt; setValue(true);
  	const handleMouseLeave = () =&gt; setValue(false);
    node.addEventListener("mouseenter", handleMouseEnter);
    node.addEventListener("mouseleave", handleMouseLeave);
    return () =&gt; {
      node.removeEventListener("mouseenter", handleMouseEnter);
      node.removeEventListener("mouseleave", handleMouseLeave);
    };
  }, []);

  return [elementRef, value];
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import useHover from "./useHover";

function App() {
  const [hoverRef, isHovered] = useHover();
  return &lt;div ref={hoverRef}&gt;{isHovered ? "😁" : "☹️"}&lt;/div&gt;;
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-9-6-useWindowSize"><a href="#3-9-6-useWindowSize" class="headerlink" title="3.9.6 useWindowSize"></a>3.9.6 useWindowSize</h4><p>用于获取浏览器的窗口大小。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useState } from "react";

export default function useWindowSize() {
  const [windowSize, setWindowSize] = useState({
    width: undefined,
    height: undefined,
  });
  useEffect(() =&gt; {
    const handleResize = () =&gt; {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    };
    window.addEventListener("resize", handleResize);
    handleResize();
    return () =&gt; window.removeEventListener("resize", handleResize);
  }, []);
  return windowSize;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import useWindowSize from "./useWindowSize";

function App() {
  const size = useWindowSize();
  return (
    &lt;div&gt;
      {size.width}px / {size.height}px
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-9-7-useReducerAsync"><a href="#3-9-7-useReducerAsync" class="headerlink" title="3.9.7 useReducerAsync"></a>3.9.7 useReducerAsync</h4><p>通过 useReducerAsync 自定义钩子函数可以实现在 useReducer 的工作流程中加入副作用代码。</p>
<p>首先看一段没有该钩子函数的代码，需求是在点击按钮时获取id值为1的任务对象。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { useReducer } from "react";

const initialState = [];

function reducer(state, action) {
  switch (action.type) {
    case "setTodo":
      return [...state, action.payload];
    default:
      return state;
  }
}

function App() {
  const [state, dispatch] = useReducer(reducer, initialState);
  const onClickHandler = async (id) =&gt; {
    let response = await axios.get(
      `https://jsonplaceholder.typicode.com/todos/${id}`
    );
    dispatch({ type: "setTodo", payload: response.data });
  };
  return (
    &lt;div&gt;
      &lt;button onClick={() =&gt; onClickHandler(1)}&gt;button&lt;/button&gt;
      &lt;div&gt;{JSON.stringify(state, null, 2)}&lt;/div&gt;
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码的问题在于，任务状态的处理有一部分在组件内部一部分在组件外部，代码过于分散。</p>
<p>通过 <a target="_blank" rel="noopener" href="https://github.com/dai-shi/use-reducer-async">useReducerAsync</a> 自定义钩子函数可以将处理状态过程中的副作用代码抽离到组件外部。</p>
<p><code>npm install use-reducer-async</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useReducerAsync } from "use-reducer-async";
import axios from "axios";

const initialState = [];

function reducer(state, action) {
  switch (action.type) {
    case "setTodo":
      return [...state, action.payload];
    default:
      return state;
  }
}

const asyncHandlers = {
  loadTodo:
    ({ dispatch }) =&gt;
    async (action) =&gt; {
      let response = await axios.get(
        `https://jsonplaceholder.typicode.com/todos/${action.payload}`
      );
      dispatch({ type: "setTodo", payload: response.data });
    },
};

function App() {
  const [state, dispatch] = useReducerAsync(reducer, initialState, asyncHandlers);
  return (
    &lt;div&gt;
      &lt;button onClick={() =&gt; dispatch({ type: "loadTodo", payload: 1 })}&gt;button&lt;/button&gt;
      &lt;div&gt;{JSON.stringify(state, null, 2)}&lt;/div&gt;
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-10-Children"><a href="#3-10-Children" class="headerlink" title="3.10 Children"></a>3.10 Children</h3><h4 id="3-10-1-only"><a href="#3-10-1-only" class="headerlink" title="3.10.1 only"></a>3.10.1 only</h4><p>通过 <code>Children.only</code> 方法可以限制组件标签只接收一个子元素。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Message from "./Message";

function App() {
  // 不允许 Message 组件标签传入多个子元素, 需要对这种情况进行限制
  return (
    &lt;Message&gt;
      &lt;p&gt;Hello&lt;/p&gt;
      &lt;p&gt;Hello&lt;/p&gt;
    &lt;/Message&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Children } from "react";

function Message(props) {
  try {
    Children.only(props.children);
  } catch (error) {
    // Error: React.Children.only expected to receive a single React element child.
    // 错误: React.children 只期望接收一个 React 元素
    return &lt;div&gt;Message 组件标签只接收一个子元素 &lt;/div&gt;;
  }
  return &lt;div&gt;{props.children}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-10-2-count"><a href="#3-10-2-count" class="headerlink" title="3.10.2 count"></a>3.10.2 count</h4><p>通过 <code>Children.count</code> 方法可以获取组件标签传入的子元素的数量。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Children } from "react";

function Message(props) {
  return &lt;div&gt;{Children.count(props.children)}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-10-3-map"><a href="#3-10-3-map" class="headerlink" title="3.10.3 map"></a>3.10.3 map</h4><p>通过 <code>Children.map</code> 方法可以对组件标签内部的子元素进行转换操作。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  return (
    &lt;Message&gt;
      &lt;img
        src="https://images.pexels.com/photos/10198426/pexels-photo-10198426.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/4386364/pexels-photo-4386364.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/9812128/pexels-photo-9812128.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/8746965/pexels-photo-8746965.jpeg"
        width="300px"
        alt=""
      /&gt;
    &lt;/Message&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Children } from "react";

function Message(props) {
  const items = Children.map(props.children, (item) =&gt; (
    &lt;a href="http://www.baidu.com"&gt;{item}&lt;/a&gt;
  ));
  return &lt;div&gt;{items}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-10-4-toArray"><a href="#3-10-4-toArray" class="headerlink" title="3.10.4 toArray"></a>3.10.4 toArray</h4><p><code>props.children</code> 存储多个值时是数组类型，存储一个值时为对象类型。</p>
<p>通过 <code>Children.toArray</code> 方法可以将 <code>props.children</code> 转换为数组类型，以保证 <code>Children.map</code> 方法永远有用。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import ImageToggle from "./ImageToggle";

function App() {
  return (
    &lt;ImageToggle&gt;
      &lt;img
        src="https://images.pexels.com/photos/10198426/pexels-photo-10198426.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/4386364/pexels-photo-4386364.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/9812128/pexels-photo-9812128.jpeg"
        alt=""
        width="300px"
      /&gt;
      &lt;img
        src="https://images.pexels.com/photos/8746965/pexels-photo-8746965.jpeg"
        width="300px"
        alt=""
      /&gt;
    &lt;/ImageToggle&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/ImageToggle.js
import { useEffect, useState, Children } from "react";

function ImageToggle(props) {
  const [state, setState] = useState({
    // 当前要显示的图片的索引
    current: 0,
    // 总共有多少张图片, 用于索引的溢出判断
    total: 0,
  });
  useEffect(() =&gt; {
    setState((prev) =&gt; ({ ...prev, total: Children.count(props.children) }));
  }, [props.children]);

  useEffect(() =&gt; {
    const timer = setInterval(showNext, 2000);
    return () =&gt; clearInterval(timer);
  }, []);

  const showNext = () =&gt; {
    setState(({ current, total }) =&gt; {
      return {
        total,
        current: current + 1 === total ? 0 : current + 1,
      };
    });
  };
  return &lt;div&gt;{Children.toArray(props.children)[state.current]}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-11-Context"><a href="#3-11-Context" class="headerlink" title="3.11 Context"></a>3.11 Context</h3><h4 id="3-11-1-已知问题"><a href="#3-11-1-已知问题" class="headerlink" title="3.11.1 已知问题"></a>3.11.1 已知问题</h4><p>在 React 中虽然使用 Context 可以方便的实现组件之间的状态共享，但是如果使用不当就会产生严重的性能问题。 </p>
<p>当多个组件使用了 Context 中的不同的状态时，只要 Context 中的某一个状态发生改变，使用了其他状态的其他组件也会重新渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Context.js
import { createContext, useState } from "react";

export const AppContenxt = createContext();

export function AppProvider({ children }) {
  const [state, setState] = useState({
    foo: "foo context",
    bar: "bar context",
  });
  return (
    &lt;AppContenxt.Provider value={[state, setState]}&gt;
      {children}
    &lt;/AppContenxt.Provider&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import Bar from "./Bar";
import Foo from "./Foo";
import { AppProvider } from "./Context";

function App() {
  return (
    &lt;AppProvider&gt;
      &lt;Foo /&gt;
      &lt;Bar /&gt;
    &lt;/AppProvider&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Foo.js
import { useContext, useEffect } from "react";
import { AppContenxt } from "./Context";

function Foo() {
  const [appContext, setAppContext] = useContext(AppContenxt);
  useEffect(() =&gt; {
    console.log("Foo render");
  });
  const onClickHandler = () =&gt; {
    setAppContext((state) =&gt; ({ ...state, foo: "foo contenxt changed" }));
  };
  return (
    &lt;div&gt;
      {appContext.foo} &lt;button onClick={onClickHandler}&gt;foo button&lt;/button&gt;
    &lt;/div&gt;
  );
}

export default Foo;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Bar.js
import { useContext, useEffect } from "react";
import { AppContenxt } from "./Context";

function Bar() {
  const [appContext] = useContext(AppContenxt);
  useEffect(() =&gt; {
    console.log("Bar render");
  });
  return &lt;div&gt;{appContext.bar}&lt;/div&gt;;
}

export default Bar;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-11-2-解决方案"><a href="#3-11-2-解决方案" class="headerlink" title="3.11.2 解决方案"></a>3.11.2 解决方案</h4><h5 id="1-拆分-Context"><a href="#1-拆分-Context" class="headerlink" title="1. 拆分 Context"></a>1. 拆分 Context</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/FooContext.js
import { createContext, useState } from "react";

export const FooContext = createContext();

export function FooProvider({ children }) {
  const [foo, setFoo] = useState("foo context");
  return (
    &lt;FooContext.Provider value={[foo, setFoo]}&gt;{children}&lt;/FooContext.Provider&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/BarContext.js
import { createContext, useState } from "react";

export const BarContext = createContext();

export function BarProvider({ children }) {
  const [bar, setBar] = useState("bar context");
  return (
    &lt;BarContext.Provider value={[bar, setBar]}&gt;{children}&lt;/BarContext.Provider&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import Bar from "./Bar";
import Foo from "./Foo";
import { BarProvider } from "./BarContext";
import { FooProvider } from "./FooContext";

function App() {
  return (
    &lt;&gt;
      &lt;FooProvider&gt;
        &lt;Foo /&gt;
      &lt;/FooProvider&gt;
      &lt;BarProvider&gt;
        &lt;Bar /&gt;
      &lt;/BarProvider&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Foo.js
import { useContext, useEffect } from "react";
import { FooContext } from "./FooContext";

function Foo() {
  const [foo, setFoo] = useContext(FooContext);
  useEffect(() =&gt; {
    console.log("Foo render");
  });
  return (
    &lt;div&gt;
      {foo}
      &lt;button onClick={() =&gt; setFoo("foo contenxt changed")}&gt;foo button&lt;/button&gt;
    &lt;/div&gt;
  );
}

export default Foo;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Bar.js
import { useContext, useEffect } from "react";
import { BarContext } from "./BarContext";

function Bar() {
  const [bar] = useContext(BarContext);
  useEffect(() =&gt; {
    console.log("Bar render");
  });
  return &lt;div&gt;{bar}&lt;/div&gt;;
}

export default Bar;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-拆分组件"><a href="#2-拆分组件" class="headerlink" title="2. 拆分组件"></a>2. 拆分组件</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Bar.js
import { memo, useContext, useEffect } from "react";
import { AppContenxt } from "./Context";

const BarContext = memo((props) =&gt; {
  useEffect(() =&gt; {
    console.log("BarContext render");
  });
  return &lt;div&gt;{props.bar}&lt;/div&gt;;
});

function Bar() {
  const [appContext] = useContext(AppContenxt);
  return &lt;BarContext bar={appContext.bar} /&gt;;
}

export default Bar;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-缓存状态"><a href="#3-缓存状态" class="headerlink" title="3. 缓存状态"></a>3. 缓存状态</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useContext, useMemo } from "react";
import { AppContenxt } from "./Context";

function Bar() {
  const [appContext] = useContext(AppContenxt);
  const bar = appContext.bar;
  return useMemo(() =&gt; {
    console.log("bar render");
    return &lt;div&gt;{bar}&lt;/div&gt;;
  }, [bar]);
}

export default Bar;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-全局状态管理"><a href="#4-全局状态管理" class="headerlink" title="4. 全局状态管理"></a>4. 全局状态管理</h2><p>全局状态管理是组件状态管理的另一种思路，传统的组件状态由组件管理，组件状态在组件之间通过 props 传递，传递和更改状态使组件代码变得复杂。</p>
<p>全局状态管理是指组件状态被状态仓库集中管理，组件从仓库中获取状态，组件通过特定方式更改仓库中的状态。</p>
<p>全局状态管理使组件状态共享变得简单。</p>
<img src="/medias/assets/images/34.jpeg" align="left" width="60%">

<h3 id="4-1-Redux"><a href="#4-1-Redux" class="headerlink" title="4.1 Redux"></a>4.1 Redux</h3><h4 id="4-1-1-概述"><a href="#4-1-1-概述" class="headerlink" title="4.1.1 概述"></a>4.1.1 概述</h4><p><a target="_blank" rel="noopener" href="https://redux.js.org/">Redux</a> 是最为流行的用于实现全局状态管理的第三方库，它的核心功能是提供了状态管理规则以及相应的状态管理API。</p>
<p><a target="_blank" rel="noopener" href="https://react-redux.js.org/">React Redux</a> 是和 Redux 配合使用的，它提供了组件获取状态的方式并在状态更新后更新组件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> redux@4.1.2 react-redux@7.2.6<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/medias/assets/images/35.png" align="left" width="80%">

<h4 id="4-1-2-光速入门"><a href="#4-1-2-光速入门" class="headerlink" title="4.1.2 光速入门"></a>4.1.2 光速入门</h4><ol>
<li><p>创建用于存储状态的 Store 对象</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 从 redux 中导入 createStore 方法
// createStore 方法用于创建存储状态的 Store 对象
import { createStore } from "redux";
// createStore 方法的第一个参数是一个函数, 函数函数返回什么, Store 中就存储什么, 我们通常将这个函数命名为 reducer
// createStore 方法的第二个参数是状态的初始值
// createStore 方法的返回值就是用于存储状态的 Store 对象
const store = createStore(reducer, {count: 0});
// 测试代码 -&gt; 获取 store 中存储的状态
console.log(store.getState())<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建用于返回状态的 reducer 函数</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// reducer 函数的第一个参数是状态
// 状态的初始值就是通过 createStore 方法的第二个参数指定的
// 目前状态的值是一个对象 对象中存储了 count 属性, 值为 0
function reducer(state) {
  // 返回状态, reducer 函数返回什么, Store 对象中就存储什么
  return state;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>搭建”天梯”，通过”天梯”打通组件从 Store 对象中获取状态的通道</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 从 react-redux 中导入 Provider 组件
// Provider 组件就是"天梯", 有了它组件就可以从 Store 对象中获取状态了
import { Provider } from "react-redux";

// 将天梯组件作为应用的根组件, 这样做以后应用中的任何组件就都可以从 Store 中获取状态了
// 将 store 对象挂载到"天梯"中
ReactDOM.render(
  &lt;Provider store={store}&gt;
    &lt;App /&gt;
  &lt;/Provider&gt;,
  document.getElementById("root")
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>组件从 Store 中获取状态并渲染状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 从 react-redux 中导入 useSelector 钩子函数
// 它是用于从 Store 中获取状态的
import { useSelector } from "react-redux";

function App() {
  // 在组件中调用 useSelector 方法从 Store 对象中获取状态
  // 我们在调用 useSelector 方法时需要传递一个回调函数
  // useSelector 方法内部在调用这个函数时通过参数的方式将状态传递给我们, 即当前代码中的 state 参数
  // 我们在拿到 state 参数以后, 可以将它作为回调函数的返回值, 或者再从参数内部找到你想要的状态, 再作为返回值进行返回
  // useSelector 方法的返回值就是回调函数的返回值, 就是我们想要获取的状态值
  const count = useSelector((state) =&gt; state.count);
  return &lt;div&gt;{count}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在组件中通过 dispatch 方法发送更改状态的指令 ( action )</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 从 react-redux 导入 useDispatch 钩子函数
// 该钩子函数用于在组件中获取 dispatch 方法
import { useDispatch } from "react-redux";

function App() {
  // 在组件中通过调用 useDispatch 钩子函数获取 dispatch 方法
  // dispatch 方法用于发送更改状态的指令
  const dispatch = useDispatch();
  // 在点击 div 时调用 dispatch 方法发送用于更改状态的指令
  // 指令就是 action 对象, 通过 action 中的 type 属性描述要对状态进行怎样的操作
  // type 属性的值由开发者自定义
  return &lt;div onClick={() =&gt; dispatch({ type: "increment" })}&gt;{count}&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 reducer 中接收更改状态的指令并根据指令对状态进行更改</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// reducer 函数的第二个参数是 action 对象
// 其实就是在调用 dispatch 方法时传递的参数对象 (用于描述如果更改状态的指令)
function reducer(state, action) {
  // 在 reducer 函数中对 action 对象中的 type 值进行匹配
  // 不同的 type 值表示要对状态进行不同的操作
  switch (action.type) {
    // 如果 type 属性值时 "increment", 表示要对当前状态值进行 +1 操作
    case "increment":
      // 对状态进行操作并将操作结果作为 reducer 函数的返回值
      // 返回新的状态, 表示更新 Store 对象中存储的状态值
      // Store 中的状态被更新了会触发使用了该状态的组件的自动更新
      // 注意: 不能对原有状态进行直接修改, 比如 return state.count + 1, 这样的代码不合规, 必须返回新状态对象
      return {count: state.count + 1};
    default:
      // 如果所有的 action.type 都没有匹配上就默认返回当前状态值
      // 切记 reducer 函数一定要有返回值
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在发送更改状态的指令时传递参数，比如让状态加任意值，我传什么值它就加什么值</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  // 在 action 对象中除了可以有 type 属性以外, 还可以有其他的自定义属性及值
  // 当前我们就添加一个自定义的 payload 属性作为参数, 值为 5
  // 也就是说当点击 div 时, 让状态在当前值的基础上 +5
  return (
    &lt;div onClick={() =&gt; dispatch({ type: "increment", payload: 5 })}&gt;
      {count}
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function reducer(state, action) {
  switch (action.type) {
    case "increment":
      // 从 action 对象中获取 payload 参数,
      // 将当前状态值和参数进行相加并返回结果
      return {count: state.count + action.payload};
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="4-1-3-action-creator"><a href="#4-1-3-action-creator" class="headerlink" title="4.1.3 action creator"></a>4.1.3 action creator</h4><p>需求：在组件中添加两个按钮，点击第一个按钮时让数值 +5，点击第二个按钮时让数值 +10。</p>
<p>你的代码可能会很自然的写成下面这样：</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const count = useSelector((state) =&gt; state.count);
  const dispatch = useDispatch();
  return (
    &lt;div&gt;
      {count}
      &lt;button onClick={() =&gt; dispatch({ type: "increment", payload: 5 })}&gt;
        +5
      &lt;/button&gt;
      &lt;button onClick={() =&gt; dispatch({ type: "increment", payload: 10 })}&gt;
        +10
      &lt;/button&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在以上代码中存在一个问题，就是多次调用了 dispatch 方法，每次调用它的都传递了 action 对象，而这个参数对象属于冗余代码，可以被简化。</p>
<p>按照思路我们可以将以上代码改成下面这样，为了简化代码，我们将 action 对象提取了出来。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const increment = { type: "increment", payload: 5 };

function App() {
  const count = useSelector((state) =&gt; state.count);
  const dispatch = useDispatch();
  return (
    &lt;div&gt;
      {count}
      &lt;button onClick={() =&gt; dispatch(increment)}&gt;+5&lt;/button&gt;
      &lt;button onClick={() =&gt; dispatch(increment)}&gt;+10&lt;/button&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是改成这样以后，payload 属性的值就无法动态化了，所以为了传递参数，我们对代码做出了更改。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useDispatch, useSelector } from "react-redux";

// action creator 函数: 返回 action 对象的函数
const increment = (payload) =&gt; ({ type: "increment", payload });

function App() {
  const count = useSelector((state) =&gt; state.count);
  const dispatch = useDispatch();
  return (
    &lt;div&gt;
      {count}
      &lt;button onClick={() =&gt; dispatch(increment(5))}&gt;+5&lt;/button&gt;
      &lt;button onClick={() =&gt; dispatch(increment(10))}&gt;+10&lt;/button&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 Redux 中，返回 action 对象的函数被叫做 action creator 函数。</p>
<h4 id="4-1-4-combineReducers"><a href="#4-1-4-combineReducers" class="headerlink" title="4.1.4 combineReducers"></a>4.1.4 combineReducers</h4><p>目前在 store 中只存储了一个状态，当 store 中存储多个状态的时候会存在什么问题呢?</p>
<p>需求：新建 Message 组件，该组件负责发送消息，发送的消息需要被存储在 store 中。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/Message.js
import { useRef } from "react";
import { useDispatch, useSelector } from "react-redux";

const saveMessage = (payload) =&gt; ({ type: "save_message", payload });

function Message() {
  // 和 input 进行绑定, 用于获取用户在文本框中输入的内容
  const inputRef = useRef();
  // 获取用于发送指令的 dispatch 方法
  const dispatch = useDispatch();
  // 从 store 中获取状态
  const message = useSelector((state) =&gt; state.message);
  // 用户发送 message 的方法
  const onMessageSendHandler = () =&gt; dispatch(saveMessage(inputRef.current.value));
  return (
    &lt;&gt;
      &lt;input ref={inputRef} /&gt;
      &lt;button onClick={onMessageSendHandler}&gt;send&lt;/button&gt;
      {message}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/index.js
// 在状态初始值中加入 message
export const store = createStore(reducer, { count: 0, message: "" });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/index.js
function reducer(state, action) {
  switch (action.type) {
    case "increment":
      // 在修改状态时, 要先获取到原有状态, 在原有状态的基础上创建新状态, 返回新状态
      return { ...state, count: state.count + action.payload };
    // 在 reducer 函数中加入处理 message 状态的代码
    case "save_message":
      return { ...state, message: action.payload };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上代码存在两个问题，第一个是当状态变得庞大时 reducer 函数一定会变得庞大，第二个是 reducer 函数在处理多个不相关的状态。</p>
<p>为解决上述问题，为提高代码的可维护性，Redux 允许开发者对状态进行分类，通过编写多个 reducer 函数对不同的状态进行处理。</p>
<p>虽然 Redux 允许存在多个 reducer 函数，但最终 createStore 方法只接收一个，就是说 reducer 函数们最终要被合并，createStore 方法只接收合并结果。</p>
<p>第一步：对 reducer 函数进行拆分，将一个 reducer 函数拆分为多个 reducer 函数</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// counter 状态的初始值
// 一个大的 reducer 函数被拆分成了多个小的 reducer 函数，每个 reducer 函数负责处理不同的状态
// 每个 reducer 函数处理的状态又都会有初始值，由于原来的一个状态的初始值变成了现在的多个状态的初始
// 所以这个初始值就不能通过 createStore 方法的第二个参数传递了
// 所以现在状态的默认值改成了通过函数参数默认值的方式进行传递
const counterInitialState = { count: 0 };

// counterReducer 函数用于处理并返回和 counter 相关的状态
function counterReducer(state = counterInitialState, action) {
  switch (action.type) {
    case "increment":
      return { count: state.count + action.payload };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">const messageInitialState = { value: "" };

// messageReducer 函数用于处理并返回和 message 相关的状态
function messageReducer(state = messageInitialState, action) {
  switch (action.type) {
    case "save_message":
      return { value: action.payload };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二步：合并 reducer 函数，因为 createStore 方法要接收最终被合并之后的 reducer 函数。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// combineReducers 方法的参数是一个对象, 这个对象就是 Store 对象中存储的状态对象
// 对象中的属性就是状态属性，属性值就是用于返回状态的 reducer 函数
// 所以现在用于存储状态的 store 对象长成这样: {counter: {count: 0}, message: {value: ""}}
// combineReducers 方法的返回值就是合并好的 reducer 函数, 我们可以将它传递给 createStore 方法
// reducer 函数状态拆分是为了方便代码维护，reducer 函数合并是为了将 reducer 函数作为参数传递给 createStore 方法

// {count: 0, message: ''}
// {counter: {count: 0}, message: {value: ''}}
const reducers = combineReducers({
  counter: counterReducer,
  message: messageReducer,
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 将合并之后的 rootReducer 函数作为 createStore 方法的参数
// 同时去除原本的第二个参数, 状态初始值
export const store = createStore(reducers);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在组件中重新获取状态，因为 store 对象中存储的数据层级发生了变化。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  const count = useSelector((state) =&gt; state.counter.count);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Message() {
  const message = useSelector((state) =&gt; state.message.value);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-5-代码重构"><a href="#4-1-5-代码重构" class="headerlink" title="4.1.5 代码重构"></a>4.1.5 代码重构</h4><ol>
<li><p>在 src 目录下创建 state 文件夹，用于存放和全局状态相关的代码。</p>
</li>
<li><p>在 state 目录下创建 reducers 文件夹用于存放 reducer 函数</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/counter.js
const initialState = { count: 0 };

export default function counterReducer(state = initialState, action) {
  switch (action.type) {
    case "increment":
      return { count: state.count + action.payload };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/message.js
const initialState = { value: "" };

export default function messageReducer(state = initialState, action) {
  switch (action.type) {
    case "save_message":
      return { value: action.payload };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/index.js
import { combineReducers } from "redux";
import counterReducer from "./counter";
import messageReducer from "./message";

const rootReducer = combineReducers({
  counter: counterReducer,
  message: messageReducer,
});

export default rootReducer;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 state 目录新建 store.js 文件，用于存放创建 store 对象的代码。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/store.js
import { createStore } from "redux";
import reducers from "./reducers";

export const store = createStore(reducers);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 store 目录下创建 action-creators 文件夹，用于存放 action creator 代码</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/counter.js
export const increment = (payload) =&gt; ({ type: "increment", payload });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/message.js
export const saveMessage = (payload) =&gt; ({ type: "save_message", payload });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/index.js
export * from "./counter";
export * from "./message";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 state 目录下新建 index.js 文件，作为 state 文件夹下模块的导入口</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export * as actionCreators from "./action-creators";
export * from "./store";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>在应用入口文件中导入 store</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { store } from "./state";<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>在组件中导入 action creator</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { increment } from "./state";
import { saveMessage } from "./state";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="4-1-6-actionType-常量"><a href="#4-1-6-actionType-常量" class="headerlink" title="4.1.6 actionType 常量"></a>4.1.6 actionType 常量</h4><p>action 对象中的 type 属性值是一个字符串，我们要将它抽象成常量值，为什么呢？</p>
<ol>
<li>防止字符串书写错误，因为这个字符串既在 action creator 函数中用到，又在 reducer 函数中用到，而字符串在代码编辑器中是没有提示的。</li>
<li>方便修改，在后续的代码编辑中，很可能认识到之前定义的值不合适。</li>
</ol>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-types/counter.js
export const INCREMENT = "increment";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-types/message.js
export const SAVE_MESSAGE = "save_message";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/counter.js
import { INCREMENT } from "../action-types/counter";

export const increment = (payload) =&gt; ({ type: INCREMENT, payload });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/message.js
import { SAVE_MESSAGE } from "../action-types/message";

export const saveMessage = (payload) =&gt; ({ type: SAVE_MESSAGE, payload });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/counter.js
import { INCREMENT } from "../action-types/counter";

export default function counterReducer(state = initialState, action) {
  switch (action.type) {
    case INCREMENT:
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/message.js
import { SAVE_MESSAGE } from "../action-types/message";

export default function messageReducer(state = initialState, action) {
  switch (action.type) {
    case SAVE_MESSAGE:
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-7-bindActionCreators"><a href="#4-1-7-bindActionCreators" class="headerlink" title="4.1.7 bindActionCreators"></a>4.1.7 bindActionCreators</h4><p>组件：每个组件只要获取状态就都需要获取 dispatch，都需要导入 actionCreator 并传入 dispatch。此处代码可以通过 <code>bindActionCreators</code> 方法简化。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useDispatch } from "react-redux";
import { bindActionCreators } from "redux";
import { actionCreators } from "../state";

export const useActions = () =&gt; {
  const dispatch = useDispatch();
  return bindActionCreators(actionCreators, dispatch);
};

/**
 * actionCreators 是一个对象，对象中存储了所有的 action creator 函数
 * actionCreators =&gt; {increment: (){}, save_message: () {}}
 * bindActionCreators =&gt; {increment: dispatch(increment)}
 */<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-8-中间件函数"><a href="#4-1-8-中间件函数" class="headerlink" title="4.1.8 中间件函数"></a>4.1.8 中间件函数</h4><h5 id="1-中间件函数概述"><a href="#1-中间件函数概述" class="headerlink" title="1. 中间件函数概述"></a>1. 中间件函数概述</h5><p>默认的 Redux 工作流程只能处理同步状态，但在实际的项目开发中状态的获取、更新、删除等都需要通过异步来实现，那么如何在 Redux 中实现异步呢？</p>
<p>Redux 提供了中间件机制供开发者处理副作用代码，中间件其实就是一堆依次执行的函数，一堆供开发者执行副作用的函数。</p>
<img src="/medias/assets/images/37.png" align="left" width="50%">

<p>创建中间件函数要遵循中间件函数的创建规则，以下是创建中间件函数的模板代码。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 注意: 当 Action 被触发后，执行的是最里层函数，外层函数是用来传递参数的，只有初始化时执行。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-创建中间件函数"><a href="#2-创建中间件函数" class="headerlink" title="2. 创建中间件函数"></a>2. 创建中间件函数</h5><p>需求：创建一个用于输出 action 对象的中间件函数，当组件调用 dispatch 方法发送指令时，在控制台输出指令 action 对象。</p>
<p><code>src/store/middlewares/logger.js</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// logger 是中间件的名字, 它的作用是当组件发送操作状态的指令action对象时, 在控制台中输出该 action 对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// store, 对象类型, store.dispatch、store.getState</span>
  <span class="token comment">// 中间件函数内部的自定义逻辑</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当前的中间件函数执行完成后必须调用 next 方法, 使 redux 流程继续向前走, 否则代码会卡在当前函数中.</span>
  <span class="token comment">// 调用 next 方法时必须将 action 对象作为参数, 否则下一个中间件函数或者 reducer 就不知道当前要做什么事情了.</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> logger<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-注册中间件函数"><a href="#3-注册中间件函数" class="headerlink" title="3. 注册中间件函数"></a>3. 注册中间件函数</h5><p><code>src/store/index.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { applyMiddleware } from "redux";
import logger from "./middlewares/logger";

export const store = createStore(rootReducer, applyMiddleware(logger));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>中间件函数是可以批量注册的，当存在多个中间件时，中间函数是按照 applyMiddleware 方法的参数顺序执行的。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import logger from "./middlewares/logger";
import speak from "./middlewares/speak";

// 先执行 speak, 后执行 logger
export const store = createStore(rootReducer, applyMiddleware(speak, logger));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/images/36.png" align="left" width="50%">

<h5 id="4-状态调试工具"><a href="#4-状态调试工具" class="headerlink" title="4. 状态调试工具"></a>4. 状态调试工具</h5><ol>
<li><p>在谷歌浏览器中安装 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd?hl=zh-CN">Redux DevTools</a></p>
</li>
<li><p>在应用中安装 <code>redux-devtools-extension</code> </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> redux-devtools-extension<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>在应用中进行配置以开启调试工具</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> composeWithDevTools <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-devtools-extension'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token function">composeWithDevTools</span><span class="token punctuation">(</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="4-1-9-redux-thunk"><a href="#4-1-9-redux-thunk" class="headerlink" title="4.1.9 redux-thunk"></a>4.1.9 redux-thunk</h4><h5 id="1-基本使用"><a href="#1-基本使用" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h5><p>redux-thunk 是 Redux 官方提供的用于在 Redux 工作流程中加入异步代码的中间件。</p>
<p>需求：向 npm 发送请求加载 npm 包列表信息。</p>
<p>第一步：下载 redux-thunk 中间件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> redux-thunk axios<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第二步：注册 redux-thunk 中间件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/store.js
import { applyMiddleware } from "redux";
import thunk from "redux-thunk";

export const store = createStore(reducers, applyMiddleware(thunk));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三步：设计并定义 Action Type</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-types/packages.action.type.js
export const SEARCH_PACKAGES = "search_packages";
export const SEARCH_PACKAGES_SUCCESS = "search_packages_success";
export const SEARCH_PACKAGES_ERROR = "search_packages_error";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第四步：在 Reducer 函数中匹配 Action Type 并返回对应的新状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/reducers/packages.reducer.js
import { 
  SEARCH_PACKAGES, 
  SEARCH_PACKAGES_SUCCESS, 
  SEARCH_PACKAGES_ERROR 
} from "../action-types/packages.action.type.js";

const initialState = {
  list: [],
  loading: false,
  error: null,
};

export default function packagesReducer(state = initialState, action) {
  switch (action.type) {
    case SEARCH_PACKAGES:
      return {
        loading: true,
        error: null,
        list: [],
      };
    case SEARCH_PACKAGES_SUCCESS:
      return {
        loading: false,
        error: null,
        list: action.payload,
      };
    case SEARCH_PACKAGES_ERROR:
      return {
        loading: false,
        error: action.error,
        list: [],
      };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第五步：将 packagesReducer 合并到根 reducer</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import packagesReducer from "./packages"

export const reducers = combineReducers({
  packages: packagesReducer,
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第六步：创建 Action Creator 函数并在其中完成异步逻辑</p>
<p>在使用了 Redux Thunk 中间件以后，dispatch 方法可以接收一个函数作为参数，也就是说在 Action Creator 函数中可以再返回一个函数，我们需要在这个函数中完成异步操作，在该函数中根据异步流程更改 Store 中对应的状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/action-creators/packages.action.creator.js
import axios from "axios";
import {
  SEARCH_PACKAGES,
  SEARCH_PACKAGES_ERROR,
  SEARCH_PACKAGES_SUCCESS,
} from "../action-types/packages.action.type";

export const searchPackages = (key) =&gt; async (dispatch) =&gt; {
  dispatch({ type: SEARCH_PACKAGES });
  try {
    const { data } = await axios.get(`https://registry.npmjs.org/-/v1/search`, {
      params: {
        text: key,
      },
    });
    dispatch({
      type: SEARCH_PACKAGES_SUCCESS,
      payload: data.objects.map((item) =&gt; item.package.name),
    });
  } catch (error) {
    dispatch({ type: SEARCH_PACKAGES_ERROR, error: error.message });
  }
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第七步：在组件中实现对 npm 包的搜索</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRef } from "react";
import { useDispatch, useSelector } from "react-redux";
import { searchPackages } from "./state/action-creators/packages.action.creator";

export default function App() {
  const dispatch = useDispatch();
  const packages = useSelector((state) =&gt; state.packages);
  const inputRef = useRef();

  const getPackages = () =&gt; {
    if (packages.loading) {
      return &lt;div&gt;loading...&lt;/div&gt;;
    }
    if (packages.error) {
      return &lt;div&gt;{packages.error}&lt;/div&gt;;
    }
    return (
      &lt;div&gt;
        &lt;pre&gt;{JSON.stringify(packages, null, 2)}&lt;/pre&gt;
      &lt;/div&gt;
    );
  };

  return (
    &lt;&gt;
      &lt;input type="text" ref={inputRef} /&gt;
      &lt;button onClick={() =&gt; dispatch(searchPackages(inputRef.current.value))}&gt;
        search
      &lt;/button&gt;
      {getPackages()}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-实现原理"><a href="#2-实现原理" class="headerlink" title="2. 实现原理"></a>2. 实现原理</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// createThunkMiddleware 方法用于返回中间件函数
function createThunkMiddleware(extraArgument) {
  // 返回中间件函数
  return ({ dispatch, getState }) =&gt; next =&gt; action =&gt; {
    // 如果 action 是函数类型
    if (typeof action === 'function') {
      // 调用函数并传递相关参数
      return action(dispatch, getState, extraArgument);
    }
    // 如果 action 是对象类型, 调用 next 执行下一个中间件函数
    return next(action);
  };
}
// 调用 createThunkMiddleware 得到中间件函数
const thunk = createThunkMiddleware();

// 暴露获取中间件函数的方法, 用于方便开发者自己传递 extraArgument 参数
thunk.withExtraArgument = createThunkMiddleware;

// 导出默认创建好的 thunk 中间件函数
export default thunk;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-10-redux-saga"><a href="#4-1-10-redux-saga" class="headerlink" title="4.1.10 redux-saga"></a>4.1.10 redux-saga</h4><p><a target="_blank" rel="noopener" href="https://redux-saga.js.org/">redux-saga</a> 可以将异步操作从 Action Creator 文件中抽离出来，放在一个单独的文件中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> redux-saga<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">export const SEARCH_PACKAGES = "search_packages";
export const SEARCH_PACKAGES_SUCCESS = "search_packages_success";
export const SEARCH_PACKAGES_ERROR = "search_packages_error";<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { SEARCH_PACKAGES, SEARCH_PACKAGES_ERROR, SEARCH_PACKAGES_SUCCESS } from "../action-types/packages";

export const search_packages = (payload) =&gt; ({type: SEARCH_PACKAGES,payload});
export const search_packages_success = (payload) =&gt; ({type: SEARCH_PACKAGES_SUCCESS, payload});
export const search_packages_error = (error) =&gt; ({type: SEARCH_PACKAGES_ERROR, error});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { put, takeEvery } from "redux-saga/effects";
import { search_packages_error, search_packages_success } from "../action-creators/packages";
import { SEARCH_PACKAGES } from "../action-types/packages";

function* searchPackages(action) {
  try {
    const { data } = yield axios.get(`https://registry.npmjs.org/-/v1/search`, {
      params: {
        text: action.payload,
      },
    });
    yield put(
      search_packages_success(data.objects.map((item) =&gt; item.package.name))
    );
  } catch (error) {
    yield put(search_packages_error(error));
  }
}
// reducer 和 saga 可以同时匹配同一个 action, reducer 先接收, saga 后接收
export default function* packageSaga() {
  yield takeEvery(SEARCH_PACKAGES, searchPackages);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { SEARCH_PACKAGES, SEARCH_PACKAGES_ERROR, SEARCH_PACKAGES_SUCCESS } from "../action-types/packages";

const initialState = {
  list: [],
  loading: false,
  error: null,
};

export default function packagesReducer(state = initialState, action) {
  switch (action.type) {
    case SEARCH_PACKAGES:
      return {
        loading: true,
        error: null,
        list: [],
      };
    case SEARCH_PACKAGES_SUCCESS:
      return {
        loading: false,
        error: null,
        list: action.payload,
      };
    case SEARCH_PACKAGES_ERROR:
      return {
        loading: false,
        error: action.error,
        list: [],
      };
    default:
      return state;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRef } from "react";
import { useDispatch, useSelector } from "react-redux";
import { search_packages } from "../state/action-creators/packages";

function Packages() {
  const inputRef = useRef();
  const dispatch = useDispatch();
  const packages = useSelector((state) =&gt; state.packages.list);
  const onClickHandler = () =&gt; {
    dispatch(search_packages(inputRef.current.value));
  };
  return (
    &lt;&gt;
      &lt;input type="text" ref={inputRef} /&gt;
      &lt;button onClick={onClickHandler}&gt;search&lt;/button&gt;
      &lt;pre&gt;{JSON.stringify(packages, null, 2)}&lt;/pre&gt;
    &lt;/&gt;
  );
}

export default Packages;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 合并 saga
import { all } from "redux-saga/effects";
import packageSaga from "./packages";

export default function* sagas() {
  yield all([packageSaga()]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import createSagaMiddleware from "redux-saga";
import sagas from "./sagas";

const sagaMiddleware = createSagaMiddleware();
export const store = createStore(reducers, applyMiddleware(sagaMiddleware));
sagaMiddleware.run(sagas);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-1-11-redux-actions"><a href="#4-1-11-redux-actions" class="headerlink" title="4.1.11 redux-actions"></a>4.1.11 redux-actions</h4><p>Redux流程中大量的样板代码读写很痛苦，使用<a target="_blank" rel="noopener" href="https://redux-actions.js.org/">redux-actions</a>可以简化Action和Reducer的处理。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save redux-actions<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { createAction } from "redux-actions";

// createAction 方法用于创建 Action Creator 函数
// 它在 reducer 函数中也用于 action 对象类型的匹配
export const increment = createAction("increment");

// increment() -&gt; {type: "increment"}
// increment(1) -&gt; {type: "increment", payload: 1}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { handleActions as createReducer } from "redux-actions";
import { increment } from "../action-creators/counter";

const initialState = { count: 0 };

// createReducer 函数用于创建 reducer 函数
// 它的理念是对原有的 reducer 函数中的 switch case 进行拆分, 拆分为多个小的函数
const counterReducer = createReducer(
  {
    [increment]: (state, action) =&gt; ({
      ...state,
      count: state.count + action.payload,
    }),
  },
  initialState
);

export default counterReducer;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-ReduxToolkit"><a href="#4-2-ReduxToolkit" class="headerlink" title="4.2 ReduxToolkit"></a>4.2 ReduxToolkit</h3><h4 id="4-2-1-概述"><a href="#4-2-1-概述" class="headerlink" title="4.2.1 概述"></a>4.2.1 概述</h4><img src="/medias/assets/images/39.png">

<p>ReduxTookit 是 Redux 官方推出的基于 Redux 进行高度封装的工具包，降低了 Redux 的使用难度，使开发者能够用更少的代码完成更多的工作。</p>
<p>ReduxTookit 提供了强大且丰富状态编辑方法，进一步增强了 Redux 对状态进行处理的能力。</p>
<p>ReduxTookit 简化了创建、配置 Store 的各种和应用逻辑无关的代码，比如配置调试工具的代码，配置中间件的代码等等。</p>
<p>ReduxTookit 集成了常用的 Redux 中间件，不需要开发者单独下载，单独配置。</p>
<h4 id="4-2-2-下载-ReduxToolkit"><a href="#4-2-2-下载-ReduxToolkit" class="headerlink" title="4.2.2 下载 ReduxToolkit"></a>4.2.2 下载 ReduxToolkit</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新项目</span>
<span class="token comment"># Redux + Plain JS template</span>
npx create-react-app my-app --template redux
<span class="token comment"># Redux + TypeScript template</span>
npx create-react-app my-app --template redux-typescript<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 现有项目</span>
<span class="token function">npm</span> <span class="token function">install</span> @reduxjs/toolkit react-redux
<span class="token function">yarn</span> <span class="token function">add</span> @reduxjs/toolkit react-redux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-3-createAction"><a href="#4-2-3-createAction" class="headerlink" title="4.2.3 createAction"></a>4.2.3 createAction</h4><p>createAction 方法用于创建 action creator 函数。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createAction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> increment <span class="token operator">=</span> <span class="token function">createAction</span><span class="token punctuation">(</span><span class="token string">"counter/increment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// increment() =&gt; {type: "counter/increment"}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> decrement <span class="token operator">=</span> <span class="token function">createAction</span><span class="token punctuation">(</span><span class="token string">"counter/decrement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// decrement() =&gt; {type: "counter/decrement"}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> incrementByCount <span class="token operator">=</span> <span class="token function">createAction</span><span class="token punctuation">(</span><span class="token string">"counter/incrementByCount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// incrementByCount(5) =&gt; {type: "counter/incrementByCount", payload: 5}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-4-creatReducer"><a href="#4-2-4-creatReducer" class="headerlink" title="4.2.4 creatReducer"></a>4.2.4 creatReducer</h4><p>createReducer 方法用于创建 reducer 函数。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建 reducer 函数的第一种写法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrement<span class="token punctuation">,</span> increment<span class="token punctuation">,</span> incrementByCount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../actions/counter.action"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> counterReducer <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span>initialState<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  builder
    <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>increment<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>decrement<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addMatcher</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"counter/incrementByCount"</span> <span class="token operator">&amp;&amp;</span>
          <span class="token keyword">typeof</span> action<span class="token punctuation">.</span>payload <span class="token operator">===</span> <span class="token string">"number"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addDefaultCase</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建 reducer 函数的第二种写法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrement<span class="token punctuation">,</span> increment<span class="token punctuation">,</span> incrementByCount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../actions/counter.action"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> counterReducer <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span>initialState<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>increment<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>decrement<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>incrementByCount<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建 reducer 函数的第三种写法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrement<span class="token punctuation">,</span> increment<span class="token punctuation">,</span> incrementByCount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../actions/counter.action"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> counterReducer <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span>
  initialState<span class="token punctuation">,</span>
  <span class="token comment">// normal reducer</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>increment<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>decrement<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// matcher reducer</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token function-variable function">matcher</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">"counter/incrementByCount"</span> <span class="token operator">&amp;&amp;</span>
          <span class="token keyword">typeof</span> action<span class="token punctuation">.</span>payload <span class="token operator">===</span> <span class="token string">"number"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">reducer</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// default reducer</span>
  <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建 reducer 函数的第四种写法</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> counterReducer <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span>initialState<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token string">"counter/increment"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"counter/decrement"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"counter/incrementByCount"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-5-configureStore"><a href="#4-2-5-configureStore" class="headerlink" title="4.2.5 configureStore"></a>4.2.5 configureStore</h4><p>configureStore 方法用于创建 store 对象。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 导入 configureStore 方法, 用于创建、配置 store 对象</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> configureStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>
<span class="token comment">// 导入 counterReducer 函数, 用于配置 store 对象</span>
<span class="token keyword">import</span> counterReducer <span class="token keyword">from</span> <span class="token string">"./reducers/counter.reducer"</span><span class="token punctuation">;</span>

<span class="token comment">// 创建、配置、导出 store 对象</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 是否开启浏览器的 redux 开发者调试工具</span>
  devTools<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">"production"</span><span class="token punctuation">,</span>
  <span class="token comment">// reducer 选项用于替换原有的 combineReducers 方法, 用于合并应用中的多个 reducer 函数, 组成最终的 Store 对象</span>
  reducer<span class="token operator">:</span> <span class="token punctuation">{</span>
    counter<span class="token operator">:</span> counterReducer<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-6-createSlice"><a href="#4-2-6-createSlice" class="headerlink" title="4.2.6 createSlice"></a>4.2.6 createSlice</h4><p>ReduxToolkit 中的状态切片指的是管理状态、处理状态的地方，就是说原本 Redux 中由 Reducer 函数做的事情现在由状态切片来做。</p>
<p>ReduxToolkit 中可以有很多状态切片，每个状态切片负责处理一类状态，就是说原本 Redux 中的众多小的 Reducer 函数现在变成了众多小的状态切片。</p>
<p>ReduxToolkit 中的状态切片是 Reducer 函数的升级，创建状态切片的 API 会返回 Action Creators 函数和 Reducer 函数，使开发者可以专注于状态的管理。</p>
<p><code>store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// createSlice: 用于创建状态切片
import { createSlice } from "@reduxjs/toolkit";

// actions: 对象类型, 用于存储 action creator 函数, 函数名字和 reducers 配置选项中 reducer 函数的名字相对应
const { actions, reducer: TodoReducer } = createSlice({
  // createSlice 方法将会返回 action creator 函数, action creator 函数将要返回 action 对象
  // 按照约定, action 对象中的 type 属性值应该由两部分组成, 第一部分表示你要处理什么状态, 第二部分表示你要对该状态进行什么处理
  // 这样约定的目的是为了让代码看起来更加的清晰 {type: "todos/addTodo"}
  // name 属性配置的就是 action 对象中 type 属性值的一部分, 表示你要对什么状态进行处理
  name: "todos",
  // initialState 配置的是当前状态切片中状态的初始值
  initialState: [],
  // reducers 对象中配置的是对状态进行处理的 reducer 函数
  // 在原本的 reducer 函数中, 对状态进行的不同的处理是通过 switch case 语句匹配 action.type 属性实现的
  // ReduxToolkit 将原本的 switch case 抽象成了多个 reducer 函数, 每个 reducer 函数对应的就是原本 switch case 中的一种情况
  // 在 ReduxToolkit 中 reducer 函数的名字会作为 action 对象中 type 属性值的第二部分, 这样的话就形成了完整的 type 属性值了
  reducers: {
    // 添加任务
    addTodo(state, action) {
      // 在 ReduxToolkit 中的 reducer 函数里, 可以直接对状态进行处理, 不必拷贝新的状态再对其进行处理
      // 因为 ReduxToolkit 内部集成了不可变数据结构, 此处操作不会改变原有状态
      // 状态处理完成后也不必显式的在 reducer 函数中返回新的处理后的状态, 内部会帮助我们使用新状态替换旧状态
      // action.payload 是 ReduxToolkit 为 action 对象添加的属性, 属性值是调用 action creator 函数时传递的参数
      state.push(action.payload);
    },
  },
});
// 导出 action creator 函数, 供组件使用
export const { addTodo } = actions;
// 导出 reducer 函数, 因为在后续的代码中还是要合并 reducer 函数
export default TodoReducer;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-7-prepare"><a href="#4-2-7-prepare" class="headerlink" title="4.2.7 prepare"></a>4.2.7 prepare</h4><p>当 Action 指令被发出后，ReduxToolkit 允许开发者在 Reducer 函数接收 Action 之前预先对 Action 对象中的 payload 属性值进行预处理。</p>
<p>这样做的目的是抽离组件中和组件无关的逻辑，净化组件代码。</p>
<p><code>store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { nanoid } from "@reduxjs/toolkit";

createSlice({
  reducers: {
    addTodo: {
      reducer(state, action) {
        state.push(action.payload);
      },
      prepare(payload) {
        return {
          payload: { ...payload,  id: nanoid(), date: new Date },
        };
      },
    },
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-8-createAsyncThunk"><a href="#4-2-8-createAsyncThunk" class="headerlink" title="4.2.8 createAsyncThunk"></a>4.2.8 createAsyncThunk</h4><p>通过实现 <code>加载服务端任务列表</code> 功能学习 ReduxToolkit 是如何在工作流程中加入异步功能的。</p>
<p><code>src/store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 导入 createAsyncThunk 方法, 用于处理异步代码
import { createAsyncThunk } from "@reduxjs/toolkit";
// 导入 axios 对象, 用于发送 Ajax 请求
import axios from "axios";

// 调用 createAsyncThunk 方法, 用于处理异步代码
// createAsyncThunk 方法的第一个参数是 action 对象中 type 属性值的前缀, 按照约定, 异步 action 的 type 属性值由三部分构成
// 第一部分表示要对什么状态进行处理, 第二部分表示对状态进行什么处理, 第三部分表示对状态处理的过程进行到哪一步了
// 等待: todos/loadTodos/pending, 成功: todos/loadTodos/fulfilled, 失败: todos/loadTodos/rejected

// createAsyncThunk 方法的第二个参数是函数类型, 用于放置步代码
// 该参数函数有一个 payload 参数, 是调用 action creator 函数时传递的参数

// createAsyncThunk 方法的返回值是 action creator 函数, 调用它并将返回值传递给 dispatch, 可以触发该异步操作的执行
export const loadTodos = createAsyncThunk("todos/loadTodos", (payload) =&gt; {
  // 异步操作成功, 返回异步操作结果, 它将会被作为 fulfilled action 的 payload
  // 异步操作失败, 抛出异常, 它将会作为 rejected action 的 error
  try {
    return axios.get(payload).then((response) =&gt; response.data);
  } catch (error) {
    throw new Error("自定义错误信息");
  }
});

const { actions, reducer: TodoReducer } = createSlice({
  // 通过 extraReducers 配置项处理异步 action 
  extraReducers: {
    // 等待
    [loadTodos.pending]() {
      console.log("loadTodos.pending");
    },
    // 成功
    [loadTodos.fulfilled](state, action) {
      // action.payload: 存储异步操作成功的结果
      action.payload.forEach((todo) =&gt; state.push(todo));
    },
    // 失败
    [loadTodos.rejected](state, action) {
      // action.error: 存储异步操作失败的原因
      console.log("loadTodos.rejected");
    },
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/components/TodoMain.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect } from "react";
import { useDispatch } from "react-redux";
import { loadTodos } from "../store/todos.slice";

function TodoMain() {
  const dispatch = useDispatch();
  useEffect(() =&gt; {
    dispatch(loadTodos("http://localhost:3001/todos"));
  }, [dispatch]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-9-feature-key"><a href="#4-2-9-feature-key" class="headerlink" title="4.2.9 feature_key"></a>4.2.9 feature_key</h4><p>关于状态名称字符串，在多个地方被用到，比如设置状态名称前缀时，创建异步 Action Creator 时，在创建 Store 对象时，在组件中获取状态时，为了保持应用代码的可维护性，ReduxToolkit 官方推荐我们将它抽取成一个常量，然后在每个地方都使用这个常量，当常量值发生变化时每个使用的地方都会得到同步，不会轻易导致程序报错。</p>
<p><code>src/store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export const TODO_FEATURE_KEY = "todos";<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">createSlice({
  name: TODO_FEATURE_KEY,
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">createAsyncThunk(
  `${TODO_FEATURE_KEY}/loadTodos`
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>src/store/index.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default configureStore({
  reducer: {
    [TODO_FEATURE_KEY]: TodoReducer,
  }
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/components/TodoMain.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function TodoMain() {
  const todos = useSelector((state) =&gt; state[TODO_FEATURE_KEY]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-10-middleware"><a href="#4-2-10-middleware" class="headerlink" title="4.2.10 middleware"></a>4.2.10 middleware</h4><p>在 configureStore 方法的配置对象中，ReduxToolkit 提供了 middleware 选项用来配置中间件，它的值是一个函数，函数中要返回包含中间件的数组。</p>
<p>ReduxToolkit 默认内置了一些中间件，在 middleware 函数的返回值中要包含内置中间件，内置中间件通过函数参数获取。</p>
<p><code>src/store/index.js</code></p>
<p><code>npm i redux-logger</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import logger from "redux-logger";

export default configureStore({
  middleware: (getDefaultMiddeware) =&gt; {
    return getDefaultMiddeware().concat(logger);
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-11-实体适配器"><a href="#4-2-11-实体适配器" class="headerlink" title="4.2.11 实体适配器"></a>4.2.11 实体适配器</h4><h5 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h5><p>实体指的就是状态，可以将实体适配器理解为状态适配器。</p>
<p>实体适配器是对象类型，开发者必须按照要求的格式将状态存储在其中，实体适配器会提供操作状态的快捷方法，以简化 reducer 中对状态的操作代码。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">{
  // The unique IDs of each item. Must be strings or numbers
  ids: []
  // A lookup table mapping entity IDs to the corresponding entity objects
  entities: {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">{
  ids: [1,2,3],
  entities: {
    1: { "id": 1, "title": "吃饭", "isCompleted": false },
    2: { "id": 2, "title": "睡觉", "isCompleted": false },
    3: { "id": 3, "title": "打豆豆", "isCompleted": false }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-创建实体适配器"><a href="#2-创建实体适配器" class="headerlink" title="2. 创建实体适配器"></a>2. 创建实体适配器</h5><p><code>src/store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// createEntityAdapter: 用于创建实体适配器对象
import { createEntityAdapter } from "@reduxjs/toolkit";

// 创建用于存储 todo 任务列表的实体适配器
const todosAdapter = createEntityAdapter();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-应用实体适配器"><a href="#3-应用实体适配器" class="headerlink" title="3. 应用实体适配器"></a>3. 应用实体适配器</h5><p><code>src/store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const { actions, reducer: TodoReducer } = createSlice({
  // 将实体适配器的初始值作为状态切片的初始状态
  initialState: todosAdapter.getInitialState(),
  reducers: {
    addTodo: {
      reducer(state, action) {
        // 向实体适配器中添加一条状态
        todosAdapter.addOne(state, action);
      }
    },
  },
  extraReducers: {
    [loadTodos.fulfilled](state, action) {
      // 向实体适配器中添加多条状态
      todosAdapter.addMany(state, action);
    },
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/components/TodoMain.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function TodoMain() {
  const todos = useSelector((state) =&gt; state[TODO_FEATURE_KEY].entities);
  return (
    &lt;ul className="todo-list"&gt;
      {Object.values(todos).map((item) =&gt; ())}
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在实体操作方法的部它会判断如果方法接受到的第二个参数为 <code>action</code>，它会直接找到 action 对象中的 <code>payload</code>属性值，使用它和 <code>state</code> 对象进行交互，所以调用实体操作方法的代码可以简化为以下形式： </p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">createSlice({
  reducers: {
    addTodo: {
      reducer: todosAdaptor.addOne,
    },
  },
  extraReducers: {
    [loadTodos.fulfilled]: todosAdaptor.addMany
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-12-状态选择器"><a href="#4-2-12-状态选择器" class="headerlink" title="4.2.12 状态选择器"></a>4.2.12 状态选择器</h4><p>状态选择器用于从 store 对象中获取状态并将状态的格式转换为开发者想要的。</p>
<p><code>src/store/todos.slice.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { createSelector } from "@reduxjs/toolkit";

const { selectAll } = todosAdaptor.getSelectors();

export const selectTodos = createSelector(
  (state) =&gt; state[TODO_FEATURE_KEY],
  selectAll
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/components/TodosMain.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { loadTodos, selectTodos } from "../store/todos.slice";

const todos = useSelector(selectTodos);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="4-2-13-RTK-Query"><a href="#4-2-13-RTK-Query" class="headerlink" title="4.2.13 RTK Query"></a>4.2.13 RTK Query</h4><h5 id="1-概述-1"><a href="#1-概述-1" class="headerlink" title="1. 概述"></a>1. 概述</h5><p>RTK Query 是一个强大的状态获取和缓存工具，它可以简化 Redux 应用程序中的状态获取与缓存逻辑。</p>
<p>当从服务器端同步状态时，RTK Query 会将状态作为”缓存”存储在 Redux 存储中。</p>
<p>当对相同的状态执行额外的请求时，RTK Query 将提供现有的缓存数据，而不是向服务器端再次发送请求。</p>
<h5 id="2-createApi"><a href="#2-createApi" class="headerlink" title="2. createApi"></a>2. createApi</h5><p>通过 createApi 方法可以创建 API 状态切片，它用于定义请求、返回用于在组件中使用的同步状态的钩子函数。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/state/services/api.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createApi<span class="token punctuation">,</span> fetchBaseQuery <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit/query/react"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> apiService <span class="token operator">=</span> <span class="token function">createApi</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 设置状态存储在 store 中的名字</span>
  reducerPath<span class="token operator">:</span> <span class="token string">"api"</span><span class="token punctuation">,</span>
  <span class="token comment">// baseQuery 选项用于设置请求的公共配置</span>
  baseQuery<span class="token operator">:</span> <span class="token function">fetchBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 请求基准 URL</span>
    baseUrl<span class="token operator">:</span> <span class="token string">"http://jsonplaceholder.typicode.com/"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">endpoints</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-配置-store"><a href="#3-配置-store" class="headerlink" title="3. 配置 store"></a>3. 配置 store</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/state/store.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> configureStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@reduxjs/toolkit"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> apiService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./services"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  reducer<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>apiService<span class="token punctuation">.</span>reducerPath<span class="token punctuation">]</span><span class="token operator">:</span> apiService<span class="token punctuation">.</span>reducer<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">getDefaultMiddles</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getDefaultMiddles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>apiService<span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="4-定义获取状态的逻辑"><a href="#4-定义获取状态的逻辑" class="headerlink" title="4. 定义获取状态的逻辑"></a>4. 定义获取状态的逻辑</h5><p>正常来说，请求的定义要写在 endpoints 选项中，但是为了进行代码拆分，我们要根据不同类型的状态将其对应的请求定义拆分到不同的文件中。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/state/services/todo.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> apiService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"."</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> todoService <span class="token operator">=</span> apiService<span class="token punctuation">.</span><span class="token function">injectEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">endpoints</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// 获取任务列表</span>
    getTodos<span class="token operator">:</span> builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// 定义请求信息</span>
      <span class="token function-variable function">query</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token string">"/todos"</span><span class="token punctuation">,</span> params<span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token string">"get"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 对响应数据进行转换</span>
    <span class="token function-variable function">transformResponse</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">response<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 服务器端响应数据</span>
      <span class="token comment">// console.log(response);</span>

      <span class="token comment">// 对象类型, 内包含请求对象 request, 响应对象 response</span>
      <span class="token comment">// console.log(meta);</span>

      <span class="token comment">// 请求参数对象, 即 params</span>
      <span class="token comment">// console.log(arg);</span>

      <span class="token comment">// 该函数中返回什么, 客户端就缓存什么</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> useGetTodosQuery <span class="token punctuation">}</span> <span class="token operator">=</span> todoService<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="5-在组件中同步状态"><a href="#5-在组件中同步状态" class="headerlink" title="5. 在组件中同步状态"></a>5. 在组件中同步状态</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/components/pages/Todo/index.js
import { useGetTodosQuery } from "@state";

export default function Todo() {
  // isLoading: 只有初次加载状态时为true, 后续的每次重新加载都为false
  // error: 请求出错时包含错误信息的对象
  // data: 服务器端返回的状态
  // 优化: 当组件中的其他不相关状态的变化引起组件重新渲染时, 并不会同步状态
  const { data, error, isLoading } = useGetTodosQuery({ _limit: 5, _page: page });
  // 初始加载过程中显示的等待状态
  if (isLoading) return &lt;div&gt;loading....&lt;/div&gt;;
	// 请求出现错误后显示的错误信息
  if (error) return &lt;div&gt;{error.error}&lt;/div&gt;;
  return &lt;ul&gt; {data &amp;&amp; data.map((item) =&gt; &lt;li key={item.id}&gt;{item.title}&lt;/li&gt;)} &lt;/ul&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="6-同步状态选项"><a href="#6-同步状态选项" class="headerlink" title="6. 同步状态选项"></a>6. 同步状态选项</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// isFetching: 初次加载状态时为false, 后续的每次重新加载都为true</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> isFetching <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useGetTodosQuery</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> _limit<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> _page<span class="token operator">:</span> page <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 间隔 3s 重新发送请求同步状态</span>
    pollingInterval<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    <span class="token comment">// 当参数发生变化或者发生组件挂载行为时重新同步状态</span>
    refetchOnMountOrArgChange<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 当浏览器窗口重新获取焦点时同步状态</span>
    refetchOnFocus<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 当网络重新链接时同步状态</span>
    refetchOnReconnect<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 阻止默认同步状态的行为或者根据条件忽略某次同步状态的行为</span>
    <span class="token comment">// 如果值为 true, 将忽略同步状态的行为</span>
    <span class="token comment">// 比如组件初次挂载时同步状态的行为, 再比如当页面为3时忽略同步状态的行为</span>
    skip<span class="token operator">:</span> page <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：<code>refetchOnFocus</code> 和 <code>refetchOnReconnect</code> 默认是不生效的，需要做以下配置才可以。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/store.js
import { setupListeners } from "@reduxjs/toolkit/dist/query";
setupListeners(store.dispatch);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="7-定义状态突变逻辑"><a href="#7-定义状态突变逻辑" class="headerlink" title="7. 定义状态突变逻辑"></a>7. 定义状态突变逻辑</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/services/todo.js
import { apiService } from ".";

export const todoService = apiService.injectEndpoints({
  endpoints: (builder) =&gt; ({
    // 删除任务
    removeTodoById: builder.mutation({
      query: (id) =&gt; ({
        url: `/todos/${id}`,
        method: "delete",
      })
    })
  }),
});

export const { useRemoveTodoByIdMutation } = todoService;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="8-组件执行状态突变"><a href="#8-组件执行状态突变" class="headerlink" title="8. 组件执行状态突变"></a>8. 组件执行状态突变</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/components/pages/Todo/index.js
import { useRemoveToByIdMutation } from "@state";

export default function Todo() {
  // removeTodoById: 调用该方法执行状态突变
  // result: 突变过程中的状态跟踪及突变结果
  const [removeTodoById, result] = useRemoveToByIdMutation();
  return &lt;button onClick={() =&gt; removeToById(item.id)}&gt;delete&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="9-状态突变后更新列表"><a href="#9-状态突变后更新列表" class="headerlink" title="9. 状态突变后更新列表"></a>9. 状态突变后更新列表</h5><p>方式一：在删除操作成功以后重新同步列表状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/components/pages/Todo/index.js
export default function Todo() {
  // refetch: 调用该方法, 表示重新同步状态
  // 优化: 当组件中的其他不相关状态的变化引起组件重新渲染时, 并不会同步状态
  const { refetch } = useGetTodosQuery();
  const [removeToById, result] = useRemoveToByIdMutation();
	// 监听突变操作是否成功
  useEffect(() =&gt; {
    // 重新同步状态
    refetch();
  }, [result.isSuccess, refetch]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>方式二：使列表状态无效，RTK Query 会自动重新同步状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/services/todo.js
export const todoService = apiService.injectEndpoints({
  endpoints: (builder) =&gt; ({
    // 获取任务列表
    getTodos: builder.query({
      // 为缓存数据附加标签, 通过标签可以定位到数据从而对数据进行操作
      providesTags: ["todos"],
    }),
    // 删除任务
    removeToById: builder.mutation({
      invalidatesTags: ["todos"],
    }),
  }),
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="10-数据预取"><a href="#10-数据预取" class="headerlink" title="10. 数据预取"></a>10. 数据预取</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/state/services/todo.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> usePrefetch<span class="token operator">:</span> useTodosPrefetch <span class="token punctuation">}</span> <span class="token operator">=</span> todoService<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useTodosPrefetch } from "@state";

export default function Todo() {
  const prefetchTodos = useTodosPrefetch("getTodos");

  const prefetchNext = useCallback(() =&gt; {
    prefetchTodos({ _page: page + 1, _limit: 5 });
  }, [prefetchTodos, page]);
  return &lt;button onMouseEnter={prefetchNext} onClick={() =&gt; setPage((page) =&gt; page + 1)}&gt;{page}&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-3-MobX"><a href="#4-3-MobX" class="headerlink" title="4.3 MobX"></a>4.3 MobX</h3><h4 id="4-3-1-概述"><a href="#4-3-1-概述" class="headerlink" title="4.3.1. 概述"></a>4.3.1. 概述</h4><p>MobX 是一个简单的可扩展的状态管理库，无样板代码风格简约。</p>
<p>目前最新版本为 6，版本 4 和版本 5 已不再支持。</p>
<p>在 MobX 6 中不推荐使用装饰器语法，因为它不是 ES 标准，并且标准化过程要花费很长时间，但是通过配置仍然可以启用装饰器语法。</p>
<p>MobX 可以运行在任何支持 ES5 的环境中，包含浏览器和 Node。</p>
<p><a target="_blank" rel="noopener" href="https://mobx.js.org/README.html">MobX</a> 通常和 React 配合使用，但是在 <a target="_blank" rel="noopener" href="https://github.com/mobxjs/mobx-angular">Angular</a> 和 <a target="_blank" rel="noopener" href="https://github.com/mobxjs/mobx-vue">Vue</a> 中也可以使用 MobX。</p>
<h4 id="4-3-2-核心概念"><a href="#4-3-2-核心概念" class="headerlink" title="4.3.2 核心概念"></a>4.3.2 核心概念</h4><ol>
<li>observable：被 MobX 跟踪的状态。</li>
<li>action：允许修改状态的方法，在严格模式下只有 action 方法被允许修改状态。</li>
<li>computed：根据现有状态衍生出来的状态。</li>
<li>flow：执行副作用，它是 generator 函数。可以更改状态值。</li>
</ol>
<h4 id="4-3-3-工作流程"><a href="#4-3-3-工作流程" class="headerlink" title="4.3.3 工作流程"></a>4.3.3 工作流程</h4><img src="/medias/assets/images/54.png">

<h4 id="4-3-4-下载"><a href="#4-3-4-下载" class="headerlink" title="4.3.4 下载"></a>4.3.4 下载</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token function">yarn</span> <span class="token function">add</span> mobx@6.3.1 mobx-react-lite@3.2.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>mobx：MobX 核心库</li>
<li>mobx-react-lite：仅支持函数组件</li>
<li>mobx-react：既支持函数组件也支持类组件</li>
</ul>
<h4 id="4-3-5-案例驱动之计数器"><a href="#4-3-5-案例驱动之计数器" class="headerlink" title="4.3.5 案例驱动之计数器"></a>4.3.5 案例驱动之计数器</h4><p>在组件中显示数值状态，单击[+1]按钮使数值加一，单击[-1]按钮使数值减一。</p>
<ol>
<li><p>创建用于存储状态的 Store</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default class CounterStore {
  constructor() {
    this.count = 0
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建用于修改状态的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default class CounterStore {
  constructor() {
    this.count = 0
  }
  increment() {
    this.count += 1
  }
  decrement() {
    this.count -= 1
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>让 MobX 可以追踪状态的变化</p>
<ol>
<li>通过 observable 标识状态，使状态可观察</li>
<li>通过 action 标识修改状态的方法，状态只有通过 action 方法修改后才会通知视图更新</li>
</ol>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { action, makeObservable, observable } from "mobx"

export default class CounterStore {
  constructor() {
    this.count = 0
    makeObservable(this, {
      count: observable,
      increment: action,
      decrement: action
    })
  }
  increment() {
    this.count += 1
  }
  decrement() {
    this.count -= 1
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 Store 类的实例对象并将实例对象传递给组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// App.js
import Counter from "./Counter"
import CounterStore from "../store/Counter"

const counterStore = new CounterStore()

function App() {
  return &lt;Counter counterStore={counterStore} /&gt;
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在组件中通过 Store 实例对象获取状态以及操作状态的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Counter({ counterStore }) {
  return (
    &lt;Container&gt;
      &lt;Button onClick={() =&gt; counterStore.increment()}&gt;
        INCREMENT
      &lt;/Button&gt;
      &lt;Button&gt;{counterStore.count}&lt;/Button&gt;
      &lt;Button onClick={() =&gt; counterStore.decrement()}&gt;
        DECREMENT
      &lt;/Button&gt;
    &lt;/Container&gt;
  )
}

export default Counter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>当组件中使用到的 MobX 管理的状态发生变化后，使视图更新。通过 observer 方法包裹组件实现目的</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"

function Counter() { }

export default observer(Counter)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>简化组件代码</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Counter({ counterStore }) {
  const { count, increment, decrement } = counterStore
  return (
    &lt;Container&gt;
      &lt;Button border="left" onClick={increment}&gt;
        INCREMENT
      &lt;/Button&gt;
      &lt;Button&gt;{count}&lt;/Button&gt;
      &lt;Button border="right" onClick={decrement}&gt;
        DECREMENT
      &lt;/Button&gt;
    &lt;/Container&gt;
  )
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>当代码简化后，修改状态的方法中的 this 指向出现了问题，通过 action.bound 强制绑定 this，使 this 指向 Store 实例对象</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { action, makeObservable, observable } from "mobx"

export default class CounterStore {
  constructor() {
    this.count = 0
    makeObservable(this, {
      count: observable,
      increment: action.bound,
      decrement: action.bound
    })
  }
  increment() {
    this.count += 1
  }
  decrement() {
    this.count -= 1
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>总结：状态变化更新视图的必要条件</p>
<ol>
<li>状态必须被标记为 <code>observable</code></li>
<li>更改状态的方法必须被标记为 <code>action</code></li>
<li>组件必须通过 <code>observer</code> 方法包裹</li>
</ol>
</li>
<li><p>创建 RootStore</p>
<p>在应用中可存在多个 Store，多个 Store 最终要通过 RootStore 管理，在每个组件都需要获取到 RootStore。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// store/index.js
import { createContext, useContext } from "react"
import CounterStore from "./Counter"

class RootStore {
  constructor() {
    this.counterStore = new CounterStore()
  }
}
const rootStore = new RootStore()
const RootStoreContext = createContext()

export const RootStoreProvider = ({ children }) =&gt; {
  return (
    &lt;RootStoreContext.Provider value={rootStore}&gt;
      {children}
    &lt;/RootStoreContext.Provider&gt;
  )
}

export const useRootStore = () =&gt; {
  return useContext(RootStoreContext)
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// App.js
import { RootStoreProvider } from "../store"
import Counter from "./Counter"

function App() {
  return (
    &lt;RootStoreProvider&gt;
      &lt;Counter /&gt;
    &lt;/RootStoreProvider&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import { useRootStore } from "../store"

function Counter() {
  const { counterStore } = useRootStore()
  const { count, increment, decrement } = counterStore
  return (
    &lt;Container&gt;
      &lt;Button onClick={increment}&gt;
        INCREMENT
      &lt;/Button&gt;
      &lt;Button&gt;{count}&lt;/Button&gt;
      &lt;Button onClick={decrement}&gt;
        DECREMENT
      &lt;/Button&gt;
    &lt;/Container&gt;
  )
}

export default observer(Counter)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="4-3-6-案例驱动之-Todo"><a href="#4-3-6-案例驱动之-Todo" class="headerlink" title="4.3.6 案例驱动之 Todo"></a>4.3.6 案例驱动之 Todo</h4><h5 id="1-创建-Store"><a href="#1-创建-Store" class="headerlink" title="1. 创建 Store"></a>1. 创建 Store</h5><ol>
<li><p>创建用于管理 Todo 任务的 Store</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { makeObservable, observable } from "mobx"

export default class Todo {
  constructor(todo) {
    this.id = todo.id
    this.title = todo.title
    this.isCompleted = todo.isCompleted || false
    this.isEditing = false
    makeObservable(this, {
      title: observable,
      isCompleted: observable,
      isEditing: observable
    })
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建用于管理 Todo 任务列表的 Store</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { makeObservable, observable } from "mobx"

export default class TodoStore {
  constructor() {
    this.todos = []
    makeObservable(this, {
      todos: observable
    })
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="2-添加任务"><a href="#2-添加任务" class="headerlink" title="2. 添加任务"></a>2. 添加任务</h5><ol>
<li><p>创建向 todo 任务列表中添加 todo 任务的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { action, makeObservable, observable } from "mobx"
import Todo from "./Todo"

export default class TodoStore {
  constructor() {
    this.todos = []
    makeObservable(this, {
      todos: observable,
      addTodo: action.bound
    })
  }
  addTodo(title) {
    this.todos.push(new Todo({ title, id: this.generateTodoId() }))
  }
  generateTodoId() {
    if (!this.todos.length) return 1
    return this.todos.reduce((id, todo) =&gt; (id &lt; todo.id ? todo.id : id), 0) + 1
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在组件中实现添加任务的逻辑</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react"
import { useRootStore } from "../../store"

function Header() {
  const [title, setTitle] = useState("")
  const { todoStore } = useRootStore()
  const { addTodo } = todoStore
  return (
    &lt;header className="header"&gt;
      &lt;input
        value={title}
        onChange={e =&gt; setTitle(e.target.value)}
        onKeyUp={e =&gt; {
          if (e.key !== "Enter") return
          addTodo(title)
          setTitle("")
        }}
      /&gt;
    &lt;/header&gt;
  )
}

export default Header<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="3-显示任务列表"><a href="#3-显示任务列表" class="headerlink" title="3. 显示任务列表"></a>3. 显示任务列表</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import { useRootStore } from "../../store"
import Todo from "./Todo"

function Main() {
  const { todoStore } = useRootStore()
  const { todos } = todoStore
  return (
    &lt;section className="main"&gt;
      &lt;ul className="todo-list"&gt;
        {todos.map(todo =&gt; (
          &lt;Todo key={todo.id} todo={todo} /&gt;
        ))}
      &lt;/ul&gt;
    &lt;/section&gt;
  )
}

export default observer(Main)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Todo({ todo }) {
  return (
    &lt;li&gt;
      &lt;div className="view"&gt;
        &lt;input className="toggle" type="checkbox" /&gt;
        &lt;label&gt;{todo.title}&lt;/label&gt;
        &lt;button className="destroy" /&gt;
      &lt;/div&gt;
      &lt;input className="edit" /&gt;
    &lt;/li&gt;
  )
}

export default Todo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="4-加载远端任务"><a href="#4-加载远端任务" class="headerlink" title="4 加载远端任务"></a>4 加载远端任务</h5><ol>
<li><p>下载 json-server：<code>yarn add json-server@0.16.3</code></p>
</li>
<li><p>创建 db.json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"todos"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"吃饭"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"睡觉"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"打豆豆"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 package.json 文件中添加启动命令</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"json-server"</span><span class="token operator">:</span> <span class="token string">"json-server --watch ./db.json --port 3001"</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p>启动 json-server：<code>npm run json-server</code></p>
</li>
<li><p>在 todoStore 中添加加载任务列表的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { flow, makeObservable, observable } from "mobx"
import Todo from "./Todo"

export default class TodoStore {
  constructor() {
    this.todos = []
    makeObservable(this, {
      todos: observable,
      loadTodos: flow
    })
    this.loadTodos()
  }
  *loadTodos() {
    let response = yield axios.get("http://localhost:3001/todos")
    response.data.forEach(todo =&gt; this.todos.push(new Todo(todo)))
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="5-更改任务状态"><a href="#5-更改任务状态" class="headerlink" title="5. 更改任务状态"></a>5. 更改任务状态</h5><ol>
<li><p>在 Todo 类中添加修改任务是否已经完成的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default class Todo {
  constructor() {
    makeObservable(this, {
      modifyTodoIsCompleted: action.bound
    })
  }
  modifyTodoIsCompleted() {
    this.isCompleted = !this.isCompleted
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>TodoCompleted</code> 组件实现逻辑</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"

function TodoCompleted({ todo }) {
  const { isCompleted, modifyTodoIsCompleted } = todo
  return (
    &lt;input
      className="toggle"
      type="checkbox"
      checked={isCompleted}
      onChange={modifyTodoIsCompleted}
    /&gt;
  )
}

export default observer(TodoCompleted)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Todo</code> 组件中引用<code>TodoCompleted</code> 组件并根据条件决定是否为 <code>li</code> 添加 <code>completed</code> 类名</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import TodoCompleted from "./TodoCompleted"

function Todo({ todo }) {
  return (
    &lt;li className={todo.isCompleted ? "completed" : ""}&gt;
      &lt;div className="view"&gt;
        &lt;TodoCompleted todo={todo} /&gt;
      &lt;/div&gt;
    &lt;/li&gt;
  )
}

export default observer(Todo)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="6-删除任务"><a href="#6-删除任务" class="headerlink" title="6. 删除任务"></a>6. 删除任务</h5><ol>
<li><p>在 <code>todoStore</code> 中添加实现删除任务的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { action, makeObservable,  } from "mobx"

export default class TodoStore {
  constructor() {
    makeObservable(this, {
      removeTodo: action.bound
    })
  }
  removeTodo(id) {
    this.todos = this.todos.filter(todo =&gt; todo.id !== id)
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>TodoDelete</code> 组件实现删除 todo 任务逻辑</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRootStore } from "../../store"

function TodoDelete({ id }) {
  const { todoStore } = useRootStore()
  const { removeTodo } = todoStore
  return &lt;button className="destroy" onClick={removeTodo.bind(null, id)} /&gt;
}

export default TodoDelete<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Todo</code> 组件调用 <code>TodoDelete</code> 组件并传入 todo ID</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import TodoDelete from "./TodoDelete"

function Todo({ todo }) {
  return (
    &lt;li&gt;
      &lt;div className="view"&gt;
        &lt;TodoDelete id={todo.id} /&gt;
      &lt;/div&gt;
    &lt;/li&gt;
  )
}

export default observer(Todo)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="7-编辑任务"><a href="#7-编辑任务" class="headerlink" title="7. 编辑任务"></a>7. 编辑任务</h5><ol>
<li><p>在 todoStore 中添加更改任务是否处于编辑状态的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { action, makeObservable } from "mobx"

export default class Todo {
  constructor(todo) {
    makeObservable(this, {
      modifyTodoIsEditing: action.bound,
    })
  }
  modifyTodoIsEditing() {
    this.isEditing = !this.isEditing
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>添加 <code>TodoTitle</code> 组件展示任务标题并为其添加双击事件，当事件发生时将任务更改为可编辑状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function TodoTitle({ todo }) {
  const { title, modifyTodoIsEditing } = todo
  return &lt;label onDoubleClick={modifyTodoIsEditing}&gt;{title}&lt;/label&gt;
}

export default TodoTitle<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Todo</code> 组件中调用 <code>TodoTitle</code> 组件，并为 <code>li</code> 添加 <code>editing</code> 类名</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import TodoTitle from "./TodoTitle"
import classnames from "classnames"

function Todo({ todo }) {
  return (
    &lt;li className={classnames({ completed: todo.isCompleted, editing: todo.isEditing })} &gt;
      &lt;div className="view"&gt;
        &lt;TodoTitle todo={todo} /&gt;
      &lt;/div&gt;
    &lt;/li&gt;
  )
}

export default observer(Todo)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>TodoEditing</code> 组件实现编辑 todo 任务标题</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRef, useEffect } from "react"

function TodoEditing({ todo }) {
  const { title, modifyTodoTitle, isEditing } = todo
  const ref = useRef(null)
  useEffect(() =&gt; {
    if (isEditing) ref.current.focus()
  }, [isEditing])
  return (
    &lt;input
      ref={ref}
      className="edit"
      defaultValue={title}
      onBlur={e =&gt; modifyTodoTitle(e.target.value)}
    /&gt;
  )
}

export default TodoEditing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Todo</code> 组件中调用 <code>TodoEditing</code> 组件并传递 todo 任务</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import TodoTitle from "./TodoTitle"
import classnames from "classnames"
import TodoEditing from "./TodoEditing"

function Todo({ todo }) {
  return (
    &lt;li className={classnames({ completed: todo.isCompleted, editing: todo.isEditing })} &gt;
      &lt;div className="view"&gt;
        &lt;TodoTitle todo={todo} /&gt;
      &lt;/div&gt;
      &lt;TodoEditing todo={todo} /&gt;
    &lt;/li&gt;
  )
}

export default observer(Todo)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="8-计算未完成任务数量"><a href="#8-计算未完成任务数量" class="headerlink" title="8. 计算未完成任务数量"></a>8. 计算未完成任务数量</h5><ol>
<li><p>在 todoStore 中添加获取未完成任务数量的派生状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { makeObservable, computed } from "mobx"

export default class TodoStore {
  constructor() {
    makeObservable(this, {
      unCompletedTodoCount: computed
    })
  }
  get unCompletedTodoCount() {
    return this.todos.filter(todo =&gt; !todo.isCompleted).length
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>UnCompletedTodoCount</code> 组件实现逻辑</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import { useRootStore } from "../../store"

function UnCompletedTodoCount() {
  const { todoStore } = useRootStore()
  const { unCompletedTodoCount } = todoStore
  return (
    &lt;span className="todo-count"&gt;
      &lt;strong&gt;{unCompletedTodoCount}&lt;/strong&gt; item left
    &lt;/span&gt;
  )
}

export default observer(UnCompletedTodoCount)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Footer</code> 组件中调用 <code>UnCompletedTodoCount</code> 组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import UnCompletedTodoCount from "./UnCompletedTodoCount"

function Footer() {
  return (
    &lt;footer className="footer"&gt;
      &lt;UnCompletedTodoCount /&gt;
    &lt;/footer&gt;
  )
}

export default Footer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="9-任务过滤"><a href="#9-任务过滤" class="headerlink" title="9. 任务过滤"></a>9. 任务过滤</h5><ol>
<li><p>在 <code>todoStore</code> 中添加存储过滤条件的属性以及更改过滤条件的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { action, makeObservable, observable, } from "mobx"

export default class TodoStore {
  constructor() {
    this.filterCondition = "All"
    makeObservable(this, {
      modifyFilterCondition: action.bound,
      filterCondition: observable,
    })
  }
  modifyFilterCondition(filterCondition) {
    this.filterCondition = filterCondition
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>TodoFilter</code> 组件，为过滤按钮添加事件以更改过滤条件，根据过滤条件为按钮添加 <code>selected</code> 类名</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import classNames from "classnames"
import { observer } from "mobx-react-lite"
import { useRootStore } from "../../store"

function TodoFilter() {
  const { todoStore } = useRootStore()
  const { filterCondition, modifyFilterCondition } = todoStore
  return (
    &lt;ul className="filters"&gt;
      &lt;li&gt;
        &lt;button
          onClick={() =&gt; modifyFilterCondition("All")}
          className={classNames({ selected: filterCondition === "All" })}
        &gt;
          All
        &lt;/button&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;button
          onClick={() =&gt; modifyFilterCondition("Active")}
          className={classNames({ selected: filterCondition === "Active" })}
        &gt;
          Active
        &lt;/button&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;button
          onClick={() =&gt; modifyFilterCondition("Completed")}
          className={classNames({ selected: filterCondition === "Completed" })}
        &gt;
          Completed
        &lt;/button&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  )
}

export default observer(TodoFilter)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Footer</code> 组件中调用 <code>TodoFilter</code> 组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import TodoFilter from "./TodoFilter"

function Footer() {
  return (
    &lt;footer className="footer"&gt;
      &lt;TodoFilter /&gt;
    &lt;/footer&gt;
  )
}

export default Footer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>TodoStore</code> 中添加派生状态，根据条件获取过滤后的 todo 列表</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { action, flow, makeObservable, observable, computed } from "mobx"
import Todo from "./Todo"

export default class TodoStore {
  constructor() {
    makeObservable(this, {
      filterTodos: computed
    })
  }
  get filterTodos() {
    switch (this.filterCondition) {
      case "Active":
        return this.todos.filter(todo =&gt; !todo.isCompleted)
      case "Completed":
        return this.todos.filter(todo =&gt; todo.isCompleted)
      default:
        return this.todos
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 Main 组件获取 <code>filterTodos</code> 派生状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { observer } from "mobx-react-lite"
import { useRootStore } from "../../store"
import Todo from "./Todo"

function Main() {
  const { todoStore } = useRootStore()
  const { filterTodos } = todoStore
  return (
    &lt;section className="main"&gt;
      &lt;ul className="todo-list"&gt;
        {filterTodos.map(todo =&gt; (
          &lt;Todo key={todo.id} todo={todo} /&gt;
        ))}
      &lt;/ul&gt;
    &lt;/section&gt;
  )
}

export default observer(Main)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h5 id="10-清除已完成任务"><a href="#10-清除已完成任务" class="headerlink" title="10. 清除已完成任务"></a>10. 清除已完成任务</h5><ol>
<li><p>在 <code>TodoStore</code> 中添加清除已完成任务的方法</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { action, makeObservable, } from "mobx"

export default class TodoStore {
  constructor() {
    makeObservable(this, {
      clearCompleted: action.bound
    })
  }
  clearCompleted() {
    this.todos = this.todos.filter(todo =&gt; !todo.isCompleted)
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建 <code>ClearCompleted</code> 组件实现清除已完成任务功能</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRootStore } from "../../store"

function ClearCompleted() {
  const { todoStore } = useRootStore()
  const { clearCompleted } = todoStore
  return (
    &lt;button className="clear-completed" onClick={clearCompleted}&gt;
      Clear completed
    &lt;/button&gt;
  )
}

export default ClearCompleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>Footer</code> 组件中调用 <code>ClearCompleted</code> 组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ClearCompleted from "./ClearCompleted"

function Footer() {
  return (
    &lt;footer className="footer"&gt;
      &lt;ClearCompleted /&gt;
    &lt;/footer&gt;
  )
}

export default Footer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="4-4-Recoil"><a href="#4-4-Recoil" class="headerlink" title="4.4 Recoil"></a>4.4 Recoil</h3><h4 id="4-4-1-概述"><a href="#4-4-1-概述" class="headerlink" title="4.4.1 概述"></a>4.4.1 概述</h4><p>Recoil 是 Facebook 提供的在 React 中实现全局状态管理的扩展库，目前仍然在实验阶段。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> recoil<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="4-4-2-RecoilRoot"><a href="#4-4-2-RecoilRoot" class="headerlink" title="4.4.2 RecoilRoot"></a>4.4.2 RecoilRoot</h4><p>RecoilRoot 用于为组件提供获取状态的上下文对象。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ReactDOM from "react-dom";
import App from "./App";
import { RecoilRoot } from "recoil";

ReactDOM.render(
  &lt;RecoilRoot&gt;
    &lt;App /&gt;
  &lt;/RecoilRoot&gt;,
  document.getElementById("root")
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-3-atom"><a href="#4-4-3-atom" class="headerlink" title="4.4.3 atom"></a>4.4.3 atom</h4><p>atom 方法用于创建全局状态。</p>
<h5 id="1-未使用全局状态"><a href="#1-未使用全局状态" class="headerlink" title="1. 未使用全局状态"></a>1. 未使用全局状态</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";

function DarkModeSwitch({ dark, setDark }) {
  return (
    &lt;input
      type="checkbox"
      checked={dark}
      onChange={(event) =&gt; setDark(event.target.checked)}
    /&gt;
  );
}

function Paragraph({ dark }) {
  const styles = {
    background: dark ? "black" : "white",
    color: dark ? "white" : "black",
  };
  return &lt;p style={styles}&gt;Paragraph ...&lt;/p&gt;;
}

function App() {
  const [dark, setDark] = useState(false);
  return (
    &lt;&gt;
      &lt;DarkModeSwitch dark={dark} setDark={setDark} /&gt;
      &lt;Paragraph dark={dark} /&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-使用了全局状态"><a href="#2-使用了全局状态" class="headerlink" title="2. 使用了全局状态"></a>2. 使用了全局状态</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { atom, useRecoilState, useRecoilValue } from "recoil";

const darkModeState = atom({
  key: "darkModeState",
  default: false,
});

function DarkModeSwitch() {
  const [dark, setDark] = useRecoilState(darkModeState);
  return (
    &lt;input
      type="checkbox"
      checked={dark}
      onChange={(event) =&gt; setDark(event.target.checked)}
    /&gt;
  );
}

function Paragraph() {
  const dark = useRecoilValue(darkModeState);
  const styles = {
    background: dark ? "black" : "white",
    color: dark ? "white" : "black",
  };
  return &lt;p style={styles}&gt;Paragraph ...&lt;/p&gt;;
}

function App() {
  return (
    &lt;&gt;
      &lt;DarkModeSwitch /&gt;
      &lt;Paragraph /&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="3-代码拆分"><a href="#3-代码拆分" class="headerlink" title="3. 代码拆分"></a>3. 代码拆分</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/atoms/darkMode.js
import { atom, useRecoilState, useRecoilValue } from "recoil";

const darkModeState = atom({
  key: "darkModeState",
  default: false,
});

export function useDarkModeState() {
  return useRecoilState(darkModeState);
}

export function useDarkModeValue() {
  return useRecoilValue(darkModeState);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useDarkModeState, useDarkModeValue } from "./atoms/darkMode";

function DarkModeSwitch() {
  const [dark, setDark] = useDarkModeState();
  return (
    &lt;input
      type="checkbox"
      checked={dark}
      onChange={(event) =&gt; setDark(event.target.checked)}
    /&gt;
  );
}

function Paragraph() {
  const dark = useDarkModeValue();
  const styles = {
    background: dark ? "black" : "white",
    color: dark ? "white" : "black",
  };
  return &lt;p style={styles}&gt;Paragraph ...&lt;/p&gt;;
}

function App() {
  return (
    &lt;&gt;
      &lt;DarkModeSwitch /&gt;
      &lt;Paragraph /&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-4-selector"><a href="#4-4-4-selector" class="headerlink" title="4.4.4 selector"></a>4.4.4 selector</h4><p>selector 表示派生状态，基于现有状态计算新的状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { atom, selector, useRecoilState, useRecoilValue } from "recoil";
// 汇率
const exChangeRate = 0.1572;
// 人民币
const CNYState = atom({
  key: "CNY",
  default: 1,
});
// 根据汇率将人民币转换为美元
const USDSelector = selector({
  key: "USD",
  get: ({ get }) =&gt; {
    const CNY = get(CNYState);
    return CNY * exChangeRate;
  },
  // 设置新的美元时重新计算人民币
  set({ set }, newValue) {
    const newCNY = newValue / exChangeRate;
    set(CNYState, newCNY);
  },
});

function App() {
  const [CNY, setCNY] = useRecoilState(CNYState);
  const [USD, setUSD] = useRecoilState(USDSelector);
  return (
    &lt;&gt;
      &lt;input
        type="text"
        value={CNY}
        onChange={(event) =&gt; setCNY(event.target.value)}
      /&gt;
      &lt;input
        type="text"
        value={USD}
        onChange={(event) =&gt; setUSD(event.target.value)}
      /&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-5-data-fetching"><a href="#4-4-5-data-fetching" class="headerlink" title="4.4.5 data fetching"></a>4.4.5 data fetching</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { Suspense } from "react";
import { atom, selector, useRecoilState, useRecoilValue } from "recoil";

const userIdState = atom({
  key: "userId",
  default: "",
});

const userState = selector({
  key: "userState",
  get: async ({ get }) =&gt; {
    const userId = get(userIdState);
    if (userId) {
      let response = await axios.get(
        `https://jsonplaceholder.typicode.com/users/${userId}`
      );
      return response.data;
    }
  },
});

function User() {
  const user = useRecoilValue(userState);
  return (
    &lt;ul&gt;
      &lt;li&gt;{user.name}&lt;/li&gt;
      &lt;li&gt;{user.email}&lt;/li&gt;
    &lt;/ul&gt;
  );
}

function App() {
  const [userId, setUserId] = useRecoilState(userIdState);
  return (
    &lt;&gt;
      &lt;select
        value={userId}
        onChange={(event) =&gt; setUserId(event.target.value)}
      &gt;
        &lt;option value=""&gt;请选择用户&lt;/option&gt;
        &lt;option value="1"&gt;用户一&lt;/option&gt;
        &lt;option value="2"&gt;用户二&lt;/option&gt;
        &lt;option value="3"&gt;用户三&lt;/option&gt;
      &lt;/select&gt;
      {userId &amp;&amp; (
        &lt;Suspense fallback={&lt;div&gt;loading...&lt;/div&gt;}&gt;
          &lt;User /&gt;
        &lt;/Suspense&gt;
      )}
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-6-selectorFamily"><a href="#4-4-6-selectorFamily" class="headerlink" title="4.4.6 selectorFamily"></a>4.4.6 selectorFamily</h4><p>selectorFamily 允许开发者在调用查询时传递参数。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { Suspense, useState } from "react";
import { selectorFamily, useRecoilValue } from "recoil";

const userState = selectorFamily({
  key: "userState",
  get: (userId) =&gt; async () =&gt; {
    if (userId) {
      let response = await axios.get(
        `https://jsonplaceholder.typicode.com/users/${userId}`
      );
      return response.data;
    }
  },
});

function User({ userId }) {
  const user = useRecoilValue(userState(userId));
  return (
    &lt;ul&gt;
      &lt;li&gt;{user.name}&lt;/li&gt;
      &lt;li&gt;{user.email}&lt;/li&gt;
    &lt;/ul&gt;
  );
}

function App() {
  const [userId, setUserId] = useState("");
  return (
    &lt;&gt;
      &lt;select
        value={userId}
        onChange={(event) =&gt; setUserId(event.target.value)}
      &gt;
        &lt;option value=""&gt;请选择用户&lt;/option&gt;
        &lt;option value="1"&gt;用户一&lt;/option&gt;
        &lt;option value="2"&gt;用户二&lt;/option&gt;
        &lt;option value="3"&gt;用户三&lt;/option&gt;
      &lt;/select&gt;
      {userId &amp;&amp; (
        &lt;Suspense fallback={&lt;div&gt;loading...&lt;/div&gt;}&gt;
          &lt;User userId={userId} /&gt;
        &lt;/Suspense&gt;
      )}
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-7-catch-errors"><a href="#4-4-7-catch-errors" class="headerlink" title="4.4.7 catch errors"></a>4.4.7 catch errors</h4><p>使用错误边界组件捕获程序执行过程中出现的错误。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i react-error-boundary@3.1.4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { Suspense, useState } from "react";
import { selectorFamily, useRecoilValue } from "recoil";
import { ErrorBoundary } from "react-error-boundary";

const userState = selectorFamily({
  key: "userState",
  get: (userId) =&gt; async () =&gt; {
    if (userId) {
      let response = await axios.get(
        `https://jsonplaceholder.typicode.com/users/${userId}`
      );
      // 模拟程序出现错误
      if (userId === "4") throw new Error("用户不存在");
      return response.data;
    }
  },
});

function User({ userId }) {
  const user = useRecoilValue(userState(userId));
  return (
    &lt;ul&gt;
      &lt;li&gt;{user.name}&lt;/li&gt;
      &lt;li&gt;{user.email}&lt;/li&gt;
    &lt;/ul&gt;
  );
}

// resetErrorBoundary: 用于重置错误边界
function ErrorFallback({ error, resetErrorBoundary }) {
  return (
    &lt;&gt;
      &lt;p&gt;发生了错误:&lt;/p&gt;
      &lt;pre&gt;{error.message}&lt;/pre&gt;
      &lt;button onClick={resetErrorBoundary}&gt;重试&lt;/button&gt;
    &lt;/&gt;
  );
}

function App() {
  const [userId, setUserId] = useState("");
  return (
    &lt;&gt;
      &lt;select
        value={userId}
        onChange={(event) =&gt; setUserId(event.target.value)}
      &gt;
        &lt;option value=""&gt;请选择用户&lt;/option&gt;
        &lt;option value="1"&gt;用户一&lt;/option&gt;
        &lt;option value="2"&gt;用户二&lt;/option&gt;
        &lt;option value="3"&gt;用户三&lt;/option&gt;
        &lt;option value="4"&gt;用户四&lt;/option&gt;
      &lt;/select&gt;
      {/*
          FallbackComponent: 指定发生错误时显示的用户界面
          onReset: 错误边界被重置时执行的回调函数
          resetKeys: 当指定的状态发生更改时重置错误边界
        */}
      &lt;ErrorBoundary FallbackComponent={ErrorFallback} resetKeys={[userId]}&gt;
        {userId &amp;&amp; (
          &lt;Suspense fallback={&lt;div&gt;loading...&lt;/div&gt;}&gt;
            &lt;User userId={userId} /&gt;
          &lt;/Suspense&gt;
        )}
      &lt;/ErrorBoundary&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-4-8-effects"><a href="#4-4-8-effects" class="headerlink" title="4.4.8 effects"></a>4.4.8 effects</h4><p>effects 用于执行副作用。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";
import { atom, useRecoilState } from "recoil";

const todoListState = atom({
  key: "todoList",
  default: [],
  effects: [
    ({ setSelf, onSet }) =&gt; {
      const storedTodo = localStorage.getItem("todos");
      if (storedTodo) setSelf(JSON.parse(storedTodo));
      onSet((value) =&gt; {
        localStorage.setItem("todos", JSON.stringify(value));
      });
    },
  ],
});

function App() {
  const [title, setTitle] = useState("");
  const [todos, setTodos] = useRecoilState(todoListState);
  const addTodo = (event) =&gt; {
    if (event.key === "Enter") {
      setTodos([...todos, { title }]);
      setTitle("");
    }
  };
  return (
    &lt;div&gt;
      &lt;input
        type="text"
        value={title}
        onChange={(event) =&gt; setTitle(event.target.value)}
        onKeyUp={addTodo}
      /&gt;
      &lt;ul&gt;
        {todos.map((todo, index) =&gt; (
          &lt;li key={index}&gt;{todo.title}&lt;/li&gt;
        ))}
      &lt;/ul&gt;
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-React-路由-V6"><a href="#5-React-路由-V6" class="headerlink" title="5. React 路由 V6"></a>5. React 路由 V6</h2><h3 id="5-1-客户端路由概述"><a href="#5-1-客户端路由概述" class="headerlink" title="5.1 客户端路由概述"></a>5.1 客户端路由概述</h3><p>在 Web 应用中，客户端路由就是导航，就是 URL 地址与页面之间的对应关系，可以实现点击不同的链接跳转到不同的页面。</p>
<p>传统 Web 应用的中的路由是由 a 标记实现的，通过 a 标记可以实现在不同的 HTML 文件之间进行跳转。</p>
<p>在 React 应用中，只有一个 HTML 文件，React 应用通过不同的组件模拟不同的页面，所以 React 应用中的路由要实现的是在不同的组件之间进行跳转。</p>
<img src="/medias/assets/images/41.png" align="left" width="50%">

<img src="/medias/assets/images/42.gif" align="left" width="45%">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-router-dom<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="5-2-基本使用"><a href="#5-2-基本使用" class="headerlink" title="5.2 基本使用"></a>5.2 基本使用</h3><p>需求：为应用创建首页和关于我们两个页面。</p>
<ol>
<li><p>创建页面级路由组件</p>
<p><code>src/pages/Home.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Home() {
  return &lt;div&gt;欢迎来到首页 🌶🌶🌶 &lt;/div&gt;;
}
export default Home;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/pages/News.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function News() {
  return &lt;div&gt;欢迎来到关于新闻页 😁😁😁&lt;/div&gt;;
}
export default News;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/pages/Error.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function Error() {
  return &lt;div&gt;页面走丢了 😭😭😭&lt;/div&gt;;
}
export default Error;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>配置路由规则</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { BrowserRouter, Routes, Route } from "react-router-dom";
import News from "./pages/News";
import Home from "./pages/Home";

function App() {
  // 注意: 在 v6 版本中，一旦路由规则匹配成功，则不再继续向后匹配，所以不再需要使用 exact 属性
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/" element={&lt;Home /&gt;} /&gt;
        &lt;Route path="/news" element={&lt;News /&gt;} /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>为应用添加用于跳转页面的链接地址</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Link } from "react-router-dom";

function App() {
  // 注意: react-router-dom 提供的组件都必须被 BrowserRouter 组件包裹, 包括 Link 组件
  return (
    &lt;BrowserRouter&gt;
      &lt;Link to="/"&gt;Home&lt;/Link&gt;
      &lt;Link to="/news"&gt;News&lt;/Link&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-3-NavLink-组件"><a href="#5-3-NavLink-组件" class="headerlink" title="5.3 NavLink 组件"></a>5.3 NavLink 组件</h3><p>Link 组件是用于生成普通链接的组件，导航链接应该使用 NavLink 组件，当前链接被激活时，链接元素身上会自动添加 active 激活类名。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;NavLink to="/"&gt;
  Home
&lt;/NavLink&gt;
&lt;NavLink to="/news"&gt;
  News
&lt;/NavLink&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以通过以下方式更改默认的激活类名。</p>
 <pre class="line-numbers language-react" data-language="react"><code class="language-react">const activeClassName = ({ isActive }) =&gt; (isActive ? "on" : "off");

&lt;NavLink to="/" className={activeClassName}&gt;
  Home
&lt;/NavLink&gt;
&lt;NavLink to="/about" className={activeClassName}&gt;
  News
&lt;/NavLink&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过同样的方式也可以为导航链接添加行内样式。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;NavLink to="/" style={({ isActive }) =&gt; ({ color: isActive ? "red" : "blue" })}&gt;
  Home
&lt;/NavLink&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="5-4-404-与-Navigate"><a href="#5-4-404-与-Navigate" class="headerlink" title="5.4 404 与 Navigate"></a>5.4 404 与 Navigate</h3><p>在路由规则配置的最后，可以使用 <code>*</code> 号匹配不存在的路由规则，匹配到以后可以指定表示 404 的页面组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Error from "./pages/Error";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="*" element={&lt;Error /&gt;} /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果不想展示 404，也可以将路由重定向到应用中已经存在的页面路由组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Navigate } from "react-router-dom";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="*" element={&lt;Navigate to="/" /&gt;} /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-5-嵌套路由"><a href="#5-5-嵌套路由" class="headerlink" title="5.5 嵌套路由"></a>5.5 嵌套路由</h3><p>嵌套路由可以理解为二级路由乃至三级路由. 就是在路由组件中还包含路由匹配组件。</p>
<img src="/medias/assets/images/40.png" align="left" width="55%">

<ol>
<li><p>配置新闻页面中的二级路由规则</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import News from "./pages/News";
import InnerNews from "./pages/InnerNews";
import OuterNews from "./pages/OuterNews";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/news" element={&lt;News /&gt;}&gt;
          &lt;Route path="inner" element={&lt;InnerNews /&gt;} /&gt;
          &lt;Route path="outer" element={&lt;OuterNews /&gt;} /&gt;
        &lt;/Route&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在一级路由页面组件 ( 新闻页面组件 ) 中放置路由插槽、配置跳转链接</p>
<p><code>src/pages/News.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { NavLink, Outlet } from "react-router-dom";

function News() {
  return (
    &lt;div&gt;
      &lt;p&gt;欢迎来到关于新闻页 😁😁😁&lt;/p&gt;
      &lt;NavLink to="/news/inner"&gt;国内新闻&lt;/NavLink&gt;
      &lt;NavLink to="/news/outer"&gt;国际新闻&lt;/NavLink&gt;
      &lt;Outlet /&gt;
    &lt;/div&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-6-索引路由"><a href="#5-6-索引路由" class="headerlink" title="5.6 索引路由"></a>5.6 索引路由</h3><p>通过索引路由可以指定默认显示的二级路由，比如上述案例中，当进入新闻页面时二级路由组件所在区域是空白的，该缺陷就可以通过索引路由补救。</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  // 注意: 索引路由不能有 path
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/news" element={&lt;News /&gt;}&gt;
          &lt;Route index element={&lt;InnerNews /&gt;} /&gt;
          &lt;Route path="inner" element={&lt;InnerNews /&gt;} /&gt;
          &lt;Route path="outer" element={&lt;OuterNews /&gt;} /&gt;
        &lt;/Route&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-7-编程式导航"><a href="#5-7-编程式导航" class="headerlink" title="5.7 编程式导航"></a>5.7 编程式导航</h3><p>通过事件的方式进行跳转。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useNavigate } from "react-router-dom";

function Home() {
  const navigate = useNavigate();
  return &lt;button onClick={() =&gt; navigate("/news")}&gt;News&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-8-路由参数"><a href="#5-8-路由参数" class="headerlink" title="5.8 路由参数"></a>5.8 路由参数</h3><p>通过路由参数可以实现在不同的页面组件之间跳转时携带数据。</p>
<p>比如在文章列表页面中，点击某一篇文章跳转到文章详情页面，此时就需要将被点击的那篇文章的 id 传递到文章详情页面。</p>
<p>在应用中会有很多篇文章，但是文章详情页面组件只有一个，可以将它理解为文章详情的模板页面，在跳转到这个模板页面时，需要将文章id传进来，在模板页面中需要通过 id 获取详情，从而展示详情数据。</p>
<ol>
<li><p>添加路由规则并指定跳转到该路由时需要传递参数</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Detail from "./pages/Detail";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/detail/:id" element={&lt;Detail /&gt;} /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在实现跳转的路由链接中传递参数</p>
<p><code>src/pages/Home.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Link } from "react-router-dom";

function Home() {
  return (
    &lt;ul&gt;
      &lt;li&gt;
        &lt;Link to="/detail/1"&gt;老旧小区改造, 这三区名单来了!&lt;/Link&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;Link to="/detail/2"&gt;穿鞋把脚放列车座位上, 韩总统候选人尹锡悦引发网友批..&lt;/Link&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在目标跳转页面组件接收路由参数</p>
<p><code>src/pages/Detail.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useParams } from "react-router-dom";

function Detail() {
  const { id } = useParams();
  return &lt;div&gt;Detail Page {id}&lt;/div&gt;;
}

export default Detail;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-9-查询参数"><a href="#5-9-查询参数" class="headerlink" title="5.9 查询参数"></a>5.9 查询参数</h3><ol>
<li><p>定义路由时不需要加路由参数占位符</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/detail" element={&lt;Detail /&gt;} /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在链接跳转时添加参数</p>
<p><code>src/pages/Home.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Link } from "react-router-dom";

function Home() {
  return (
    &lt;ul&gt;
      &lt;li&gt;
        &lt;Link to="/detail?id=1"&gt;老旧小区改造, 这三区名单来了!&lt;/Link&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;Link to="/detail?id=2"&gt;穿鞋把脚放列车座位上, 韩总统候选人尹锡悦引发网友批..&lt;/Link&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在目标跳转页面组件接收路由参数</p>
<p><code>src/pages/Detail.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useSearchParams } from "react-router-dom";

function Detail() {
  const [searchParams] = useSearchParams();
  return &lt;div&gt;Detail Page {searchParams.get("id")}&lt;/div&gt;;
}

export default Detail;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-10-路由组件懒加载"><a href="#5-10-路由组件懒加载" class="headerlink" title="5.10 路由组件懒加载"></a>5.10 路由组件懒加载</h3><p>默认情况下应用中所有的组件都被打包到了同一个文件中，就是说应用初始加载时就加载了所有的组件，这样会导致初始加载应用时间长用户体验差。</p>
<p>解决办法就是在打包应用时以页面组件为单位，将不同的页面组件打包到不同的文件中，初始加载时只加载用户访问的页面组件。</p>
<ol>
<li><p>通过 lazy, import 异步加载组件</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { lazy } from 'react';

const Home = lazy(() =&gt; import(/* webpackChunkName: "Home" */ "./pages/Home"));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通过 import 方法动态导入模块时，webpack 会将导入的模块拆分成单独的文件。</p>
<p>webpackChunkName 定义拆分文件名称。</p>
</li>
<li><p>在调用异步加载的组件时，组件的外面必须包裹 Suspense 组件，通过 Suspense 组件可以指定组件加载过程中的等待 UI。</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Suspense } from "react";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route
          path="/"
          element={
            &lt;Suspense fallback={&lt;div&gt;loading...&lt;/div&gt;}&gt;
              &lt;Home /&gt;
            &lt;/Suspense&gt;
          }
        /&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>封装 Loadable 组件以复用 Suspense 组件</p>
<p><code>src/common/Loadable.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Suspense } from "react";

function Loadable(Component) {
  return function (props) {
    return (
      &lt;Suspense fallback={&lt;div&gt;loading...&lt;/div&gt;}&gt;
        &lt;Component {...props} /&gt;
      &lt;/Suspense&gt;
    );
  };
}

export default Loadable;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Loadable from "./pages/Loadable";

const Home = Loadable(
  lazy(() =&gt; import(/* webpackChunkName: "Home" */ "./pages/Home"))
);

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/" element={&lt;Home /&gt;}/&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-11-路由守卫-单路由守卫"><a href="#5-11-路由守卫-单路由守卫" class="headerlink" title="5.11 路由守卫 单路由守卫"></a>5.11 路由守卫 单路由守卫</h3><p>当用户去访问那些需要鉴权以后才能进入的路由组件时，需要先通过路由守卫对其进行鉴权，只有通过才允许用户进入，否则进行重定向。</p>
<ol>
<li><p>定义执行鉴权的钩子函数供路由守卫进行使用</p>
<p><code>src/common/useAuth.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect, useState } from "react";

function isAuth() {
  // 模拟鉴权成功
  return Promise.resolve();
  // 模拟鉴权失败
  // return Promise.reject();
}

function useAuth() {
  // 用于存储鉴权结果
  // true 成功
  // false 失败 (默认值)
  const [auth, setAuth] = useState(false);
  // 用于存储异步状态
  // true 等待 (默认值)
  // false 结束
  const [loading, setLoading] = useState(true);
  useEffect(() =&gt; {
    // 开始鉴权
    isAuth()
      // 成功
      .then(() =&gt; setAuth(true))
      // 失败
      .catch(() =&gt; setAuth(false))
      // 不管成功还是失败, 都将异步状态更新为结束
      .finally(() =&gt; setLoading(false));
  }, []);
  // 返回异步状态和鉴权结果
  return { loading, auth };
}

export default useAuth;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>创建用于实现身份验证的路由守卫组件</p>
<p><code>src/common/AuthGuard.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Navigate } from "react-router-dom";
import useAuth from "../hooks/useAuth";

function AuthGuard({ children }) {
  // 调用鉴权钩子, 获取异步状态及鉴权结果
  const { auth, loading } = useAuth();
  // 如果异步状态为等待, 渲染等待过程中的UI界面
  if (loading) return &lt;div&gt;loading...&lt;/div&gt;;
  // 判断鉴权结果, 如果通过, 进入目标路由组件, 如果没通过, 重定向到执行授权的页面
  return auth ? children : &lt;Navigate to="/login" /&gt;;
}

export default AuthGuard;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>对 Admin 组件，即需要鉴权以后才能访问的页面路由组件进行守卫</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import AuthGuard from "./common/AuthGuard";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/admin" element={&lt;AuthGuard&gt;&lt;Admin /&gt;&lt;/AuthGuard&gt;}/&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="5-12-路由守卫-多路由守卫"><a href="#5-12-路由守卫-多路由守卫" class="headerlink" title="5.12 路由守卫 多路由守卫"></a>5.12 路由守卫 多路由守卫</h3><p>通过 Outlet 路由插座组件可以实现多路由守卫。</p>
<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Admin from "./pages/Admin";
import AuthGuardOutlet from "./common/AuthGuardOutlet";

function App() {
  return (
    &lt;BrowserRouter&gt;
        &lt;Route path="/admin" element={&lt;AuthGuardOutlet /&gt;}&gt;
          &lt;Route path="" element={&lt;Admin /&gt;} /&gt;
        &lt;/Route&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/common/AuthGuardOutlet.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Navigate, Outlet } from "react-router-dom";
import useAuth from "../hooks/useAuth";

function AuthGuardOutlet() {
  // 调用鉴权钩子, 获取异步状态及鉴权结果
  const { auth, loading } = useAuth();
  // 如果异步状态为等待, 渲染等待过程中的UI界面
  if (loading) return &lt;div&gt;loading...&lt;/div&gt;;
  // 判断鉴权结果, 如果通过, 渲染路由插座组件, 让 children 组件能够渲染到插座组件中
  // 如果没通过, 重定向到执行授权的页面
  return auth ? &lt;Outlet /&gt; : &lt;Navigate to="/login" /&gt;;
}

export default AuthGuardOutlet;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-13-滚动行为修正"><a href="#5-13-滚动行为修正" class="headerlink" title="5.13 滚动行为修正"></a>5.13 滚动行为修正</h3><p>问题：在 A 页面中将页面滚动到底部，切换到 B 页面，此时滚动条仍处于 A 页面的位置。</p>
<p>解决问题的方式就是监听路由切换行为，当路由发生切换行为时，让页面自动回到顶部。</p>
<p><code>src/common/ScrollTop.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useEffect } from "react";
import { useLocation } from "react-router-dom";

function ScrollTop() {
  const { pathname } = useLocation();
  useEffect(() =&gt; {
    window.scrollTo(0, 0);
  }, [pathname]);
  return null;
}

export default ScrollTop;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ScrollTop from "./common/ScrollTop";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;ScrollTop /&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-14-useRoutes"><a href="#5-14-useRoutes" class="headerlink" title="5.14 useRoutes"></a>5.14 useRoutes</h3><p>通过 useRoutes 钩子函数可以实现通过 JavaScript 配置对象的方式定义路由规则。</p>
<p><code>src/AppRoute.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRoutes } from "react-router-dom";
import Home from "./pages/Home";
import InnerNews from "./pages/InnerNews";
import News from "./pages/News";
import OuterNews from "./pages/OuterNews";

const routes = [
  { path: "/", element: &lt;Home /&gt; },
  {
    path: "/news",
    element: &lt;News /&gt;,
    children: [
      { path: "inner", element: &lt;InnerNews /&gt; },
      { path: "outer", element: &lt;OuterNews /&gt; },
    ],
  },
]

function AppRoute() {
  let element = useRoutes(routes);
  return element;
}

export default AppRoute;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>src/App.js</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { BrowserRouter } from "react-router-dom";
import AppRoute from "./AppRoute";

function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;AppRoute /&gt;
    &lt;/BrowserRouter&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-15-嵌套路由与布局组件"><a href="#5-15-嵌套路由与布局组件" class="headerlink" title="5.15 嵌套路由与布局组件"></a>5.15 嵌套路由与布局组件</h3><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/App.js
import { BrowserRouter, Route, Routes } from "react-router-dom";
import AdminHome from "./admin/AdminHome";
import AdminLayout from "./admin/AdminLayout";
import Layout from "./components/Layout";
import About from "./pages/About";
import Home from "./pages/Home";

export default  function App() {
  return (
    &lt;BrowserRouter&gt;
      &lt;Routes&gt;
        &lt;Route path="/" element={&lt;Layout /&gt;}&gt;
          &lt;Route path="" element={&lt;Home /&gt;} /&gt;
          &lt;Route path="/about" element={&lt;About /&gt;} /&gt;
        &lt;/Route&gt;
        &lt;Route path="/admin" element={&lt;AdminLayout /&gt;}&gt;
          &lt;Route path="" element={&lt;AdminHome /&gt;} /&gt;
        &lt;/Route&gt;
      &lt;/Routes&gt;
    &lt;/BrowserRouter&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Header from "./Header";
import Footer from "./Footer";
import { Outlet } from "react-router-dom";

export default function Layout() {
  return (
    &lt;&gt;
      &lt;Header /&gt;
      &lt;Outlet /&gt;
      &lt;Footer /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="6-服务端渲染"><a href="#6-服务端渲染" class="headerlink" title="6. 服务端渲染"></a>6. 服务端渲染</h2><h3 id="6-1-概述"><a href="#6-1-概述" class="headerlink" title="6.1 概述"></a>6.1 概述</h3><h4 id="6-1-1-渲染概述"><a href="#6-1-1-渲染概述" class="headerlink" title="6.1.1 渲染概述"></a>6.1.1 渲染概述</h4><h5 id="1-服务端渲染-SSR"><a href="#1-服务端渲染-SSR" class="headerlink" title="1. 服务端渲染 SSR"></a>1. 服务端渲染 SSR</h5><p>服务端渲染 ( server-side rendering ) 是指数据和 HTML 模板在服务端进行拼接，完成拼接后再发送到客户端进行解析。</p>
<img src="/medias/assets/next/02.png">

<h5 id="2-客户端渲染-CSR"><a href="#2-客户端渲染-CSR" class="headerlink" title="2. 客户端渲染 CSR"></a>2. 客户端渲染 CSR</h5><p>客户端渲染 ( client-side rendering ) 是指数据和 HTML 模板在客户端浏览器中进行拼接，拼接完成后再追加到 DOM 树中供浏览器解析。</p>
<img src="/medias/assets/images/csr.png">

<h5 id="3-静态生成-SSG"><a href="#3-静态生成-SSG" class="headerlink" title="3. 静态生成 SSG"></a>3. 静态生成 SSG</h5><p>静态站点生成 ( static stie generation ) 是指在站点构建阶段进行数据和HTML模板的拼接并生成对应的静态的 HTML 页面。</p>
<h4 id="6-1-2-渲染发展史"><a href="#6-1-2-渲染发展史" class="headerlink" title="6.1.2 渲染发展史"></a>6.1.2 渲染发展史</h4><h5 id="1-传统意义上的服务器端渲染"><a href="#1-传统意义上的服务器端渲染" class="headerlink" title="1. 传统意义上的服务器端渲染"></a>1. 传统意义上的服务器端渲染</h5><p>传统意义上的服务器端渲染存在的问题主要是用户体验差：</p>
<ol>
<li>在网速比较慢的情况下，页面长时间处于白屏状态，用于等待时易产生焦虑。</li>
<li>每次页面跳转都会重新加载整个页面体验差。</li>
</ol>
<h5 id="2-基于前端框架的客端户渲染"><a href="#2-基于前端框架的客端户渲染" class="headerlink" title="2. 基于前端框架的客端户渲染"></a>2. 基于前端框架的客端户渲染</h5><p>基于前端框架的客户端渲染虽然解决了传统服务端渲染用户体验差的问题，但也随之带来了新的问题：</p>
<p>客户端渲染不支持 SEO，导致页面很难被搜索引擎收录。</p>
<h5 id="3-基于前端框架的服务端渲染"><a href="#3-基于前端框架的服务端渲染" class="headerlink" title="3. 基于前端框架的服务端渲染"></a>3. 基于前端框架的服务端渲染</h5><p>基于前端框架的服务端渲染解决了用户体验差的问题，也解决了 SEO 支持不友好的问题。</p>
<p>缺点是数据和HTML模板在服务端进行，访问速度还是会受一些影响，而且服务端只能使用 JavaScript 运行时。</p>
<h5 id="4-基于静态生成的服务端渲染"><a href="#4-基于静态生成的服务端渲染" class="headerlink" title="4. 基于静态生成的服务端渲染"></a>4. 基于静态生成的服务端渲染</h5><p>基于静态生成的服务端渲染在访问速度上是最具有优势的，也不存在 SEO 支持不友好的问题。</p>
<p>但是它只适用于页面内容不会发生频繁变化的场景，比如企宣，商城，博客，新闻等。</p>
<h3 id="6-2-Next-js"><a href="#6-2-Next-js" class="headerlink" title="6.2 Next.js"></a>6.2 Next.js</h3><h4 id="6-2-1-概述"><a href="#6-2-1-概述" class="headerlink" title="6.2.1 概述"></a>6.2.1 概述</h4><p><a target="_blank" rel="noopener" href="https://nextjs.org/">Next.js</a> 是集成式 React 服务端渲染应用框架，用于构建 SEO 友好的 SPA 应用。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 全局安装 next.js 脚手架工具</span>
<span class="token function">npm</span> <span class="token function">install</span> -g create-next-app
<span class="token comment"># 创建 next.js 应用</span>
create-next-app next-tutorial
<span class="token comment"># 启动开发服务器</span>
<span class="token function">npm</span> run dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-2-基于文件系统的路由"><a href="#6-2-2-基于文件系统的路由" class="headerlink" title="6.2.2 基于文件系统的路由"></a>6.2.2 基于文件系统的路由</h4><h5 id="1-路由匹配"><a href="#1-路由匹配" class="headerlink" title="1. 路由匹配"></a>1. 路由匹配</h5><p>在 Next.js 中，页面是存储在 pages 文件中的 React 组件，组件文件名称与路由相关联。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/index.js ====&gt; http://localhost:3000/
export default function Home() {
  return &lt;div&gt;首页&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/about.js ====&gt; http://localhost:3000/about
export default function About() {
  return &lt;div&gt;关于我们&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/post/index.js ====&gt; http://localhost:3000/post
export default function Post() {
  return &lt;div&gt;这是博客索引目录&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/blog/first-blog.js ====&gt; http://localhost:3000/blog/first-post
export default function FirstPost () {
  return &lt;div&gt;这是我的第一篇博客文章&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/post/[pid].js ====&gt; http://localhost:3000/post/1
import { useRouter } from "next/router";

export default function Post() {
  const router = useRouter(); // routter.query ====&gt; {"pid": "1"}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/post/[pid].js ====&gt; http://localhost:3000/post/1?name=zhangsan
import { useRouter } from "next/router";

export default function Post() {
  const router = useRouter(); // routter.query ====&gt; {"pid": "1", "name": "张三"}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/order/[uid]/[status].js ====&gt; http://localhost:3000/order/2/all
import { useRouter } from "next/router";

export default function Orders() {
  const router = useRouter(); // router.query ====&gt; {"uid": "2", "status": "all"}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/404.js ====&gt; 自定义404页面
export default function NotFound() {
  return &lt;div&gt;这是自定义的404页面&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-路由跳转"><a href="#2-路由跳转" class="headerlink" title="2. 路由跳转"></a>2. 路由跳转</h5><p>Link 组件默认进行客户端路由跳转，如果浏览器中 JavaScript 被禁用则使用链接进行服务端路由跳转。</p>
<p>Link 组件中不应添加除 href 属性以外的属性，其余属性添加到 a 标签上，比如 title、onClick。</p>
<p>Link 组件通过预取(在生产中)功能自动优化应用程序以获得最佳性能。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Link from "next/link";

export default function Home() {
  return (
    &lt;Link href="/about"&gt;
      &lt;a title="关于我们"&gt;关于我们&lt;/a&gt;
    &lt;/Link&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Link from "next/link";

const posts = [
  { id: 1, title: "这是id为1的文章" },
  { id: 2, title: "这是id为2的文章" },
];

export default function Post() {
  return (
    &lt;ul&gt;
      {posts.map((post) =&gt; (
        &lt;li key={post.id}&gt;
          &lt;Link href={`/post/${post.id}`}&gt;
            &lt;a&gt;{post.title}&lt;/a&gt;
          &lt;/Link&gt;
        &lt;/li&gt;
      ))}
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Link from "next/link";

const posts = [
  { id: 1, title: "这是id为1的文章" },
  { id: 2, title: "这是id为2的文章" },
];

export default function Post() {
  return (
    &lt;ul&gt;
      {posts.map((post) =&gt; (
        &lt;li key={post.id}&gt;
          &lt;Link href={{ pathname: "/post/[pid]", query: { pid: post.id } }}&gt;
            &lt;a&gt;{post.title}&lt;/a&gt;
          &lt;/Link&gt;
        &lt;/li&gt;
      ))}
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useRouter } from "next/router";

export default function Home() {
  const router = useRouter();
  return &lt;button onClick={() =&gt; router.push("/about")}&gt;关于我们&lt;/button&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Link from "next/link";

export default function Home() {
  const onClickHandler = (event) =&gt; {
    alert("clicked");
    event.preventDefault();
  };
  return (
    &lt;Link href="/about"&gt;
      &lt;a onClick={onClickHandler}&gt;关于我们&lt;/a&gt;
    &lt;/Link&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-3-API-路由"><a href="#6-2-3-API-路由" class="headerlink" title="6.2.3 API 路由"></a>6.2.3 API 路由</h4><p>通过 API 路由开发者可以为<strong>客户端</strong>应用提供 API 接口。</p>
<p>API 路由是服务端应用程序，代码将会被打包到服务端应用程序，它不会增加客户端打包文件的体积。</p>
<h5 id="1-基本使用-1"><a href="#1-基本使用-1" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// pages/api/index.js ====&gt; http://localhost:3000/api</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// req: 请求对象</span>
  <span class="token comment">// res: 响应对象</span>
  <span class="token comment">// 对客户端进行响应</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"API Route is running"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// pages/api/posts/index.js</span>
<span class="token comment">// 获取文章列表: GET  http://localhost:3000/api/posts</span>
<span class="token comment">// 添加文章:    POST  http://localhost:3000/api/posts</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"客户端在获取文章列表"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"客户端在添加文章"</span><span class="token punctuation">,</span> body<span class="token operator">:</span> req<span class="token punctuation">.</span>body <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">"API 不存在"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// pages/api/posts/[pid].js</span>
<span class="token comment">// 根据pid获取文章: GET     http://localhost:3000/api/post/12</span>
<span class="token comment">// 根据pid删除文章: DELETE  http://localhost:3000/api/post/12</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"客户端在根据pid获取文章"</span><span class="token punctuation">,</span> pid<span class="token operator">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pid <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"客户端在根据pid删除文章"</span><span class="token punctuation">,</span> pid<span class="token operator">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pid <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// pages/api/posts/[...pids].js </span>
<span class="token comment">// 根据pid批量删除文章: DELETE http://localhost:3000/api/posts/2/3</span>
<span class="token comment">// [pid].js 的匹配优先级高于 [...pid].js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"DELETE"</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> msg<span class="token operator">:</span> <span class="token string">"客户端在根据pid批量删除文章"</span><span class="token punctuation">,</span> pid<span class="token operator">:</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pid <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-连接数据库"><a href="#2-连接数据库" class="headerlink" title="2. 连接数据库"></a>2. 连接数据库</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// services/dbConnection.js</span>
<span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">"mongoose"</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">dbConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断数据库是否已经连接过, 如果已经连接过, 不再重复连接</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果数据库没有连接过, 链接数据库</span>
  <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"mongodb://localhost:27017/test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> dbConnect<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// models/Post.js</span>
<span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">"mongoose"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> PostSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"标题不能为空"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    maxlength<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">"标题不能超过40个字符"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  description<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    maxlength<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"描述不能超过200个字符"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Post <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>models<span class="token punctuation">.</span>Post <span class="token operator">||</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"Post"</span><span class="token punctuation">,</span> PostSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Post<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// pages/api/posts/index.js</span>
<span class="token keyword">import</span> Post <span class="token keyword">from</span> <span class="token string">"@/models/Post"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> dbConnect <span class="token keyword">from</span> <span class="token string">"@/services/dbConnection"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">dbConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"GET"</span><span class="token operator">:</span>
      <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> posts <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">"POST"</span><span class="token operator">:</span>
      <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> post <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token string">"api 不存在"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// jsconfig.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"baseUrl"</span><span class="token operator">:</span> <span class="token string">"."</span><span class="token punctuation">,</span>
    <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"@/models/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"models/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"@/services/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"services/*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-4-预渲染"><a href="#6-2-4-预渲染" class="headerlink" title="6.2.4 预渲染"></a>6.2.4 预渲染</h4><p>预渲染是指在构建阶段对应用程序进行编译，编译结果就是静态的 HTML 文件。</p>
<p>当客户端向服务端发送请求后，服务端直接将应用构建时编译的 HTML 文件发送到客户端。</p>
<p>默认情况下，如果组件不通过请求获取外部数据，Next.js 会在构建阶段将其编译为静态 HTML 文件。</p>
<p>预渲染适用于页面内容不会发生频繁变化的场景，比如博客、新闻、电商前台、文档、营销页面等。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default function About() {
  return &lt;div&gt;About&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="1-基于页面组件的预渲染"><a href="#1-基于页面组件的预渲染" class="headerlink" title="1. 基于页面组件的预渲染"></a>1. 基于页面组件的预渲染</h5><p>在构建阶段如果组件需要获取外部数据，在组件中要导出名为 getStaticProps 的异步方法，通过它返回组件所需数据，它会在应用的构建阶段执行。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";

export default function Posts({ posts }) {
  return (
    &lt;ul&gt;
      {posts.map((post) =&gt; (
        &lt;li key={post.id}&gt;{post.title}&lt;/li&gt;
      ))}
    &lt;/ul&gt;
  );
}

export async function getStaticProps() {
  let { data } = await axios.get("https://jsonplaceholder.typicode.com/posts");
  return {
    props: {
      posts: data,
    },
  };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-基于动态路由的预渲染"><a href="#2-基于动态路由的预渲染" class="headerlink" title="2. 基于动态路由的预渲染"></a>2. 基于动态路由的预渲染</h5><p>基于动态路由的预渲染是指根据路由动态参数编译 HTML 静态文件。</p>
<p>该路由拥有多少参数就会编译出多少静态 HTML 文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -g json-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"todos"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"吃饭"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"睡觉"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"打豆豆"</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">json-server db.json -p <span class="token number">3001</span> -w<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/todos/[id].js
import axios from "axios";
import { useRouter } from "next/router";

export default function Todo({ todo }) {
  const router = useRouter();
  if (router.isFallback) return &lt;div&gt;Loading...&lt;/div&gt;;
  return (
    &lt;div&gt;
      {todo.id} {todo.title}
    &lt;/div&gt;
  );
}

// 第一步: 在构建时先获取所有路由参数
export async function getStaticPaths() {
  return {
    paths: [
      {
        params: { id: "1" },
      },
      {
        params: { id: "2" },
      },
    ],
    // false 当访问没有被预渲染的路径时展示404页面
    // true: 当访问没有被预渲染的路径时, 先展示后备UI, Next.js 会在客户端请求时进行预渲染, 完后后显示预渲染结果
    fallback: true,
  };
}

// 第二步: 根据路由参数编译静态 HTML 文件
// 在构建时 Next 先调用 getStaticPaths 方法获取所有路由参数
// 遍历路由参数, 不断调用 getStaticProps 方法编译静态HTML文件
export async function getStaticProps({ params }) {
  let response = await axios.get(`http://localhost:3001/todos/${params.id}`);
  await delay(2000);
  return {
    props: {
      todo: response.data,
    },
    // 设置当前页面缓存的过期时间
    // 当前页面被访问时, 如果缓存时间过期, 触发当前页面的重新预渲染
    // 当次访问用户看到的仍然是缓存页面, 当重新预渲染完成后, 下次用户访问时看到的就是新页面了
    revalidate: 10,
  };
}

function delay(time) {
  return new Promise((resolve) =&gt; setTimeout(resolve, time));
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-5-服务端渲染"><a href="#6-2-5-服务端渲染" class="headerlink" title="6.2.5 服务端渲染"></a>6.2.5 服务端渲染</h4><p>服务端渲染是指在客户端发送请求时，服务器端即时编译 HTML，编译完成后将 HTML 代码发送到客户端。</p>
<p>服务端渲染方式适用于页面内容频繁发生变化场景且需要 SEO 的场景。</p>
<p>getServerSideProps 方法在服务端执行，内部可以调用 API 路由，也可以直接查询数据库。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Post from "@/models/Post";

export default function Posts({ posts }) {
  return (
    &lt;ul&gt;
      {posts.map((post, index) =&gt; (
        &lt;li key={index}&gt;
          &lt;h1&gt;{post.title}&lt;/h1&gt;
          &lt;p&gt;{post.description}&lt;/p&gt;
        &lt;/li&gt;
      ))}
    &lt;/ul&gt;
  );
}

export async function getServerSideProps() {
  const posts = await Post.find({});
  return {
    props: {
      posts: JSON.parse(JSON.stringify(posts)),
    },
  };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-6-混合渲染"><a href="#6-2-6-混合渲染" class="headerlink" title="6.2.6 混合渲染"></a>6.2.6 混合渲染</h4><p>混合渲染是指客户端渲染和服务端渲染、客户端渲染和预渲染可以混合使用。</p>
<p>比如文章详情页面，文章内容不会经常变化可以使用预渲染，而文章评论需要实时更新可以使用客户端渲染。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/api/comments/index.js
export default function comments(req, res) {
  res.send([
    { id: 1, content: "评论1" },
    { id: 2, content: "评论2" },
  ]);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios";
import { useState, useEffect } from "react";

export default function Posts({ posts }) {
  const [comments, setComments] = useState([]);
  useEffect(() =&gt; {
    axios.get("http://localhost:3000/api/comments").then((response) =&gt; {
      setComments(response.data);
    });
  }, []);
  return (
    &lt;&gt;
      {/* 预渲染部分开始 */}
      &lt;ul&gt;
        {posts.map((post, index) =&gt; (
          &lt;li key={index}&gt;
            &lt;h1&gt;{post.title}&lt;/h1&gt;
            &lt;p&gt;{post.description}&lt;/p&gt;
          &lt;/li&gt;
        ))}
      &lt;/ul&gt;
      {/* 预渲染部分结束 */}
      {/* 动态渲染部分开始 */}
      &lt;ul&gt;
        {comments.map((comment) =&gt; (
          &lt;li key={comment.id}&gt;{comment.content}&lt;/li&gt;
        ))}
      &lt;/ul&gt;
      {/* 动态渲染部分结束 */}
    &lt;/&gt;
  );
}

export async function getStaticProps() {
  let response = await axios.get("http://localhost:3000/api/posts");
  return {
    props: {
      posts: response.data.posts,
    },
  };
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-7-为应用添加样式"><a href="#6-2-7-为应用添加样式" class="headerlink" title="6.2.7 为应用添加样式"></a>6.2.7 为应用添加样式</h4><p>Next.js 推荐将所有样式表文件存储在 styles 目录中。</p>
<h5 id="1-全局样式"><a href="#1-全局样式" class="headerlink" title="1. 全局样式"></a>1. 全局样式</h5><p>全局样式表应该在 _app.js 文件中被导入。</p>
<p>_app.js 文件中存储的是应用程序根组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/_app.js
import "../styles/globals.css";

function MyApp({ Component, pageProps }) {
  return &lt;Component {...pageProps} /&gt;;
}

export default MyApp;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-组件级样式"><a href="#2-组件级样式" class="headerlink" title="2. 组件级样式"></a>2. 组件级样式</h5><pre class="line-numbers language-react" data-language="react"><code class="language-react">import styles from '../styles/Home.module.css'

export default function Home() {
  return &lt;div className={styles.container}&gt;&lt;/div&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-8-布局组件"><a href="#6-2-8-布局组件" class="headerlink" title="6.2.8 布局组件"></a>6.2.8 布局组件</h4><h5 id="1-情况一"><a href="#1-情况一" class="headerlink" title="1. 情况一"></a>1. 情况一</h5><p>应用中的每一个页面都有公共组件，且都是相同的公共组件，此时可以在根组件中使用布局组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// components/Header.js
export default function Header() {
  return &lt;div&gt;Header&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// components/Footer.js
export default  function Footer() {
  return &lt;div&gt;Footer&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// components/Layout.js
import Footer from "./Footer";
import Header from "./Header";

export default function Layout({ children }) {
  return (
    &lt;&gt;
      &lt;Header /&gt;
      {children}
      &lt;Footer /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/_app.js
import Layout from "../components/Layout";

export default function MyApp({ Component, pageProps }) {
  return (
    &lt;Layout&gt;
      &lt;Component {...pageProps} /&gt;
    &lt;/Layout&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-情况二"><a href="#2-情况二" class="headerlink" title="2. 情况二"></a>2. 情况二</h5><p>应用中的页面有公共组件，但不是每一个页面都有相同的公共组件。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/about.js
import Layout from "../components/Layout";

export default function About() {
  return (
    &lt;Layout&gt;
      &lt;div&gt;About&lt;/div&gt;
    &lt;/Layout&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-9-Head-组件"><a href="#6-2-9-Head-组件" class="headerlink" title="6.2.9 Head 组件"></a>6.2.9 Head 组件</h4><p>通过 Head 组件可以为不同的页面设置不同的头信息，比如标题、描述、关键字等信息。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// pages/about.js
import Head from "next/head";

export default function about() {
  return (
    &lt;Head&gt;
      &lt;title&gt;关于我们&lt;/title&gt;
      &lt;meta name="description" content="关于我们页面的描述内容" /&gt;
    &lt;/Head&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个页面中公共的头信息可以放在 _app.js 文件中。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Head from "next/head";

export default function MyApp({ Component, pageProps }) {
  return (
    &lt;&gt;
      &lt;Head&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
      &lt;/Head&gt;
      &lt;Component {...pageProps} /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-10-Image-组件"><a href="#6-2-10-Image-组件" class="headerlink" title="6.2.10 Image 组件"></a>6.2.10 Image 组件</h4><p>使用 Image 组件加载图片可以优化图像体积、格式、图片懒加载。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import Image from "next/image";

export default function about() {
  return (
    &lt;&gt;
      {[1, 2, 3, 4, 5].map((path) =&gt; (
        &lt;div key={path}&gt;
          &lt;Image alt="" src={`/${path}.jpg`} width="280" height="420" /&gt;
        &lt;/div&gt;
      ))}
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-2-11-环境变量"><a href="#6-2-11-环境变量" class="headerlink" title="6.2.11 环境变量"></a>6.2.11 环境变量</h4><p>Next.js 内置对环境变量的支持。</p>
<table>
<thead>
<tr>
<th>文件名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>.env</td>
<td>放置开发环境和生产环境中的公共变量</td>
</tr>
<tr>
<td>.env.development</td>
<td>放置开发环境变量，优先级高于 .env 文件</td>
</tr>
<tr>
<td>.env.production</td>
<td>放置生产环境变量，优先级高于 .env 文件</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># .env.development</span>
<span class="token assign-left variable">API_URL</span><span class="token operator">=</span>api.development.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># .env.production</span>
<span class="token assign-left variable">API_URL</span><span class="token operator">=</span>api.production.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 普通环境变量只在 Node.js 环境下起作用 ( API Route、getStaticProps、getServerSideProps )</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_URL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>要在浏览器中使用环境变量，需要在环境变量的名字前面加 NEXT_PUBLIC_ 前缀</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># .env.development</span>
<span class="token assign-left variable">NEXT_PUBLIC_API_URL</span><span class="token operator">=</span>api.production.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在存储环境变量的文件中可以使用 $ 开头的变量指向系统环境变量，它用于指向系统中存储的敏感信息</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># .env.development</span>
<span class="token assign-left variable">SECRET_KEY</span><span class="token operator">=</span><span class="token variable">$SECRET</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ~/.zshrc</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SECRET</span><span class="token operator">=</span>test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="6-2-12-构建命令"><a href="#6-2-12-构建命令" class="headerlink" title="6.2.12 构建命令"></a>6.2.12 构建命令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 构建生成环境代码</span>
next build
<span class="token comment"># 启动用于生产的支持预渲染和服务端渲染的 node.js 服务器 (基于 next build 结果)</span>
next start
<span class="token comment"># 启动开发环境的 node.js 服务器</span>
next dev
<span class="token comment"># 将站点导出为静态HTML (基于 next build 结果)</span>
<span class="token comment"># 不支持图片优化、api 路由</span>
next <span class="token builtin class-name">export</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-3-服务器端渲染原理"><a href="#6-3-服务器端渲染原理" class="headerlink" title="6.3 服务器端渲染原理"></a>6.3 服务器端渲染原理</h3><h4 id="1-应用目录结构介绍"><a href="#1-应用目录结构介绍" class="headerlink" title="1. 应用目录结构介绍"></a>1. 应用目录结构介绍</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">├── build
├── public
├── src
│   ├── client
│   ├── server
│   └── shared
├── package-lock.json
├── package.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 根据已有项目工程文件下载项目依赖</span>
<span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="2-创建-web-服务器"><a href="#2-创建-web-服务器" class="headerlink" title="2. 创建 web 服务器"></a>2. 创建 web 服务器</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/server/http.js</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">"express"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务器启动成功, 监听3000端口"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> app<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-服务器端渲染应用首页"><a href="#3-服务器端渲染应用首页" class="headerlink" title="3. 服务器端渲染应用首页"></a>3. 服务器端渲染应用首页</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/pages/Home.js
import React from "react";

export default function Home() {
  return &lt;div&gt;HomePage works&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/index.js
import app from "./http";
import Home from "../shared/pages/Home";
import { renderToString } from "react-dom/server";
import React from "react";

app.get("/", (req, res) =&gt; {
  // 通过 renderToString 方法将 React 组件转换为 HTML 字符串
  const content = renderToString(&lt;Home /&gt;);
  res.send(`
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;React 服务器端渲染&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id="root"&gt;${content}&lt;/div&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  `);
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4-服务端代码打包配置"><a href="#4-服务端代码打包配置" class="headerlink" title="4. 服务端代码打包配置"></a>4. 服务端代码打包配置</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">"./src/server/index.js"</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"build"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">"bundle.js"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">"babel-loader"</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span> <span class="token string">"@babel/preset-react"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"dev:server-run"</span><span class="token operator">:</span> <span class="token string">"nodemon --watch build --exec 'node build/bundle.js'"</span><span class="token punctuation">,</span>
  <span class="token property">"dev:server-build"</span><span class="token operator">:</span> <span class="token string">"webpack --config webpack.server.js --watch"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5-为组件附加事件"><a href="#5-为组件附加事件" class="headerlink" title="5. 为组件附加事件"></a>5. 为组件附加事件</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/pages/Home.js
import React from "react";

export default function Home() {
  return &lt;div onClick={() =&gt; alert("clicked")}&gt;HomePage works&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="6-创建客户端入口文件"><a href="#6-创建客户端入口文件" class="headerlink" title="6. 创建客户端入口文件"></a>6. 创建客户端入口文件</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/client/index.js
import React from "react";
import ReactDOM from "react-dom";
import Home from "../shared/pages/Home";

// hydrate: 渲染组件, 和 render 不同, 如果组件DOM结构已经存在, 复用DOM结构, 提升性能, 仅为组件附加事件
ReactDOM.hydrate(&lt;Home /&gt;, document.getElementById("root"));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="7-客户端代码打包配置"><a href="#7-客户端代码打包配置" class="headerlink" title="7. 客户端代码打包配置"></a>7. 客户端代码打包配置</h4><p>打包目标：转换 JSX 语法，转换浏览器不识别的现代 JavaScript 语法</p>
<p>打包位置：public 文件夹，它是服务端的静态资源文件夹</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.client.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">"./src/client/index.js"</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"public"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">"bundle.js"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">"babel-loader"</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span> <span class="token string">"@babel/preset-react"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-加载客户端打包代码"><a href="#8-加载客户端打包代码" class="headerlink" title="8. 加载客户端打包代码"></a>8. 加载客户端打包代码</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import express from "express";
// 将 public 目录设置为静态资源目录
app.use(express.static("public"));

app.get("/", (req, res) =&gt; {
  const content = renderToString(&lt;Home /&gt;);
  res.send(`
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;React 服务器端渲染&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id="root"&gt;${content}&lt;/div&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  `);
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="9-合并-webpack-配置"><a href="#9-合并-webpack-配置" class="headerlink" title="9. 合并 webpack 配置"></a>9. 合并 webpack 配置</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.base.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">{</span>
          loader<span class="token operator">:</span> <span class="token string">"babel-loader"</span><span class="token punctuation">,</span>
          options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span> <span class="token string">"@babel/preset-react"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.client.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack-merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./webpack.base"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">"./src/client/index.js"</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"public"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">"bundle.js"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack-merge"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./webpack.base"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  target<span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token string">"./src/server/index.js"</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"build"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">"bundle.js"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="10-合并应用启动命令"><a href="#10-合并应用启动命令" class="headerlink" title="10. 合并应用启动命令"></a>10. 合并应用启动命令</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"npm-run-all --parallel dev:*"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="11-独立渲染方法"><a href="#11-独立渲染方法" class="headerlink" title="11. 独立渲染方法"></a>11. 独立渲染方法</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/render.js
import { renderToString } from "react-dom/server";
import React from "react";
import Home from "../shared/pages/Home";

export default () =&gt; {
  const content = renderToString(&lt;Home /&gt;);
  return `
    &lt;html&gt;
      &lt;head&gt;
        &lt;title&gt;React 服务器端渲染&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
        &lt;div id="root"&gt;${content}&lt;/div&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  `;
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/index.js
import app from "./http";
import express from "express";
import render from "./render";

app.use(express.static("public"));

app.get("/", (req, res) =&gt; {
  res.send(render());
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="12-实现服务端路由"><a href="#12-实现服务端路由" class="headerlink" title="12. 实现服务端路由"></a>12. 实现服务端路由</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// 新增 List 页面
// src/shared/pages/List.js
import React from "react";

export default function List() {
  return &lt;div&gt;ListPage works&lt;/div&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 创建路由规则
// src/shared/AppRoutes.js
import Home from "./pages/Home";
import List from "./pages/List";
import React from "react";
import { useRoutes } from "react-router-dom";

export const routes = [
  {
    path: "/",
    element: &lt;Home /&gt;,
  },
  {
    path: "/list",
    element: &lt;List /&gt;,
  },
];

export default function AppRoutes() {
  return useRoutes(routes);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { StaticRouter } from "react-router-dom/server";
import AppRoutes from "../shared/AppRoutes";

export default (req) =&gt; {
  const content = renderToString(
    &lt;StaticRouter location={req.path}&gt;
      &lt;AppRoutes /&gt;
    &lt;/StaticRouter&gt;
  );
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/index.js
// 1. 服务端 express 接收任何请求, 然后将请求转发给 React 路由进行匹配
app.get("*", (req, res) =&gt; {
  res.send(render(req));
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：查看代码运行结果时需要临时禁用客户端浏览器 JavaScript，因为此时客户端程序运行时会覆盖服务端返回的 HTML。</p>
<h4 id="13-实现客户端路由"><a href="#13-实现客户端路由" class="headerlink" title="13. 实现客户端路由"></a>13. 实现客户端路由</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/client/index.js
import { BrowserRouter } from "react-router-dom";
import AppRoutes from "../shared/AppRoutes";

ReactDOM.hydrate(
  &lt;BrowserRouter&gt;
    &lt;AppRoutes /&gt;
  &lt;/BrowserRouter&gt;,
  document.getElementById("root")
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import React from "react";
import { Link } from "react-router-dom";

export default function Home() {
  return (
    &lt;&gt;
      &lt;p&gt;当前为首页&lt;/p&gt;
      &lt;Link to="/list"&gt;跳转到列表页面&lt;/Link&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import React from "react";
import { Link } from "react-router-dom";

export default function List() {
  return (
    &lt;&gt;
      &lt;p&gt;当前为列表页&lt;/p&gt;
      &lt;Link to="/"&gt;跳转到首页&lt;/Link&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="14-实现客户端-Redux"><a href="#14-实现客户端-Redux" class="headerlink" title="14. 实现客户端 Redux"></a>14. 实现客户端 Redux</h4><p>客户端与服务端共用除创建 Store 对象的代码。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/state/todo.slice.js
import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";

export const loadTodos = createAsyncThunk("todos/loadTodos", () =&gt; {
  return axios
    .get("https://jsonplaceholder.typicode.com/todos")
    .then((response) =&gt; response.data);
});

const { actions, reducer: TodosReducer } = createSlice({
  name: "todos",
  initialState: [],
  extraReducers: {
    [loadTodos.fulfilled](state, action) {
      action.payload.forEach((todo) =&gt; state.push(todo));
    },
  },
});

export default TodosReducer;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/client/store.js
import { configureStore } from "@reduxjs/toolkit";
import TodosReducer from "../shared/state/todo.slice";

export default configureStore({
  reducer: {
    todos: TodosReducer,
  }
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/client/index.js
import { Provider } from "react-redux";
import store from "./store";

ReactDOM.hydrate(
  &lt;Provider store={store}&gt;
    &lt;BrowserRouter&gt;
      &lt;AppRoutes /&gt;
    &lt;/BrowserRouter&gt;
  &lt;/Provider&gt;,
  document.getElementById("root")
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/pages/List.js
import React, { useEffect } from "react";
import { useDispatch, useSelector } from "react-redux";
import { loadTodos } from "../state/todo.slice";

export default function List() {
  const dispatch = useDispatch();
  const todos = useSelector((state) =&gt; state.todos);
  useEffect(() =&gt; {
    dispatch(loadTodos());
  }, []);
  return (
    &lt;ul&gt;
      {todos.map((todo) =&gt; (
        &lt;li key={todo.id}&gt;{todo.title}&lt;/li&gt;
      ))}
    &lt;/ul&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="15-实现服务端-Redux"><a href="#15-实现服务端-Redux" class="headerlink" title="15. 实现服务端 Redux"></a>15. 实现服务端 Redux</h4><p>第一步：在组件文件中导出 loadStateFromStore 方法，该方法在服务端调用，用于获取组件需要的状态。</p>
<p>当组件状态获取完成以后，服务端再渲染组件，组件渲染完成之后再发送到客户端。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/pages/List.js
import { loadTodos } from "../state/todo.slice";

function loadStateFromStore(store) {
  return store.dispatch(loadTodos());
}

export default {
  element: &lt;List /&gt;,
  loadStateFromStore,
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二步：重新配置组件路由规则，将 loadStateFromStore 方法挂载到组件配置对象中</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import List from "./pages/List";

export const routes = [
  {
    path: "/list",
    ...List,
  },
];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三步：创建服务端 Store 对象，由于服务端是在接收到请求以后动态创建 Store，所以服务端创建 Store 的代码要写在一个方法中。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/store.js
import { configureStore } from "@reduxjs/toolkit";
import TodosReducer from "../shared/state/todo.slice";

export default function createStore() {
  return configureStore({
    reducer: {
      todos: TodosReducer,
    },
  });
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第四步：服务端在接收到请求以后动态创建 store，调用组件中的 loadStateFromStore 方法获取组件状态，组件状态获取完成后再渲染组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import createStore from "./store";
import { matchRoutes } from "react-router-dom";
import { routes } from "../shared/AppRoutes";

app.get("*", (req, res) =&gt; {
  // 创建 store 对象
  const store = createStore();
  // matchRoutes 方法用于在路由规则数组中匹配出当前要使用的规则
  // matchRoutes 方法的返回值是数组类型, 即使匹配到一个路由, 如果匹配不到返回 null
  const matchedRoutes = matchRoutes(routes, req.path);
  // 如果匹配到了路由规则
  if (matchedRoutes) {
    // 从路由规则中获取 loadStateFromStore 方法, 使用该方法获取组件需要的状态
    // 由于获取组件状态可能涉及异步操作, 所以该方法要求返回 Promise
    // 在 loadStateFromStore 方法中调用的 dispatch 方法正好返回 Promise, 所以在该方法中只需要返回 dispatch 方法的返回值即可
    // 此处我们将返回的所有 Promsie 放到一个数组中, 方便监听所有异步操作完成
    const loadDataArray = matchedRoutes.map(
      ({ route }) =&gt; route.loadStateFromStore &amp;&amp; route.loadStateFromStore(store)
    );
    // 监听所有异步操作完成的状态
    // 所以异步操作完成就代表 Store 中已经存储了我们需要的数据了
    Promise.all(loadDataArray).then(() =&gt; {
      // 当 store 中有需要的数据以后再渲染组件
      res.send(render(req, store));
    });
  } else {
    res.send(`&lt;div&gt;404 not found&lt;/div&gt;`);
  }
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第五步：在服务端配置 Provider 组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { renderToString } from "react-dom/server";
import { StaticRouter } from "react-router-dom/server";
import React from "react";
import { Provider } from "react-redux";
import AppRoutes from "../shared/AppRoutes";

export default (req, store) =&gt; {
  const content = renderToString(
    &lt;Provider store={store}&gt;
      &lt;StaticRouter location={req.url}&gt;
        &lt;AppRoutes /&gt;
      &lt;/StaticRouter&gt;
    &lt;/Provider&gt;
  );
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="16-服务端数据回填客户端"><a href="#16-服务端数据回填客户端" class="headerlink" title="16. 服务端数据回填客户端"></a>16. 服务端数据回填客户端</h4><p>警告原因：客户端 Store 在初始状态下是没有数据的，在渲染组件的时候生成的是空 ul，但是服务器端是先获取数据再进行的组件渲染，所以生成的是有子元素的ul，hydrate 方法在对比的时候发现两者不一致所以报了个警告。</p>
<img src="/medias/assets/images/52.png" align="left" width="60%">

<p>解决思路：将服务器端获取到的数据回填给客户端, 让客户端拥有初始数据。服务端已经获取了一次数据，客户端没有必要再次获取。</p>
<p>第一步：将组件状态挂载到 window 对象中</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/server/render.js
export default (req, store) =&gt; {
  // 获取初始状态
  const initialState = JSON.stringify(store.getState());
  return `
    &lt;html&gt;
        &lt;script&gt;window.initialState = ${initialState}&lt;/script&gt;
        &lt;script src="/bundle.js"&gt;&lt;/script&gt;
    &lt;/html&gt;
  `;
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二步：客户端设置初始状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">export default configureStore({
  preloadedState: {
    todos: window.initialState.todos || [],
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第三步：在组件中判断如果初始数据不存在再进行初始数据的获取</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function List() {
  useEffect(() =&gt; {
    todos.length === 0 &amp;&amp; dispatch(loadTodos());
  }, []);
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="17-防止XSS攻击"><a href="#17-防止XSS攻击" class="headerlink" title="17. 防止XSS攻击"></a>17. 防止XSS攻击</h4><p>第一步：服务端模拟返回恶意XSS代码</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/shared/state/todo.slice.js
createSlice({
  extraReducers: {
    [loadTodos.fulfilled](state, action) {
      state.push({
        id: 1,
        title: "&lt;/script&gt;&lt;script&gt;alert(1)&lt;/script&gt;",
      });
    },
  },
});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二步：通过 serializeJavascript 方法对数据进行转换</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> serializeJavascript <span class="token keyword">from</span> <span class="token string">"serialize-javascript"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取初始状态</span>
  <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token function">serializeJavascript</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-React-与-TypeScript"><a href="#7-React-与-TypeScript" class="headerlink" title="7. React 与 TypeScript"></a>7. React 与 TypeScript</h2><h3 id="7-1-概述"><a href="#7-1-概述" class="headerlink" title="7.1 概述"></a>7.1 概述</h3><h4 id="7-1-1-创建应用"><a href="#7-1-1-创建应用" class="headerlink" title="7.1.1 创建应用"></a>7.1.1 创建应用</h4><p>创建支持 TypeScript 语法的 React 应用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx create-react-app <span class="token operator">&lt;</span>appname<span class="token operator">&gt;</span> --template typescript<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="7-1-2-文件后缀"><a href="#7-1-2-文件后缀" class="headerlink" title="7.1.2 文件后缀"></a>7.1.2 文件后缀</h4><p>如果文件中包含 React 组件或者 JSX 代码，文件后缀使用 <code>tsx</code></p>
<p>如果文件中不包含任何 JSX 代码，文件后缀使用 <code>ts</code></p>
<h3 id="7-2-为组件添加类型"><a href="#7-2-为组件添加类型" class="headerlink" title="7.2 为组件添加类型"></a>7.2 为组件添加类型</h3><p>在我们定义了组件以后，TypeScript 编译器并不知道我们定义的是组件，它会认为我们定义的就是一个普通的函数。</p>
<p>在类型认知出现偏差以后，TypeScript 编译器不能正确的对我们的代码进行约束。</p>
<p>比如在下列代码中，我们通过组件获取组件下的属性，TypeScript 编译器会报错，说组件下不存在这个属性。</p>
<p>当 TypeScript 编译器知道我们定义的是组件以后，当我们错误的使用了组件以后，它才能准确的为我们进行提示。</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">const</span> <span class="token function-variable function">Child</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Child</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 类型 "() =&gt; Element" 上不存在属性 "displayName"。</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Child<span class="token punctuation">.</span>displayName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 类型 "() =&gt; Element" 上不存在属性 "defaultProps"。</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Child<span class="token punctuation">.</span>defaultProps<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">FC</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Child<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">Child</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-3-Props"><a href="#7-3-Props" class="headerlink" title="7.3 Props"></a>7.3 Props</h3><p>为组件 props 定义接口类型，编译器可以检查父组件在调用该组件时是否正确的传递了 props，在子组件内部是否正确的使用了 props。 </p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// src/props/Child.tsx</span>
<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>
  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Child<span class="token operator">:</span> <span class="token constant">FC</span><span class="token operator">&lt;</span>Props<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> color<span class="token punctuation">,</span> onClick <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>color<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// src/props/Parent.tsx</span>
<span class="token keyword">const</span> <span class="token function-variable function">Parent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Child</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"clicked"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-4-state"><a href="#7-4-state" class="headerlink" title="7.4 state"></a>7.4 state</h3><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/Guests.tsx
import { useState, FC } from "react";

const Guests: FC = () =&gt; {
  const [name, setName] = useState&lt;string&gt;("");
  // 此处如果不为 guests 指定类型, 类型将会是 never[]
  const [guests, setGuests] = useState&lt;string[]&gt;([]);
  const clickHandler = () =&gt; {
    setName("");
    // 如果 guests 是 never[], 那么字符串 name 将不能被存储到 guests 数组中
    setGuests([...guests, name]);
  };
  return (
    &lt;&gt;
      &lt;ul&gt; {guests.map((guest) =&gt; &lt;li key={guest}&gt;{guest}&lt;/li&gt;)}&lt;/ul&gt;
      &lt;input type="text" value={name} onChange={(event) =&gt; setName(event.target.value)}/&gt;
      &lt;button onClick={clickHandler}&gt;add&lt;/button&gt;
    &lt;/&gt;
  );
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/state/UserSearch.tsx
import { useState, FC } from "react";

const users = [
  { name: "张三", age: 20 },
  { name: "李四", age: 30 },
];

const UserSearch: FC = () =&gt; {
  const [name, setName] = useState&lt;string&gt;("");
  // 在组件初次渲染, 在没有找到 user 的情况下, user 的类型是 undefined
  // 在找到 user 以后, 它的类型是 {name: string, age: number}
  // 所以 user 的类型就应该是 {name: string, age: number} | undefined
  const [user, setUser] = useState&lt;{ name: string; age: number } | undefined&gt;();
	// 搜索用户
  const searchHandler = () =&gt; {
    // find 方法的返回值可能是 user, 也可能是 undefined
    setUser(
    	users.find((user) =&gt; user.name === name)
    );
  };
  return (
    &lt;&gt;
      &lt;input type="text" value={name} onChange={(event) =&gt; setName(event.target.value)} /&gt;
      &lt;button onClick={searchHandler}&gt;search&lt;/button&gt;
      {user &amp;&amp; JSON.stringify(user)}
    &lt;/&gt;
  );
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-5-事件对象"><a href="#7-5-事件对象" class="headerlink" title="7.5 事件对象"></a>7.5 事件对象</h3><pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/event/EventComponent.tsx
import { ChangeEvent, FC, DragEvent } from "react";

const EventComponent: FC = () =&gt; {
  // 参数"event"隐式具有"any"类型
  const changeHandler = (event: ChangeEvent&lt;HTMLInputElement&gt;) =&gt; {
    console.log(event.target.value);
  };
  const dragStartHandler = (event: DragEvent&lt;HTMLDivElement&gt;) =&gt; {
    // event.target: 返回触发事件的元素
    // event.currentTarget: 返回绑定事件的元素
    console.log(event.target);
    console.log(event.currentTarget);
  };
  return (
    &lt;&gt;
      &lt;input type="text" onChange={changeHandler} /&gt;
      &lt;div draggable onDragStart={dragStartHandler}&gt; drag event &lt;/div&gt;
    &lt;/&gt;
  );
};<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/images/43.gif" align="left">

<h3 id="7-6-ref"><a href="#7-6-ref" class="headerlink" title="7.6 ref"></a>7.6 ref</h3><p><code>src/ref/RefComponent.tsx</code></p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">FC</span><span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"React"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> RefComponent<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLInputElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-7-Redux"><a href="#7-7-Redux" class="headerlink" title="7.7 Redux"></a>7.7 Redux</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> redux redux-thunk axios react-redux @types/react-redux --save-exact
<span class="token comment"># save-exact: 在 package.json 文件中记录安装包的确切版本</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>redux、redux-thunk、axios 内置 TypeScript 类型声明文件，所以不需要单独下载。</p>
<p>react-redux 没有内置类型声明文件，所以需要单独下载。</p>
<p><img src="/medias/assets/images/44.png" align="left" width="32%"><img src="/medias/assets/images/45.png" align="left" width="30%"></p>
<p>需求：向 npm 发送请求加载 npm 包列表信息。</p>
<p>第一步：定义 Action Type</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/action-types/package.action.types.ts</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> searchActionType <span class="token punctuation">{</span>
  <span class="token comment">// 请求中</span>
  <span class="token constant">SEARCH_PACKAGES</span> <span class="token operator">=</span> <span class="token string">"search_packages"</span><span class="token punctuation">,</span>
  <span class="token comment">// 请求成功</span>
  <span class="token constant">SEARCH_PACKAGES_SUCCESS</span> <span class="token operator">=</span> <span class="token string">"search_packages_success"</span><span class="token punctuation">,</span>
  <span class="token comment">// 请求失败</span>
  <span class="token constant">SEARCH_PACKAGES_ERROR</span> <span class="token operator">=</span> <span class="token string">"search_packages_error"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/action-types/index.ts</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./package.action.types"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第二步：定义 Action 对象类型、Reducer 函数的 action 参数 action 类型</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/actions/packages.action.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> searchActionType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../action-types"</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 请求: {type: "search_packages"}
 * 成功: {type: "search_packages_success", payload: ["react", "react-dom"]}
 * 失败: {type: "search_packages_error", error: "Request Failed"}
 */</span>

<span class="token keyword">interface</span> <span class="token class-name">SearchPackagesAction</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">SearchPackagesSuccessAction</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_SUCCESS</span><span class="token punctuation">;</span>
  payload<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">SearchPackagesErrorAction</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_ERROR</span><span class="token punctuation">;</span>
  error<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">SearchAction</span> <span class="token operator">=</span>
  <span class="token operator">|</span> SearchPackagesAction
  <span class="token operator">|</span> SearchPackagesSuccessAction
  <span class="token operator">|</span> SearchPackagesErrorAction<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/actions/index.ts</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./packages.action"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第三步：创建 Reducer 函数，匹配 Action Type 返回对应的状态</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/reducers/packages.reducer.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> searchActionType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../action-types"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SearchAction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../actions"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PackagesState</span> <span class="token punctuation">{</span>
  loading<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  error<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  list<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> initialState<span class="token operator">:</span> PackagesState <span class="token operator">=</span> <span class="token punctuation">{</span>
  loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">packagesReducer</span><span class="token punctuation">(</span>
  state<span class="token operator">:</span> PackagesState <span class="token operator">=</span> initialState<span class="token punctuation">,</span>
  action<span class="token operator">:</span> SearchAction
<span class="token punctuation">)</span><span class="token operator">:</span> PackagesState <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> loading<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_SUCCESS</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> list<span class="token operator">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_ERROR</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token operator">:</span> action<span class="token punctuation">.</span>error<span class="token punctuation">,</span> list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第四步：合并 reducer 函数</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/reducers/index.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> packagesReducer <span class="token keyword">from</span> <span class="token string">"./packages.reducer"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  packages<span class="token operator">:</span> packagesReducer<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第五步：创建用于发送请求获取 npm 包的 action creator 函数</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/action-creators/packages.action.creators.ts</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Dispatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> searchActionType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../action-types"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SearchAction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../actions"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">searchPackages</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span>SearchAction<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://registry.npmjs.org/-/v1/search</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          params<span class="token operator">:</span> <span class="token punctuation">{</span>
            text<span class="token operator">:</span> key<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_SUCCESS</span><span class="token punctuation">,</span>
        payload<span class="token operator">:</span> data<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>package<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token operator">:</span> searchActionType<span class="token punctuation">.</span><span class="token constant">SEARCH_PACKAGES_ERROR</span><span class="token punctuation">,</span>
          error<span class="token operator">:</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// unknow 是更加严格的 any 类型.</span>
<span class="token comment">// 在对 unknown 类型的值执行大多数操作之前, 我们必须进行某种形式的检查</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./packages.action.creators"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第五步：创建 Store 对象，配置 redux-thunk 中间件函数</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> applyMiddleware<span class="token punctuation">,</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">"redux-thunk"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"."</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducers<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第六步：创建 state 入口文件</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/index.ts</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">as</span> actionCreators <span class="token keyword">from</span> <span class="token string">"./action-creators"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./reducers"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">"./store"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第七步：配置 Provider 组件</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// src/components/App.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">FC</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> store <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../state"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Packages <span class="token keyword">from</span> <span class="token string">"./Packages"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> App<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Packages</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第八步：在组件中，当点击按钮时向服务器端发送请求获取 npm 包</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// src/components/Packages.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">FC</span><span class="token punctuation">,</span> FormEvent<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useActions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../hooks/useActions"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Packages<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> setKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useState</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> searchPackages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onSubmitHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> FormEvent<span class="token operator">&lt;</span>HTMLFormElement<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">searchPackages</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onSubmit</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onSubmitHandler<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setKey</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">search</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/hooks/useActions.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useDispatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> bindActionCreators <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> actionCreators <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../state"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">useActions</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">bindActionCreators</span><span class="token punctuation">(</span>actionCreators<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第九步：在组件中获取状态并根据状态渲染 UI</p>
<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token keyword">import</span> <span class="token punctuation">{</span> useSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react-redux"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../state"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PackagesState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../state/reducers/packages.reducer"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Packages<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useSelector</span><span class="token generic class-name"><span class="token operator">&lt;</span>AppState<span class="token punctuation">,</span> PackagesState<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>loading <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">loading....</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>error <span class="token operator">&amp;&amp;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>error<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token punctuation">{</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定义应用全局状态的类型，用于传递给 useSelecter 钩子函数</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// src/state/reducers/index.ts</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">AppState</span> <span class="token operator">=</span> ReturnType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> reducers<span class="token operator">&gt;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第十步：优化为应用全局状态设置类型的代码</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// src/hooks/useTypedSelector.ts
import { useSelector, TypedUseSelectorHook } from "react-redux";
import { AppState } from "../state/reducers";

export const useTypedSelector: TypedUseSelectorHook&lt;AppState&gt; = useSelector;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-tsx" data-language="tsx"><code class="language-tsx"><span class="token comment">// src/components/Packages.tsx</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useTypedSelector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../hooks/useTypedSelector"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Packages<span class="token operator">:</span> <span class="token function-variable function">FC</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">useTypedSelector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>packages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-流行库"><a href="#8-流行库" class="headerlink" title="8. 流行库"></a>8. 流行库</h2><h3 id="8-1-Styled-Components"><a href="#8-1-Styled-Components" class="headerlink" title="8.1 Styled Components"></a>8.1 Styled Components</h3><h4 id="8-1-1-概述"><a href="#8-1-1-概述" class="headerlink" title="8.1.1 概述"></a>8.1.1 概述</h4><p><a target="_blank" rel="noopener" href="https://styled-components.com/">styled-components</a> 允许开发者通过创建组件的方式为元素添加样式, 创建出来的组件叫做样式化组件。</p>
<img src="/medias/assets/images/46.png" align="left" width="50%">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save styled-components
<span class="token function">yarn</span> <span class="token function">add</span> styled-components<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="8-1-2-基本使用"><a href="#8-1-2-基本使用" class="headerlink" title="8.1.2 基本使用"></a>8.1.2 基本使用</h4><img src="/medias/assets/images/47.png" align="left" width="50%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 创建样式化组件
import styled from "styled-components";

export const Wrapper = styled.div`
  padding: 30px;
  background: papayawhip;
`;

export const Title = styled.h1`
  font-size: 24px;
  color: palevioletred;
  text-align: center;
  margin: 0;
`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// 使用样式化组件
function App() {
  return (
    &lt;Wrapper&gt;
      &lt;Title&gt;Hello, styled-components&lt;/Title&gt;
    &lt;/Wrapper&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-1-3-根据属性适配样式"><a href="#8-1-3-根据属性适配样式" class="headerlink" title="8.1.3 根据属性适配样式"></a>8.1.3 根据属性适配样式</h4><img src="/medias/assets/images/48.png" align="left" width="25%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">export const Button = styled.button`
  border: 2px solid palevioletred;
  border-radius: 3px;
  padding: 10px 15px;
  background-color: ${(props) =&gt; (props.primary ? "palevioletred" : "white")};
  color: ${(props) =&gt; (props.primary ? "white" : "palevioletred")};
`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  return (
    &lt;&gt;
      &lt;Button primary&gt;Primary Button&lt;/Button&gt;
    	&lt;Button&gt;Primary Button&lt;/Button&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/images/50.png" align="left" width="40%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">export const Input = styled.input`
  border: none;
  border-radius: 3px;
  padding: 10px;
  background-color: papayawhip;
  color: ${(props) =&gt; props.color || "palevioletred"};
`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">function App() {
  return (
    &lt;&gt;
      &lt;Input defaultValue="Hello" type="text" color="rebeccapurple" /&gt;
      &lt;Input defaultValue="styled-components" type="text" /&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-1-4-扩展样式化组件"><a href="#8-1-4-扩展样式化组件" class="headerlink" title="8.1.4 扩展样式化组件"></a>8.1.4 扩展样式化组件</h4><img src="/medias/assets/images/49.png" align="left" width="25%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">export const Button = styled.button`
  color: palevioletred;
  background-color: #fff;
  font-size: 18px;
  padding: 15px 20px;
  border: 2px solid palevioletred;
  border-radius: 3px;
`;

export const TomatoButton = styled(Button)`
  color: tomato;
  border-color: tomato;
`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Button, TomatoButton } from "./components/Wrapper";

function App() {
  return (
    &lt;&gt;
      &lt;Button&gt;Button&lt;/Button&gt; &lt;TomatoButton&gt;TomatoButton&lt;/TomatoButton&gt;
    &lt;/&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-1-5-为任何组件设置样式"><a href="#8-1-5-为任何组件设置样式" class="headerlink" title="8.1.5 为任何组件设置样式"></a>8.1.5 为任何组件设置样式</h4><p>styled 方法不仅可以创建样式化组件，它还可以为普通的 React 组件设置样式。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import styled from "styled-components";

const Link = ({ className, children }) =&gt; {
  return (
    &lt;a href="http://www.example.com" className={className}&gt;
      {children}
    &lt;/a&gt;
  );
};

const StyledLink = styled(Link)`
  color: palevioletred;
  font-weight: bold;
`;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-2-React-Hook-Form"><a href="#8-2-React-Hook-Form" class="headerlink" title="8.2. React Hook Form"></a>8.2. React Hook Form</h3><h4 id="8-2-1-概述"><a href="#8-2-1-概述" class="headerlink" title="8.2.1 概述"></a>8.2.1 概述</h4><p><a target="_blank" rel="noopener" href="https://react-hook-form.com/">React Hook Form</a> 是 React 生态圈中最为流行的表单构建工具，用于简化 React 表单代码复杂冗余的问题。</p>
<img src="/medias/assets/images/51.png" align="left">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-hook-form<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="8-2-2-基本使用"><a href="#8-2-2-基本使用" class="headerlink" title="8.2.2 基本使用"></a>8.2.2 基本使用</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useForm } from "react-hook-form";

function App() {
  const { register, handleSubmit, watch } = useForm({
    defaultValues: {
      username: "张三",
      isAgree: true,
      hobbies: [],
      gender: "男",
      transport: "",
    },
  });
  const onSubmit = handleSubmit((data) =&gt; {
    console.log(data);
  });
  	
  const username = watch("username");
  useEffect(() =&gt; {
    console.log(username);
  }, [username]);
  
  return (
    &lt;form onSubmit={onSubmit}&gt;
      &lt;input type="text" {...register("username")} /&gt;
      &lt;input type="checkbox" {...register("isAgree")} /&gt;
      &lt;input type="checkbox" value="足球" {...register("hobbies")} /&gt;
      &lt;input type="checkbox" value="篮球" {...register("hobbies")} /&gt;
      &lt;input type="radio" value="男" {...register("gender")} /&gt;
      &lt;input type="radio" value="女" {...register("gender")} /&gt;
      &lt;select {...register("transport")}&gt;
        &lt;option value=""&gt;请选择交通工具&lt;/option&gt;
        &lt;option value="火车"&gt;火车&lt;/option&gt;
        &lt;option value="飞机"&gt;飞机&lt;/option&gt;
        &lt;option value="自驾"&gt;自驾&lt;/option&gt;
      &lt;/select&gt;
      &lt;button type="submit"&gt;提交&lt;/button&gt;
    &lt;/form&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-2-3-表单验证"><a href="#8-2-3-表单验证" class="headerlink" title="8.2.3 表单验证"></a>8.2.3 表单验证</h4><p>表单验证支持以下字段：required、min、max、minLength、maxLength、pattern、validate</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useForm } from "react-hook-form";

function App() {
  const { formState: { errors } } = useForm({
     // 控制触发表单验证的时机
    // onSubmit onBlur onTouched onChange all
    mode: "onChange",
  });
  // 表单提交触发表单验证, 表单提交后触发表单实时验证
  const onSubmit = handleSubmit((data) =&gt; {
    // 在表单验证没有通过的情况下是不会调用该回调函数的
  });
  
  // 注册用户名字段
  const usernameRegister = register("username", {
    required: "用户名不能为空",
    maxLength: {
      value: 6,
      message: "用户名最大长度是6",
    },
    pattern: {
      value: /^[A-Za-z]+$/i,
      message: "用户名只能包含字母",
    },
  });
  
  return (
    &lt;form onSubmit={onSubmit}&gt;
      &lt;input type="text" {...usernameRegister} /&gt;
      {errors.username &amp;&amp; &lt;span&gt;{errors.username.message}&lt;/span&gt;}
      &lt;button type="submit"&gt;提交&lt;/button&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useForm } from "react-hook-form";

function App() {
  const { watch } = useForm({
    // 设置表单控件的默认值
    defaultValues: {
      password: "",
      rePassword: "",
    },
  });

  return (
    &lt;form onSubmit={onSubmit}&gt;
      &lt;input
        type="password"
        {...register("password", {
          pattern: {
            value: /^[A-Za-z0-9]+$/,
            message: "密码必须是数字或字母",
          },
        })}
      /&gt;
      {errors.password?.message}
      &lt;input
        type="password"
        {...register("rePassword", {
          validate: (value) =&gt;
            value === watch("password") || "两次密码输入不一样",
        })}
      /&gt;
      {errors.rePassword?.message}
      &lt;button type="submit"&gt;提交&lt;/button&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-2-4-设置表单值"><a href="#8-2-4-设置表单值" class="headerlink" title="8.2.4  设置表单值"></a>8.2.4  设置表单值</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useForm } from "react-hook-form";

function App() {
  const { setValue, reset } = useForm({
    // 设置表单控件的默认值
    defaultValues: {
      username: "",
      isAgree: false,
    },
  });

  const onClickHandler = () =&gt; {
    // 设置单个表单控件的值
    // setValue("username", "张三");
    // 同时设置多个表单控件的值
    reset({ username: "张三", isAgree: true });
  };

  return (
    &lt;form onSubmit={onSubmit}&gt;
      &lt;input type="text" {...register("username")} /&gt;
      &lt;input type="checkbox" {...register("isAgree")} /&gt;
      &lt;button type="button" onClick={onClickHandler}&gt;设置表单值&lt;/button&gt;
    &lt;/form&gt;
  );
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-2-5-useFormContext"><a href="#8-2-5-useFormContext" class="headerlink" title="8.2.5 useFormContext"></a>8.2.5 useFormContext</h4><p>通过 <code>useFormContext</code> 可以获取到表单上下文。</p>
<p>在表单内部有嵌套结构的情况下，将表单上下文作为 props 传递非常不方便。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { FormProvider, useForm, useFormContext } from "react-hook-form";

function App() {
  const methods = useForm({
    defaultValues: {
      username: "",
      password: "",
    },
  });
  const onSubmit = methods.handleSubmit((data) =&gt; {
    console.log(data);
  });
  return (
    &lt;FormProvider {...methods}&gt;
      &lt;form onSubmit={onSubmit}&gt;
        &lt;input type="text" {...methods.register("username")} /&gt;
        &lt;Password /&gt;
        &lt;button type="submit"&gt;提交&lt;/button&gt;
      &lt;/form&gt;
    &lt;/FormProvider&gt;
  );
}

function Password() {
  const { register } = useFormContext();
  return &lt;input type="password" {...register("password")} /&gt;;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-3-React-Spring"><a href="#8-3-React-Spring" class="headerlink" title="8.3 React Spring"></a>8.3 React Spring</h3><img src="/medias/assets/react-spring/12.png">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-spring@9.4.3 styled-components@5.3.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">useSpring
// 创建单元素动画, 将元素从一个状态转换为另一个状态
useSprings
// 创建多元素动画, 将多个元素同时从一个状态转换为另一个状态
useTrail
// 创建多元素动画, 多个元素的动画依次执行
useTransition
// 创建入场、离场动画, 可以是单元素入场、离场动画，也可以是多元素入场离场动画<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-3-1-useSpring"><a href="#8-3-1-useSpring" class="headerlink" title="8.3.1 useSpring"></a>8.3.1 useSpring</h4><img src="/medias/assets/react-spring/13.gif" align="left">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useSpring, animated } from "react-spring";
import { useState } from "react";

function App() {
  const [toggle, setToggle] = useState(false);
  const styles = useSpring({
    backgroundSize: toggle ? "150%" : "100%",
  });
  return (
    &lt;animated.div
      onMouseEnter={() =&gt; setToggle(true)}
      onMouseLeave={() =&gt; setToggle(false)}
      style={{
        width: 300,
        height: 300,
        backgroundImage:
          "url(https://images.pexels.com/photos/3227984/pexels-photo-3227984.jpeg?auto=compress&amp;cs=tinysrgb&amp;dpr=1&amp;w=500)",
        backgroundPosition: "center center",
        ...styles,
      }}
    &gt;&lt;/animated.div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/react-spring/04.gif" align="left">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useSpring, animated } from "react-spring";

function App() {
  const { count } = useSpring({
    from: {
      count: 0,
    },
    to: {
      count: 556,
    },
    config: {
      duration: 2000,
    },
  });
  console.log(count);
  return (
    &lt;animated.div style={{ fontSize: 54 }}&gt;
      {count.to((count) =&gt; count.toFixed(2))}
    &lt;/animated.div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/react-spring/05.gif" align="left">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import styled from "styled-components";
import { useSpring, animated } from "react-spring";
import { useRef } from "react";

const data = [
  "Cras justo odio",
  "Dapibus ac facilisis in",
  "Morbi leo risus",
  "Porta ac consectetur ac",
  "Vestibulum at eros",
  "List group item heading",
  "Something else here",
  "Separated link",
  "Another action",
  "Extra small button",
  "Signed in as Mark Otto",
  "This is a simple hero unit",
];

const Container = styled(animated.div)`
  width: 240px;
  height: 100px;
  overflow: auto;
  background-color: skyblue;
  padding: 0 10px;
  color: #fff;
  &amp; &gt; div {
    height: 30px;
    line-height: 30px;
  }
`;

function App() {
  const ref = useRef(null);
  const { scroll } = useSpring({
    scroll: ref?.current?.scrollTop || 0,
  });
  return (
    &lt;&gt;
      &lt;Container ref={ref} scrollTop={scroll}&gt;
        {data.map((item) =&gt; (
          &lt;div key={item}&gt;{item}&lt;/div&gt;
        ))}
      &lt;/Container&gt;
      &lt;button
        onClick={() =&gt;
          scroll.start({
            from: { scroll: ref.current.scrollTop },
            to: { scroll: 0 },
          })
        }
      &gt;
        scrollToTop
      &lt;/button&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-3-2-useSprings"><a href="#8-3-2-useSprings" class="headerlink" title="8.3.2 useSprings"></a>8.3.2 useSprings</h4><p>创建多元素动画。</p>
<img src="/medias/assets/react-spring/06.gif">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react"
import { animated, useSprings } from "react-spring"

const data = ["primary", "success", "danger", "warning"]

function App() {
  const [on, setOn] = useState(false)
  const animations = useSprings(
    data.length,
    data.map((item, index) =&gt; {
      return {
        from: {
          transform: `translateX(${index % 2 === 0 ? -110 : 110}%)`
        },
        to: {
          transform: "translateX(0%)"
        },
        // 控制动画执行方向
        // false: from -&gt; to
        // true: to -&gt; from
        // 当 on 状态发生变化后会触发动画执行
        reverse: on
      }
    })
  )
  return (
    &lt;div className="container"&gt;
      &lt;button onClick={() =&gt; setOn(!on)} className="button mt-2 is-fullwidth is-info"&gt; Click &lt;/button&gt;
      &lt;ul&gt;
        {data.map((item, index) =&gt; (
          &lt;animated.li style={animations[index]} key={item}&gt;
            &lt;button className={`button mt-2 is-fullwidth is-${item}`}&gt;
              {item}
            &lt;/button&gt;
          &lt;/animated.li&gt;
        ))}
      &lt;/ul&gt;
    &lt;/div&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-3-3-useTrail"><a href="#8-3-3-useTrail" class="headerlink" title="8.3.3 useTrail"></a>8.3.3 useTrail</h4><p>创建交错动画，先创建动画，根据动画创建执行动画的元素。</p>
<img src="/medias/assets/react-spring/07.gif" align="left">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useTrail, animated, config } from "react-spring";
import { useState } from "react";
import mock_data from "./MOCK_DATA.json";

function App() {
  const [{ dataToShow, indexStartRender }, setState] = useState({
    dataToShow: mock_data,
    indexStartRender: 0,
  });
  const animations = useTrail(dataToShow.length, {
    from: {
      transform: "translateY(100%)",
    },
    to: {
      transform: "translateY(0%)",
    },
    // 动画执行完成后重置, 以便再次执行动画
    reset: true,
    // config.wobby 为预置动画形式
    config: config.wobbly,
  });
  const onClickHandler = (index) =&gt; {
    const newData = [
      ...dataToShow.slice(0, index),
      ...dataToShow.slice(index + 1),
    ];
    setState({
      dataToShow: newData,
      indexStartRender: index,
    });
  };
  return (
    &lt;div className="container"&gt;
      {dataToShow.map((item, index) =&gt; (
        &lt;animated.button
          onClick={() =&gt; onClickHandler(index)}
          key={item.id}
          style={index &gt;= indexStartRender ? animations[index] : null}
          className="button mt-2 is-fullwidth is-primary"
        &gt;
          {item.first_name}
        &lt;/animated.button&gt;
      ))}
    &lt;/div&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-3-4-useTransition"><a href="#8-3-4-useTransition" class="headerlink" title="8.3.4 useTransition"></a>8.3.4 useTransition</h4><p>创建入场动画和出场动画，可以是一个元素也可以是一组元素。</p>
<img src="/medias/assets/react-spring/08.gif" align="left" width="40%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;div className="app"&gt;
  &lt;button&gt;button&lt;/button&gt;
  &lt;div className="container"&gt;
    &lt;div className="item"&gt;item&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react"
import { animated, useTransition } from "react-spring"
import "./App.css"

function App() {
  const [isVisible, setIsVisible] = useState(false)
  const transition = useTransition(isVisible, {
    from: {
      opacity: 0,
      x: -300,
      y: 800
    },
    enter: {
      opacity: 1,
      x: 0,
      y: 0
    },
    leave: {
      opacity: 0,
      x: 300,
      y: 800
    }
  })
  return (
    &lt;div className="app"&gt;
      &lt;button onClick={() =&gt; setIsVisible(!isVisible)}&gt;
       	{isVisible ? "卸载" : "挂载"}
      &lt;/button&gt;
      &lt;div className="container"&gt;
        {transition((style, item) =&gt; {
          return item ? (
            &lt;animated.button className="item" style={style}&gt;&lt;/animated.button&gt;
          ) : null
        })}
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/react-spring/09.gif" align="left" width="40%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react"
import { animated, useTransition } from "react-spring"
import "./App.css"

function App() {
  const [items, setItems] = useState([])
  const transition = useTransition(items, {
    from: {
      opacity: 0,
      x: -300,
      y: 800
    },
    enter: item =&gt; ({ opacity: 1, x: 0, y: item.y, delay: item.delay }),
    leave: {
      opacity: 0,
      x: 300,
      y: 800,
    }
  })
  const onClickHandler = () =&gt; {
    setItems(prev =&gt;
      prev.length
        ? []
        : [
            { y: -50, delay: 200 },
            { y: 0, delay: 400 },
            { y: 50, delay: 600 }
          ]
    )
  }
  return (
    &lt;div className="app"&gt;
      &lt;button onClick={onClickHandler}&gt;{items.length ? "卸载" : "挂载"}&lt;/button&gt;
      &lt;div className="container"&gt;
        {transition((style, item) =&gt; {
          return item ? (
            &lt;animated.div className="item" style={style}&gt;&lt;/animated.div&gt;
          ) : null
        })}
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/medias/assets/react-spring/10.gif" align="left" width="40%">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react"
import { animated, useTransition } from "react-spring"
import "./App.css"

function App() {
  const [items, setItems] = useState([])
  const transition = useTransition(items, {
    from: {
      opacity: 0,
      x: -300,
      y: 800,
      width: 20,
      height: 20
    },
    enter: item =&gt; async next =&gt; {
      await next({ opacity: 1, y: item.y, delay: item.delay })
      await next({
        x: 0,
        width: 100,
        height: 100
      })
    },
    leave: {
      opacity: 0,
      x: 300,
      y: 800
    }
  })
  return (
    &lt;div className="app"&gt;
      &lt;button
        onClick={() =&gt;
          setItems(prev =&gt; {
            return prev.length
              ? []
              : [
                  { y: -50, delay: 200 },
                  { y: 0, delay: 400 },
                  { y: 50, delay: 600 }
                ]
          })
        }
      &gt;
        {items.length ? "un-mount" : "mount"}
      &lt;/button&gt;
      &lt;div className="container"&gt;
        {transition((style, item) =&gt; {
          return item ? (
            &lt;animated.div className="item" style={style}&gt;&lt;/animated.div&gt;
          ) : null
        })}
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-4-React-Query"><a href="#8-4-React-Query" class="headerlink" title="8.4 React Query"></a>8.4 <a target="_blank" rel="noopener" href="https://react-query.tanstack.com/">React Query</a></h3><h4 id="8-4-1-概述"><a href="#8-4-1-概述" class="headerlink" title="8.4.1  概述"></a>8.4.1  概述</h4><p>React Query 使 React 应用获取，缓存，同步和更新服务端状态变得轻而易举。</p>
<ol>
<li><p>请求管理</p>
<p>在适当时机自动向服务端发送请求以同步状态。适当时机是指当请求出错时，网络重新连接时，浏览器窗口重新获取焦点时。</p>
<p>它是基于请求库上层的封装，实现了和请求相关的逻辑， 比如无限加载，失败重试，轮询，请求状态查询等。</p>
<p>它不生产请求，它只是请求的搬运工。</p>
</li>
<li><p>状态管理</p>
<p>将服务端状态同步到客户端的内存中进行缓存，任何组件都可以从缓存中获取状态，从而实现全局状态共享。</p>
</li>
</ol>
<p>下载：<code>yarn add react-query@3.16.0</code></p>
<h4 id="8-4-2-状态模拟"><a href="#8-4-2-状态模拟" class="headerlink" title="8.4.2 状态模拟"></a>8.4.2 状态模拟</h4><ol>
<li><p>本地安装状态模拟工具 <code>yarn add json-server</code></p>
</li>
<li><p>创建 db.json 本地状态库</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"todos"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"吃饭"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"isEditing"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"睡觉"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"isEditing"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"打豆豆"</span><span class="token punctuation">,</span>
      <span class="token property">"isCompleted"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">"isEditing"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token property">"posts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Hello React Query"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"React Query is Great"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>package.json</code> 文件中添加命令</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"json-server"</span><span class="token operator">:</span> <span class="token string">"json-server --watch db.json --port 3001"</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p>启动程序 <code>npm run json-server</code></p>
</li>
</ol>
<h4 id="8-4-3-全局配置"><a href="#8-4-3-全局配置" class="headerlink" title="8.4.3 全局配置"></a>8.4.3 全局配置</h4><ol>
<li>React Query 会在客户端的内存中缓存状态，任何组件都可以从缓存中获取状态</li>
<li>组件可以通过 <code>queryClient</code> 对象操作内存中的缓存状态</li>
<li>开发者需要在应用的入口文件中通过 <code>QueryClient</code> 类创建 <code>queryClient</code> 对象</li>
<li>开发者需要通过 <code>QueryClientProvider</code> 组件将 <code>queryClient</code> 对象传递到下层组件</li>
<li>组件通过 <code>useQueryClient</code> 钩子函数获取 <code>queryClient</code> 对象</li>
</ol>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ReactDOM from "react-dom"
import App from "./App"
import axios from "axios"
import { QueryClient, QueryClientProvider } from "react-query"

// 响应拦截器, 让开发者直接获取到服务器端返回的数据
axios.interceptors.response.use(response =&gt; response.data)
axios.defaults.baseURL = "http://localhost:3001"

// 创建 queryClient 对象
const queryClient = new QueryClient()

ReactDOM.render(
  {/* 将 queryClient 对象传递到下层组件 */}
  &lt;QueryClientProvider client={queryClient}&gt;
    &lt;App /&gt;
  &lt;/QueryClientProvider&gt;,
  document.getElementById("root")
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-4-useQuery-同步服务端状态"><a href="#8-4-4-useQuery-同步服务端状态" class="headerlink" title="8.4.4 useQuery 同步服务端状态"></a>8.4.4 useQuery 同步服务端状态</h4><h5 id="1-基本使用-2"><a href="#1-基本使用-2" class="headerlink" title="1. 基本使用"></a>1. 基本使用</h5><p>在组件挂载完成后发送请求获取状态，缓存状态。</p>
<p>获取服务端默认待办事项列表。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// TodosMain.js 同步服务端状态待办事项列表
import axios from "axios"
import { useQuery } from "react-query"
import TodoItem from "./TodoItem"

async function fetchTodos() {
  try {
    return axios.get("/todos")
  } catch (err) {
    throw new Error("服务端默认待办事项加载失败")
  }
}

function TodosMain() {
  // useQuery(queryKey, queryFn)
  const { isLoading, isError, error, data } = useQuery("todos", fetchTodos)
  if (isLoading) return &lt;div&gt;正在加载服务端默认待办事项&lt;/div&gt;
  if (isError) return &lt;div&gt;{error.message}&lt;/div&gt;
  return (
    &lt;section className="main"&gt;
      &lt;ul className="todo-list"&gt;
        {data.map(todo =&gt; &lt;TodoItem key={todo.id} todo={todo} /&gt;)}
      &lt;/ul&gt;
    &lt;/section&gt;
  )
}

export default TodosMain<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="4-配置选项"><a href="#4-配置选项" class="headerlink" title="4. 配置选项"></a>4. 配置选项</h5><h6 id="1-retry"><a href="#1-retry" class="headerlink" title="1. retry"></a>1. retry</h6><p>在请求发生错误时，默认会重试 3 次，如果请求还是不成功 <code>isError</code> 为真。</p>
<p>可以通过 retry 配置项更改重试次数或者禁用重试 ( false )。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery("todos", fetchTodos, { retry: 2 })<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="2-refetchOnWindowFocus"><a href="#2-refetchOnWindowFocus" class="headerlink" title="2. refetchOnWindowFocus"></a>2. refetchOnWindowFocus</h6><p>当浏览器窗口重新获取焦点时，重新向服务器端发送请求同步最新状态。</p>
<p>在状态未更新之前，组件中显示缓存状态。</p>
<p>可以通过 <code>refetchOnWindowFocus</code> 配置项禁用此行为。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery("todos", fetchTodos, { refetchOnWindowFocus: false })<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="3-enabled"><a href="#3-enabled" class="headerlink" title="3. enabled"></a>3. enabled</h6><p>默认值为 true，即组件挂载完成后发送请求同步服务端状态。当值为 false 的时候此行为被禁止，当值被改为 true 时，发送请求同步服务端状态。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">const [isLoad, setIsLoad] = useState(false)
useQuery("todos", fetchTodos, { enabled: isLoad })
&lt;button onClick={() =&gt; setIsLoad(true)}&gt;同步状态&lt;/button&gt;
data &amp;&amp; data.map<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h6 id="4-staleTime"><a href="#4-staleTime" class="headerlink" title="4. staleTime"></a>4. staleTime</h6><p>状态的保质期。在同步状态时，如果状态仍然在保质期内，直接从缓存中获取状态，不会在后台发送真实的请求来更新状态缓存。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery("todos", fetchTodos, { staleTime: 5000 }) 
// 每次状态同步完成后都会有5秒的保质期<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h6 id="5-placeholderData"><a href="#5-placeholderData" class="headerlink" title="5. placeholderData"></a>5. placeholderData</h6><p>在服务端状态没有加载完成前，可以使用占位符状态填充客户端缓存以提升用户体验。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery("todos", fetchTodos, { placeholderData: [ { id: 1, title: "吃饭" } ] })<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h6 id="6-refetchInterval"><a href="#6-refetchInterval" class="headerlink" title="6 refetchInterval"></a>6 refetchInterval</h6><p>指定轮询的间隔时间，false 为不轮询。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery("todos", fetchTodos, { refetchInterval: 1000 })<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="5-queryKey"><a href="#5-queryKey" class="headerlink" title="5. queryKey"></a>5. queryKey</h5><p>useQuery 方法的第一个参数，除可以使用字符串以外，还可以使用数组，实现查询时传递参数。</p>
<p>实现查询 ID 为 1 的待办事项列表。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { useQuery } from "react-query"

function getTodoById({ queryKey }) {
  try {
    return axios.get(`/todos/${queryKey[1]}`)
  } catch (err) {
    throw new Error("待办事项获取失败")
  }
}

function FetchTodoById() {
  const { data } = useQuery(["todo", 2], getTodoById)
  return (
    &lt;div&gt;
      &lt;pre&gt;{JSON.stringify(data, null, 2)}&lt;/pre&gt;
    &lt;/div&gt;
  )
}

export default FetchTodoById<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">useQuery({ queryKey: ["todo", 2], queryFn: getTodoById })<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="8-4-5-useMutation"><a href="#8-4-5-useMutation" class="headerlink" title="8.4.5 useMutation"></a>8.4.5 useMutation</h4><p>修改状态，使用 useMutation 钩子函数，修改包括，删除，更新，添加。</p>
<p>实现添加待办事项。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// TodosHeader.js 添加待办事项
import axios from "axios"
import { useState } from "react"
import { useMutation } from "react-query"

async function addTodo(todo) {
  try {
    return axios.post("/todos", todo)
  } catch (err) {
    throw new Error("任务添加失败")
  }
}

function TodosHeader() {
  const [title, setTitle] = useState("")
  const { mutate } = useMutation(addTodo, {
    onSuccess() {
      setTitle("")
    }
  })
  return (
    &lt;header className="header"&gt;
      &lt;input
        value={title}
        onChange={event =&gt; setTitle(event.target.value)}
        onKeyUp={event =&gt; {
          if (event.code === "Enter") {
            mutate({ title, isCompleted: false, isEditing: false })
          }
        }}
      /&gt;
    &lt;/header&gt;
  )
}

export default TodosHeader<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-6-QueryClient"><a href="#8-4-6-QueryClient" class="headerlink" title="8.4.6 QueryClient"></a>8.4.6 QueryClient</h4><h5 id="1-同步服务端缓存"><a href="#1-同步服务端缓存" class="headerlink" title="1. 同步服务端缓存"></a>1. 同步服务端缓存</h5><p>实现在待办事项添加成功后更新客户端缓存以使组件展示出最新的待办事项列表。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useQueryClient } from "react-query"
const queryClient = useQueryClient()

useMutation(addTodo, {
    onSuccess() {
      // 使本地缓存中的 todos 状态无效, 重新发送请求同步状态。
      queryClient.invalidateQueries("todos")
    }
})<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="2-操作客户端缓存"><a href="#2-操作客户端缓存" class="headerlink" title="2. 操作客户端缓存"></a>2. 操作客户端缓存</h5><p>实现更改待办事项的是否已完成状态。</p>
<p>通过 setQueryData 方法可以手动设置客户端缓存数据。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { useMutation, useQueryClient } from "react-query"

async function modifyTodoCompleted({ id, isCompleted }) {
  try {
    return axios.patch(`/todos/${id}`, { isCompleted })
  } catch (err) {
    throw new Error("任务状态更改失败")
  }
}

function TodoCompleted({ todo }) {
  const queryClient = useQueryClient()
  const { mutate } = useMutation(modifyTodoCompleted, {
    onSuccess(response) {
      queryClient.setQueryData("todos", data =&gt;
        data.map(todo =&gt; (todo.id !== response.id ? todo : response))
      )
    }
  })
  return (
    &lt;input
      className="toggle"
      type="checkbox"
      checked={todo.isCompleted}
      onChange={event =&gt; {
        mutate({ id: todo.id, isCompleted: event.target.checked })
      }}
    /&gt;
  )
}

export default TodoCompleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-7-useQuery-同步客户端状态"><a href="#8-4-7-useQuery-同步客户端状态" class="headerlink" title="8.4.7 useQuery 同步客户端状态"></a>8.4.7 useQuery 同步客户端状态</h4><p>实现计算未完成待办事项的数量。</p>
<p>当客户端内存中的状态发生变化后，所有使用 useQuery 同步该状态的组件都会得到更新。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// hooks/todos.js
// 1. 将同步服务端待办事项抽象成自定义钩子函数 useTodos
// 2. 分别在不同组件中调用钩子函数以获取待办事项列表
import { useQuery } from "react-query"
import axios from "axios"

async function fetchTodos() {
  try {
    return axios.get("/todos")
  } catch (err) {
    throw new Error("服务端默认待办事项加载失败")
  }
}

export function useTodos() {
  return useQuery("todos", fetchTodos)
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useTodos } from "../hooks/todos"

function UnCompletedTodoCount() {
  const { data } = useTodos()
  return (
    &lt;span className="todo-count"&gt;
      &lt;strong&gt;{data &amp;&amp; data.filter(todo =&gt; !todo.isCompleted).length}&lt;/strong&gt;
      item left
    &lt;/span&gt;
  )
}

export default UnCompletedTodoCount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-8-QueryObserver-状态订阅"><a href="#8-4-8-QueryObserver-状态订阅" class="headerlink" title="8.4.8 QueryObserver 状态订阅"></a>8.4.8 QueryObserver 状态订阅</h4><p>通过 QueryObserver 可实现在任意组件中订阅状态，实现全局状态共享。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useQueryClient, QueryObserver } from "react-query"
import { useEffect, useState } from "react"

function UnCompletedTodoCount() {
  const queryClient = useQueryClient()
  const [todos, setTodos] = useState([])
  useEffect(() =&gt; {
    const todosObserver = new QueryObserver(queryClient, { queryKey: "todos" })
    const unsubscribe = todosObserver.subscribe(result =&gt; setTodos(result.data))
    return () =&gt; unsubscribe()
  }, [])
  return (
    &lt;span className="todo-count"&gt;
      &lt;strong&gt;{todos &amp;&amp; todos.filter(todo =&gt; !todo.isCompleted).length}&lt;/strong&gt;{" "}
      item left
    &lt;/span&gt;
  )
}

export default UnCompletedTodoCount<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-9-useQueries-并发同步状态"><a href="#8-4-9-useQueries-并发同步状态" class="headerlink" title="8.4.9 useQueries 并发同步状态"></a>8.4.9 useQueries 并发同步状态</h4><p>使用 useQueries 可以并行发送请求，所有结果得到以后返回给开发者。</p>
<p>实现并发加载待办事项列表和文章列表。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useQueries } from "react-query"
import axios from "axios"

async function fetchTodos() {
  try {
    return axios.get("/todos")
  } catch (err) {
    throw new Error("服务端默认待办事项加载失败")
  }
}

async function fetchPosts() {
  try {
    return axios.get("/posts")
  } catch (err) {
    throw new Error("文章列表加载失败")
  }
}

function Parallel() {
  const results = useQueries([
    {
      queryKey: "anotherTodos",
      queryFn: fetchTodos
    },
    {
      queryKey: "posts",
      queryFn: fetchPosts
    }
  ])
  return (
    &lt;div&gt;
      &lt;pre&gt;{JSON.stringify(results, null, 2)}&lt;/pre&gt;
    &lt;/div&gt;
  )
}

export default Parallel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-4-10-useInfiniteQuery-分页"><a href="#8-4-10-useInfiniteQuery-分页" class="headerlink" title="8.4.10 useInfiniteQuery 分页"></a>8.4.10 useInfiniteQuery 分页</h4><p>使用它可以实现和分页相关的逻辑。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import axios from "axios"
import { useInfiniteQuery } from "react-query"

async function fetchUser({ pageParam = 1 }) {
  try {
    return axios.get(`https://reqres.in/api/users?page=${pageParam}`)
  } catch (err) {
    throw new Error("用户状态同步失败")
  }
}

function LoadMore() {
  const {
    data,
    isLoading,
    isFetching,
    hasNextPage,
    fetchNextPage
  } = useInfiniteQuery("users", fetchUser, {
    getNextPageParam(current) {
      if (current.page &lt; current.total_pages) {
        return current.page + 1
      }
    }
  })
  if (isLoading) return &lt;div&gt;用户状态正在加载中...&lt;/div&gt;
  return (
    &lt;div&gt;
      &lt;ul&gt;
        {data.pages.map(page =&gt;
          page.data.map(user =&gt; &lt;li key={user.id}&gt;{user.first_name}&lt;/li&gt;)
        )}
      &lt;/ul&gt;
      {hasNextPage &amp;&amp; &lt;button onClick={() =&gt; fetchNextPage()}&gt;加载更多&lt;/button&gt;}
      {isFetching &amp;&amp; &lt;div&gt;更多状态加载中...&lt;/div&gt;}
    &lt;/div&gt;
  )
}

export default LoadMore<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>isLoading</code> 只有初次加载时才会变为 true，通常用作首次加载数据时的加载状态。</p>
<p><code>isFetching</code> 是只要发生加载行为就会变为 true，通过用作加载更多时的加载状态。</p>
<h4 id="8-4-11-useIsFetching-全局加载状态"><a href="#8-4-11-useIsFetching-全局加载状态" class="headerlink" title="8.4.11 useIsFetching 全局加载状态"></a>8.4.11 useIsFetching 全局加载状态</h4><p>只要程序中有状态在同步，useIsFetching 钩子函数获取的结果就为 true，可以通过它实现全局加载状态的提示。</p>
<p><code>yarn add react-spinners@0.10.6 @emotion/react@11.1.5</code></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { PacmanLoader } from "react-spinners"
import { useIsFetching } from "react-query"
import { css } from "@emotion/react"

const loaderCss = css`
  position: absolute;
  left: 100%;
  top: 0;
  transform: translateX(-400%);
  z-index: 1;
`

function GlobalLoading() {
  const isFetching = useIsFetching()
  return (
    &lt;PacmanLoader
      loading={isFetching}
      color={"rgba(175, 47, 47, 0.25)"}
      size={15}
      css={loaderCss}
    /&gt;
  )
}

export default GlobalLoading<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>







<h3 id="8-5-React-Modal"><a href="#8-5-React-Modal" class="headerlink" title="8.5 React Modal"></a>8.5 React Modal</h3><p><a target="_blank" rel="noopener" href="http://reactcommunity.org/react-modal/">React Modal 文档</a></p>
<img src="/medias/assets/images/52.gif" align="left" width="30%">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-modal<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useState } from "react";
import Modal from "react-modal";

Modal.setAppElement("#root");

function App() {
  const [modalIsOpen, setModalIsOpen] = useState(false);
  // onRequestClose: 在请求关闭弹框时执行该回调函数 (单击弹框主体区域外部或按ESC键)
  // shouldCloseOnOverlayClick: 点击弹框主体区域外部时是否关闭弹框, 配合 onRequestClose 一起使用 
  // 比如按ESC关闭弹框, 点击弹框主体区域外部不关闭弹框
  return (
    &lt;&gt;
      &lt;button onClick={() =&gt; setModalIsOpen(true)}&gt;打开弹框&lt;/button&gt;
      &lt;Modal
        style={{
          overlay: {
            backgroundColor: "rgba(100,100,100,0.5)",
          },
          content: {
            color: "skyblue",
          },
        }}
        isOpen={modalIsOpen}
        onRequestClose={() =&gt; setModalIsOpen(false)}
        shouldCloseOnOverlayClick={false}
      &gt;
        sdfsd
        &lt;button onClick={() =&gt; setModalIsOpen(false)}&gt;关闭弹框&lt;/button&gt;
      &lt;/Modal&gt;
    &lt;/&gt;
  );
}

export default App;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-6-React-Player"><a href="#8-6-React-Player" class="headerlink" title="8.6 React Player"></a>8.6 React Player</h3><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/react-player">React Player 文档</a></p>
<img src="/medias/assets/images/53.gif">

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-player<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ReactPlayer from "react-player"

function App() {
  return (
    &lt;ReactPlayer
      onStart={() =&gt; console.log("onStart calllback")}
      onEnded={() =&gt; console.log("onEnded calllback")}
      onPause={() =&gt; console.log("onPause calllback")}
      width="auto"
      muted={true}
      controls
      url="//vjs.zencdn.net/v/oceans.mp4"
    /&gt;
  )
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-7-React-Datepicker"><a href="#8-7-React-Datepicker" class="headerlink" title="8.7 React Datepicker"></a>8.7 React Datepicker</h3><img src="/medias/assets/images/53.png" align="left" width="23%">

<p><a target="_blank" rel="noopener" href="https://reactdatepicker.com/">react-datepicker</a> <a target="_blank" rel="noopener" href="https://date-fns.org/">date-fns</a></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-datepicker date-fns<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import DatePicker, { registerLocale, setDefaultLocale } from "react-datepicker"
import { useState } from "react"
import { addDays, subDays } from "date-fns"
import zhCN from "date-fns/locale/zh-CN"
import "react-datepicker/dist/react-datepicker.css"

// 注册语言
registerLocale("zh-CN", zhCN)
// 全局设置日期选择框语言
setDefaultLocale("zh-CN")

// subDays: 基于给定的日期减去指定的天数
// addDays: 基于给定的日期添加指定的天数

export default function App() {
  const [selectedDate, setSelectedDate] = useState(new Date())
  // minDate 能够选择的最早的日期
  // maxDate 能够选择的最晚的日期
  // dateFormat 日期格式化
  // onChange 当用户选择日期后执行的回调函数, 回调函数的参数就是用户选择的日期
  // selected 默认选中的日期
  // filterDate 日期过滤
  // showTimeSelect  显示时间选择
  return (
    &lt;DatePicker
      selected={selectedDate}
      onChange={date =&gt; setSelectedDate(date)}
      dateFormat="yyyy-MM-dd hh:mm:ss"
      filterDate={date =&gt; date.getDay() !== 6 &amp;&amp; date.getDay() !== 0}
      minDate={subDays(new Date(), 2)}
      maxDate={addDays(new Date(), 2)}
      showTimeSelect
    /&gt;
  )
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-8-React-Table"><a href="#8-8-React-Table" class="headerlink" title="8.8 React Table"></a>8.8 <a target="_blank" rel="noopener" href="https://react-table.tanstack.com/">React Table</a></h3><h4 id="8-8-1-概述"><a href="#8-8-1-概述" class="headerlink" title="8.8.1 概述"></a>8.8.1 概述</h4><h5 id="1-为什么学习-React-Table"><a href="#1-为什么学习-React-Table" class="headerlink" title="1. 为什么学习 React Table"></a>1. 为什么学习 React Table</h5><ol>
<li>使用表格进行数据可视化是不可避免的。</li>
<li>构建自己的表格组件可能会充满挑战。</li>
</ol>
<h5 id="2-React-Table"><a href="#2-React-Table" class="headerlink" title="2. React Table"></a>2. React Table</h5><p>React Table 用于构建强大的可扩展的数据表格，是一组钩子函数的集合，使用什么功能就调用什么钩子函数。</p>
<ol>
<li>React Table 采用无头设计，即不提供 UI 样式，开发者可以完全控制表格如何呈现，所以它不是表格组件，而是表格的实用工具集。</li>
<li>功能强大，提供了过滤，排序，分组，分页和列固定等等功能。</li>
<li>React Table 是可扩展的，因为它拥有自己的插件系统，使开发者可以覆盖或扩展React Table 内部的逻辑步骤，阶段或过程。</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> react-table@7.6.3 dateformat@4.5.1 react-table-sticky@1.1.3 styled-components@5.2.3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="8-8-2-Basic-Table"><a href="#8-8-2-Basic-Table" class="headerlink" title="8.8.2 Basic Table"></a>8.8.2 Basic Table</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/03.png">

<ol>
<li><p>获取要展示的数据。 生成模拟数据：<a target="_blank" rel="noopener" href="https://mockaroo.com/">mockaroo</a></p>
<img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/01.png"></li>
<li><p>定义表格的列。</p>
</li>
<li><p>使用 react-table 创建表格实例对象并传入要展示的数据和列信息。</p>
</li>
<li><p>使用 HTML 定义一个基本的表格结构。</p>
</li>
<li><p>将表格实例对象信息赋值给 HTML，展示数据。</p>
</li>
<li><p>引入 CSS 文件为表格添加样式 <a target="_blank" rel="noopener" href="https://www.w3schools.com/css/tryit.asp?filename=trycss_table_fancy">样式来源</a>。</p>
</li>
</ol>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// columns.js
// Header: 定义页头列名称
// accessor: 定义列关联的数据属性
export const COLUMNS = [
  {
    Header: "ID",
    accessor: "id"
  },
  {
    Header: "名",
    accessor: "first_name"
  },
  {
    Header: "姓",
    accessor: "last_name"
  },
  {
    Header: "出生日期",
    accessor: "date_of_birth"
  },
  {
    Header: "国家",
    accessor: "country"
  },
  {
    Header: "电话",
    accessor: "phone"
  }
]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// BasicTable.js
import { COLUMNS } from "./columns"
import MOCK_DATA from "./MOCK_DATA.json"
import { useMemo } from "react"
import { useTable } from "react-table"
import "./table.css"

const BasicTable = () =&gt; {
  // 缓存列信息
  const columns = useMemo(() =&gt; COLUMNS, [])
  // 缓存表格数据
  const data = useMemo(() =&gt; MOCK_DATA, [])
  // 创建表格实例对象
  const {
    // 获取 table 标记属性
    getTableProps,
    // 获取 tbody 标记属性
    getTableBodyProps,
    // 获取表格页头信息
    headerGroups,
    // 获取表格中要展示的数据
    rows,
    // 计算要显示的行信息 (比如分页, 当前页要显示哪些行)
    prepareRow
  } = useTable({
    columns,
    data
  })
  return (
    &lt;&gt;
      &lt;table {...getTableProps()}&gt;
        &lt;thead&gt;
          {headerGroups.map(headerGroup =&gt; (
            &lt;tr {...headerGroup.getHeaderGroupProps()}&gt;
              {headerGroup.headers.map(column =&gt; (
                &lt;th {...column.getHeaderProps()}&gt;
                  {column.render("Header")}
                &lt;/th&gt;
              ))}
            &lt;/tr&gt;
          ))}
        &lt;/thead&gt;
        &lt;tbody {...getTableBodyProps()}&gt;
          {rows.map(row =&gt; {
            prepareRow(row)
            return (
              &lt;tr {...row.getRowProps()}&gt;
                {row.cells.map(cell =&gt; (
                  &lt;td {...cell.getCellProps()}&gt;{cell.render("Cell")}&lt;/td&gt;
                ))}
              &lt;/tr&gt;
            )
          })}
        &lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/&gt;
  )
}

export default BasicTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">table</span> <span class="token punctuation">{</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> Arial<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
  <span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">table td,
table th</span> <span class="token punctuation">{</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ddd<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">table tr:nth-child(even)</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f2f2f2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">table tr:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #ddd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">table th, tfoot td</span> <span class="token punctuation">{</span>
  <span class="token property">padding-top</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
  <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #4caf50<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-3-创建表格页脚"><a href="#8-8-3-创建表格页脚" class="headerlink" title="8.8.3 创建表格页脚"></a>8.8.3 创建表格页脚</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/04.png">

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// columns.js</span>
<span class="token comment">// Footer: 定义页脚列名称</span>
export const COLUMNS = <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"名"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"姓"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"出生日期"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"国家"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Footer<span class="token operator">:</span> <span class="token string">"电话"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">const BasicTable = () =&gt; {
  // 获取表格页脚信息
  const { footerGroups } = useTable({})
  return (
    &lt;table&gt;
      &lt;tfoot&gt;
        {footerGroups.map(footerGroup =&gt; (
          &lt;tr {...footerGroup.getFooterGroupProps()}&gt;
            {footerGroup.headers.map(column =&gt; (
              &lt;th {...column.getFooterProps()}&gt;{column.render("Footer")}&lt;/th&gt;
            ))}
          &lt;/tr&gt;
        ))}
      &lt;/tfoot&gt;
    &lt;/table&gt;
  )
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-4-创建表格分组"><a href="#8-8-4-创建表格分组" class="headerlink" title="8.8.4 创建表格分组"></a>8.8.4 创建表格分组</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/05.png">

<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// columns.js</span>
export const COLUMNS_GROUP = <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"id"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Name"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Name"</span><span class="token punctuation">,</span>
    columns<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        Header<span class="token operator">:</span> <span class="token string">"First Name"</span><span class="token punctuation">,</span>
        Footer<span class="token operator">:</span> <span class="token string">"First Name"</span><span class="token punctuation">,</span>
        accessor<span class="token operator">:</span> <span class="token string">"first_name"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        Header<span class="token operator">:</span> <span class="token string">"Last Name"</span><span class="token punctuation">,</span>
        Footer<span class="token operator">:</span> <span class="token string">"Last Name"</span><span class="token punctuation">,</span>
        accessor<span class="token operator">:</span> <span class="token string">"last_name"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Info"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Info"</span><span class="token punctuation">,</span>
    columns<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        Header<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
        Footer<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
        accessor<span class="token operator">:</span> <span class="token string">"date_of_birth"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        Header<span class="token operator">:</span> <span class="token string">"Country"</span><span class="token punctuation">,</span>
        Footer<span class="token operator">:</span> <span class="token string">"Country"</span><span class="token punctuation">,</span>
        accessor<span class="token operator">:</span> <span class="token string">"country"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        Header<span class="token operator">:</span> <span class="token string">"Phone"</span><span class="token punctuation">,</span>
        Footer<span class="token operator">:</span> <span class="token string">"Phone"</span><span class="token punctuation">,</span>
        accessor<span class="token operator">:</span> <span class="token string">"phone"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// BasicTabel.js
import { COLUMNS_GROUP } from "./columns"

const BasicTable = () =&gt; {
  const columns = useMemo(() =&gt; COLUMNS_GROUP, [])
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-5-实现表格排序"><a href="#8-8-5-实现表格排序" class="headerlink" title="8.8.5 实现表格排序"></a>8.8.5 实现表格排序</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/06.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// SortingTable.js
import { useTable, useSortBy } from "react-table"

const SortingTable = () =&gt; {
  useTable({}, useSortBy)
  // column.getSortByToggleProps()
  // 将标记的鼠标移入样式改为手势, 表示该列是可以点击的
  // 实现点击列后, 对列数据进行排序 (升序, 降序, 默认排序交替)
  return (
    &lt;thead&gt;
      &lt;th {...column.getHeaderProps(column.getSortByToggleProps())}&gt;
        {column.render("Header")}
        &lt;span&gt;
          {column.isSorted ? (column.isSortedDesc ? "↓" : "↑") : ""}
        &lt;/span&gt;
      &lt;/th&gt;
    &lt;/thead&gt;
  )
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-6-单元格内容格式化"><a href="#8-8-6-单元格内容格式化" class="headerlink" title="8.8.6 单元格内容格式化"></a>8.8.6 单元格内容格式化</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/07.png">

<p>日期格式化：<code>yarn add dateformat</code></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> dateformat <span class="token keyword">from</span> <span class="token string">"dateformat"</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">COLUMNS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"date_of_birth"</span><span class="token punctuation">,</span>
    <span class="token function-variable function">Cell</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dateformat</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">"yyyy-mm-dd"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-7-实现全局过滤"><a href="#8-8-7-实现全局过滤" class="headerlink" title="8.8.7 实现全局过滤"></a>8.8.7 实现全局过滤</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/08.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// GlobalFilter.js
// 进行全局搜索的搜索框组件
const GlobalFilter = ({ filter, setFilter }) =&gt; {
  return (
    &lt;div&gt;
      搜索:{" "}
      &lt;input
        value={filter}
        onChange={event =&gt; setFilter(event.target.value)}
      /&gt;
    &lt;/div&gt;
  )
}

export default GlobalFilter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { useGlobalFilter } from "react-table"
import GlobalFilter from "./GlobalFilter"

const FilterTable = () =&gt; {
  const { state, setGlobalFilter } = useTable({}, useGlobalFilter)
  const { globalFilter } = state
  return (
    &lt;&gt;
      &lt;GlobalFilter filter={globalFilter} setFilter={setGlobalFilter} /&gt;
      &lt;table&gt;&lt;/table&gt;
    &lt;/&gt;
  )
}
export default FilterTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-8-实现列过滤"><a href="#8-8-8-实现列过滤" class="headerlink" title="8.8.8 实现列过滤"></a>8.8.8 实现列过滤</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/09.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// ColumnFilter.js
// 进行列搜索的搜索框组件
const ColumnFilter = ({ column }) =&gt; {
  const { filterValue, setFilter } = column
  return (
    &lt;div&gt;
      搜索:{" "}
      &lt;input
        value={filterValue}
        onChange={event =&gt; setFilter(event.target.value)}
      /&gt;
    &lt;/div&gt;
  )
}
export default ColumnFilter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// FilterTable.js
import { useFilters } from "react-table"

const FilterTable = () =&gt; {
  const { } = useTable({}, useFilters, useGlobalFilter)
  return (
    &lt;thead&gt;
      &lt;th&gt;
        &lt;div&gt;
          {column.canFilter ? column.render("Filter") : null}
        &lt;/div&gt;
      &lt;/th&gt;
    &lt;/thead&gt;
  )
}
export default FilterTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// columns.js</span>
<span class="token keyword">import</span> ColumnFilter <span class="token keyword">from</span> <span class="token string">"./ColumnFilter"</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">COLUMNS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
    Filter<span class="token operator">:</span> ColumnFilter
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-9-禁用过滤"><a href="#8-8-9-禁用过滤" class="headerlink" title="8.8.9 禁用过滤"></a>8.8.9 禁用过滤</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/10.png">

<p>在表格中的某一列不想使用过滤，需要显式进行声明，否则报错，声明如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// columns.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">COLUMNS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
    disableFilters<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-10-设置默认列属性"><a href="#8-8-10-设置默认列属性" class="headerlink" title="8.8.10 设置默认列属性"></a>8.8.10 设置默认列属性</h4><p>在每一列中 Filter 配置选项的值都是一样的，通过配置默认列可以去除重复配置。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// FilterTable.js
import ColumnFilter from "./ColumnFilter"

const FilterTable = () =&gt; {
  const defaultColumn = useMemo(() =&gt; ({ Filter: ColumnFilter }), [])
  const {} = useTable({ defaultColumn })
}
export default FilterTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后删除 columns.js 文件中的 Filter 配置选项。</p>
<h4 id="8-8-11-实现过滤防抖"><a href="#8-8-11-实现过滤防抖" class="headerlink" title="8.8.11 实现过滤防抖"></a>8.8.11 实现过滤防抖</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/12.gif">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// GlobalFilter.js
import { useAsyncDebounce } from "react-table"
import { useState } from "react"

const GlobalFilter = ({ filter, setFilter }) =&gt; {
  const [value, setValue] = useState(filter)
  const onChange = useAsyncDebounce(() =&gt; {
    setFilter(value)
  }, 1000)
  return (
    &lt;div&gt;
      搜索:{" "}
      &lt;input
        value={value || ""}
        onChange={event =&gt; {
          setValue(event.target.value)
          onChange()
        }}
      /&gt;
    &lt;/div&gt;
  )
}
export default GlobalFilter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-12-实现基本分页"><a href="#8-8-12-实现基本分页" class="headerlink" title="8.8.12 实现基本分页"></a>8.8.12 实现基本分页</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/11.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// PaginationTable.js
import { usePagination } from "react-table"

const PaginationTable = () =&gt; {
  const {
    // 分页数据
    page,
    // 跳转到下一页
    nextPage,
    // 跳转到上一页
    previousPage,
    // 是否存在下一页
    canNextPage,
    // 是否存在上一页
    canPreviousPage,
    // 一共有多少页
    pageCount,
    state,
  } = useTable({}, usePagination)
  // 页码
  const { pageIndex } = state

  return (
    &lt;&gt;
      &lt;table&gt;
        &lt;tbody&gt;
          {page.map(row =&gt; {})}
        &lt;/tbody&gt;
      &lt;/table&gt;
      &lt;div&gt;
        &lt;span&gt;
          {pageIndex + 1} / {pageCount}
        &lt;/span&gt;
        &lt;button disabled={!canPreviousPage} onClick={() =&gt; previousPage()}&gt;
          上一页
        &lt;/button&gt;
        &lt;button disabled={!canNextPage} onClick={() =&gt; nextPage()}&gt;
          下一页
        &lt;/button&gt;
      &lt;/div&gt;
    &lt;/&gt;
  )
}
export default PaginationTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-13-实现页码跳转"><a href="#8-8-13-实现页码跳转" class="headerlink" title="8.8.13 实现页码跳转"></a>8.8.13 实现页码跳转</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/13.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { usePagination } from "react-table"

const PaginationTable = () =&gt; {
  const { gotoPage } = useTable({ initialState: { pageIndex: 3 } }, usePagination)
  return (
    &lt;div&gt;
      &lt;span&gt;
        跳转到:{" "}
        &lt;input
          type="number"
          style={{ width: 50 }}
          value={pageIndex + 1}
          onChange={event =&gt; gotoPage(Number(event.target.value) - 1)}
         /&gt;
      &lt;/span&gt;
      &lt;button disabled={!canPreviousPage} onClick={() =&gt; gotoPage(0)}&gt;
        第一页
      &lt;/button&gt;
      &lt;button disabled={!canNextPage} onClick={() =&gt; gotoPage(pageCount - 1)}&gt;
        最后一页
      &lt;/button&gt;
    &lt;/div&gt;
  )
}

export default PaginationTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-14-设置数据显示条数"><a href="#8-8-14-设置数据显示条数" class="headerlink" title="8.8.14 设置数据显示条数"></a>8.8.14 设置数据显示条数</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/14.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { usePagination } from "react-table"

const PaginationTable = () =&gt; {
  const { setPageSize } = useTable({initialState: {pageSize: 25}})
  const { pageSize } = state

  return (
    &lt;select value={pageSize} onChange={event =&gt; setPageSize(Number(event.target.value))}&gt;
      {[10, 25, 50].map(pagesize =&gt; (
        &lt;option key={pagesize} value={pagesize}&gt;
          显示 {pagesize} 条数据
        &lt;/option&gt;
      ))}
    &lt;/select&gt;
  )
}

export default PaginationTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-15-实现选择行数据"><a href="#8-8-15-实现选择行数据" class="headerlink" title="8.8.15 实现选择行数据"></a>8.8.15 实现选择行数据</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/15.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// Checkbox.js
import { forwardRef } from "react"
// 将 indeterminate 从 props 单独解构出来, 它不能直接被添加到 input 身上
// ref: 因为 react-table 要为复选添加功能, 要对其进行操作, 所以通过 Ref 的方式获取该复选
// rest: 通过 props 的方式向复选框中添加属性以实现复选框的单选和全选功能
const Checkbox = forwardRef(({ indeterminate, ...rest }, ref) =&gt; {
  return &lt;input type="checkbox" ref={ref} {...rest} /&gt;
})

export default Checkbox<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// RowSelection.js
// 实现选择行数据功能
import { useRowSelect } from "react-table"
// 通过此复选框选择行数据
import Checkbox from "./Checkbox"

const RowSelection = () =&gt; {
  const {
    // 选择的结果数组
    selectedFlatRows
  } = useTable({ columns, data }, useRowSelect, hooks =&gt; {
    // 在初始化表格实例对象时调用
    // hooks: 对象, 钩子函数集合
    // 以编程方式向表格中添加列
    hooks.visibleColumns.push(columns =&gt; {
      // columns 现有的列数据
      return [
        {
          id: "selection",
          Header: ({ getToggleAllRowsSelectedProps }) =&gt; (
            // 实现全选功能
            &lt;Checkbox {...getToggleAllRowsSelectedProps()} /&gt;
          ),
          // 实现单选功能
          Cell: ({ row }) =&gt; &lt;Checkbox {...row.getToggleRowSelectedProps()} /&gt;
        },
        ...columns
      ]
    })
  })

  // 只显示前 10 条数据
  const firstPageRows = rows.slice(0, 10)

  return (
    &lt;div&gt;
      {JSON.stringify(
        { selectedRows: selectedFlatRows.map(row =&gt; row.original) },
        null,
        2
      )}
    &lt;/div&gt;
  )
}

export default RowSelection<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-16-更改列顺序"><a href="#8-8-16-更改列顺序" class="headerlink" title="8.8.16 更改列顺序"></a>8.8.16 更改列顺序</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/16.gif">

<p>在更改列顺序时，需要使用到列 id，对列 id 排序就是对列进行排序 。在没有为列添加 id 属性时， accessor 默认为列的 id。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// ColumnOrder.js
import { useColumnOrder } from "react-table"

const ColumnOrder = () =&gt; {
  const { setColumnOrder } = useTable({}, useColumnOrder)
  return (
    &lt;button
      onClick={() =&gt;
        setColumnOrder([
          "id",
          "first_name",
          "last_name",
          "phone",
          "country",
          "date_of_birth"
        ])
       }
      &gt;
      更改列书序
    &lt;/button&gt;
  )
}

export default ColumnOrder<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-17-显示隐藏列"><a href="#8-8-17-显示隐藏列" class="headerlink" title="8.8.17 显示隐藏列"></a>8.8.17 显示隐藏列</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/17.png">

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// ColumnHiding.js
import Checkbox from "./Checkbox"

const ColumnHiding = () =&gt; {
  const {
    // 列信息数组
    allColumns,
    // 显示和隐藏所有列
    getToggleHideAllColumnsProps
  } = useTable()
  return (
    &lt;div&gt;
      &lt;div&gt;
        &lt;Checkbox {...getToggleHideAllColumnsProps()} /&gt; 显示/隐藏所有列
      &lt;/div&gt;
      {allColumns.map(column =&gt; (
        &lt;div key={column.id}&gt;
          &lt;Checkbox {...column.getToggleHiddenProps()} /&gt; {column.Header }
        &lt;/div&gt;
      ))}
    &lt;/div&gt;
  )
}
export default ColumnHiding<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="8-8-18-实现列固定"><a href="#8-8-18-实现列固定" class="headerlink" title="8.8.18 实现列固定"></a>8.8.18 实现列固定</h4><img src="../../../../Downloads/ReactTable/讲义/assets/react-table-images/02.gif">

<p>创建样式化组件，为表格设置样式 <a target="_blank" rel="noopener" href="https://github.com/GuillaumeJasmin/react-table-sticky#simple-example">simple-example</a></p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// TableStyles.js
import styled from "styled-components"

export const Styles = styled.div`
  .table {
    border: 1px solid #ddd;

    .tr {
      :last-child {
        .td {
          border-bottom: 0;
        }
      }
    }

    .th,
    .td {
      padding: 5px;
      border-bottom: 1px solid #ddd;
      border-right: 1px solid #ddd;
      background-color: #fff;
      overflow: hidden;

      :last-child {
        border-right: 0;
      }
    }

    &amp;.sticky {
      overflow: scroll;
      .header,
      .footer {
        position: sticky;
        z-index: 1;
        width: fit-content;
      }

      .header {
        top: 0;
        box-shadow: 0px 3px 3px #ccc;
      }

      .footer {
        bottom: 0;
        box-shadow: 0px -3px 3px #ccc;
      }

      .body {
        position: relative;
        z-index: 0;
      }

      [data-sticky-td] {
        position: sticky;
      }

      [data-sticky-last-left-td] {
        box-shadow: 2px 0px 3px #ccc;
      }

      [data-sticky-first-right-td] {
        box-shadow: -2px 0px 3px #ccc;
      }
    }
  }
`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><p>创建 StickyTable 组件</p>
<p>先拷贝 BasicTable 组件，在此基础上进行修改。</p>
<p>在  <a target="_blank" rel="noopener" href="https://github.com/GuillaumeJasmin/react-table-sticky">react-table-sticky</a> 此处拷贝 JSX 。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// StickyTable.js
// useBlockLayout
// 为 row, cell 添加固定宽度
// 将 row 的 display 设置为 flex
// 将 cell 的 display 设置为 inline-block
// 将 cell 的 box-sizing 设置 border-box
import { useBlockLayout } from "react-table"
import { useSticky } from "react-table-sticky"
import { Styles } from "./TableStyles"

const StickyTable = () =&gt; {
  const {} = useTable({}, useBlockLayout, useSticky)
  return (
    &lt;Styles&gt;
      &lt;div
        {...getTableProps()}
        className="table sticky"
        style={{ width: 1000, height: 500 }}
      &gt;
        &lt;div className="header"&gt;
          {headerGroups.map(headerGroup =&gt; (
            &lt;div {...headerGroup.getHeaderGroupProps()} className="tr"&gt;
              {headerGroup.headers.map(column =&gt; (
                &lt;div {...column.getHeaderProps()} className="th"&gt;
                  {column.render("Header")}
                &lt;/div&gt;
              ))}
            &lt;/div&gt;
          ))}
        &lt;/div&gt;
        &lt;div {...getTableBodyProps()} className="body"&gt;
          {rows.map(row =&gt; {
            prepareRow(row)
            return (
              &lt;div {...row.getRowProps()} className="tr"&gt;
                {row.cells.map(cell =&gt; (
                  &lt;div {...cell.getCellProps()} className="td"&gt;
                    {cell.render("Cell")}
                  &lt;/div&gt;
                ))}
              &lt;/div&gt;
            )
          })}
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/Styles&gt;
  )
}

export default StickyTable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>指定固定列，添加 Email，Age 列。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// columns.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">COLUMNS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"ID"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
    disableFilters<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sticky<span class="token operator">:</span> <span class="token string">"left"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"First Name"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"First Name"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"first_name"</span><span class="token punctuation">,</span>
    sticky<span class="token operator">:</span> <span class="token string">"left"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Last Name"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Last Name"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"last_name"</span><span class="token punctuation">,</span>
    sticky<span class="token operator">:</span> <span class="token string">"left"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Date Of Birth"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"date_of_birth"</span><span class="token punctuation">,</span>
    <span class="token function-variable function">Cell</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> value <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dateformat</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Country"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Country"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"country"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Phone"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Phone"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"phone"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Email"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Email"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"email"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    Header<span class="token operator">:</span> <span class="token string">"Age"</span><span class="token punctuation">,</span>
    Footer<span class="token operator">:</span> <span class="token string">"Age"</span><span class="token punctuation">,</span>
    accessor<span class="token operator">:</span> <span class="token string">"age"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="1-类组件"><a href="#1-类组件" class="headerlink" title="1. 类组件"></a>1. 类组件</h3><h4 id="1-1-创建类组件"><a href="#1-1-创建类组件" class="headerlink" title="1.1 创建类组件"></a>1.1 创建类组件</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">import React, { Component } from 'react';

class Person extends Component {
  render () {
    return &lt;div&gt;Hello I am a class component&lt;/div&gt;
  }
}

export default Person;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-2-向类组件内部传递属性"><a href="#1-2-向类组件内部传递属性" class="headerlink" title="1.2 向类组件内部传递属性"></a>1.2 向类组件内部传递属性</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;Person name="张三" age={20}/&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">class Person extends Component {
  render() {
    const { name, age } = this.props
    return (
      &lt;div&gt;
        &lt;span&gt;{name}&lt;/span&gt;
        &lt;span&gt;{age}&lt;/span&gt;
      &lt;/div&gt;
    )
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-3-Props-默认值"><a href="#1-3-Props-默认值" class="headerlink" title="1.3 Props 默认值"></a>1.3 Props 默认值</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">class Person extends Component {
  static defaultProps = {}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="1-4-组件状态"><a href="#1-4-组件状态" class="headerlink" title="1.4 组件状态"></a>1.4 组件状态</h4><pre class="line-numbers language-react" data-language="react"><code class="language-react">class Person extends Component {
  constructor(){
    super();
    this.state = {
      name: "张三",
      age: 20
    }
    this.onClickHandler = this.onClickHandler.bind(this);
  }
  
 	onClickHandler() {
    this.setState({ ...this.state, name: "李四" });
  }

  render() {
    return (
      &lt;&gt;
        &lt;span&gt;{this.state.name}&lt;/span&gt;
        &lt;span&gt;{this.state.age}&lt;/span&gt;
      	&lt;button onClick={this.onClickHandler}&gt;更改数据&lt;/button&gt;
      &lt;/&gt;
    )
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-5-类组件生命周期函数"><a href="#1-5-类组件生命周期函数" class="headerlink" title="1.5 类组件生命周期函数"></a>1.5 类组件生命周期函数</h4><h5 id="1-5-1-概述"><a href="#1-5-1-概述" class="headerlink" title="1.5.1 概述"></a>1.5.1 概述</h5><p>生命周期如同四季更替，一个人的生、老、病、死，在每个特殊的年龄阶段，做着不同的事情。</p>
<p>组件也有生命周期，从组件被创建、被挂载到DOM中、直到从 DOM 中移除，这就是组件的生命周期。在组件生命周期的不同阶段，React 提供了对应的生命周期函数，让我们在不同阶段做不同的事情。这些函数将会被 React 自动调用执行。</p>
<p>生命周期大致分为三个部分：挂载、更新和卸载。</p>
<h5 id="1-5-2-组件挂载"><a href="#1-5-2-组件挂载" class="headerlink" title="1.5.2 组件挂载"></a>1.5.2 组件挂载</h5><p>当组件被创建并且被整体插入到 DOM 中叫做是挂载组件，在组件被创建和挂载的过程中以下方法被调用：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">// 设置组件的初始配置</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment">// 解析 JSX, 渲染DOM, 呈递用户界面</span>
<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 组件挂载完成后执行, 放置所有和DOM相关的操作，比如发送Ajax请求、设置定时器、添加事件监听、获取DOM元素</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="1-5-3-组件更新"><a href="#1-5-3-组件更新" class="headerlink" title="1.5.3 组件更新"></a>1.5.3 组件更新</h5><p>当组件状态发生变化时，组件重新渲染。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span>
render
componentDidUpdate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="1-5-3-组件卸载"><a href="#1-5-3-组件卸载" class="headerlink" title="1.5.3 组件卸载"></a>1.5.3 组件卸载</h5><p>组件卸载是指将组件从 DOM 中删除。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">componentWillUnmount   // 这个方法在组件从 DOM 中移除之前调用. 方法中可以执行清理工作. 例如删除事件监听, 清除定时器<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="1-6-上下文"><a href="#1-6-上下文" class="headerlink" title="1.6 上下文"></a>1.6 上下文</h4><ol>
<li><p>创建 Context 上下文对象, 导出 Provider 组件</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// TestContext.js
import { createContext } from "react"

export const TestContext = createContext()

export function TestProvider({ children, value }) {
  return &lt;TestContext.Provider value={value}&gt;{children}&lt;/TestContext.Provider&gt;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>将状态存储到上下文对象中</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import ReactDOM from "react-dom"
import App from "./App"
import { TestProvider } from "./TestContext"

ReactDOM.render(
  &lt;TestProvider value={{ test: "test" }}&gt;
    &lt;App /&gt;
  &lt;/TestProvider&gt;,
  document.getElementById("root")
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在组件中获取上下文对象中的状态</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Component } from "react"
import { TestContext } from "./TestContext"

class App extends Component {
  render() {
    return (
      &lt;div&gt;
        &lt;TestContext.Consumer&gt;
          {context =&gt; &lt;div&gt;{context.test}&lt;/div&gt;}
        &lt;/TestContext.Consumer&gt;
      &lt;/div&gt;
    )
  }
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在组件中获取上下文的另一种方式</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">import { Component } from "react"
import { TestContext } from "./TestContext"

class App extends Component {
  static contextType = TestContext
  render() {
    return &lt;div&gt;{this.context.test}&lt;/div&gt;
  }
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="1-7-错误边界"><a href="#1-7-错误边界" class="headerlink" title="1.7 错误边界"></a>1.7 错误边界</h4><p>默认情况下，组件渲染错误会导致整个应用程序中断，创建错误边界可确保在特定组件发生错误时应用程序不会中断。</p>
<p>错误边界是一个 React 组件，可以捕获子级组件在渲染时发生的错误，当错误发生时可以将错误记录下来，可以显示备用 UI 界面。</p>
<p>错误边界涉及到两个生命周期函数，分别为 getDerivedStateFromError 和 componentDidCatch。</p>
<p>getDerivedStateFromError 为静态方法，方法中需要返回一个对象，该对象会和state对象进行合并，用于更改应用程序状态。</p>
<p>componentDidCatch 方法用于记录应用程序错误信息，该方法的参数就是错误对象。 </p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// ErrorBoundaries.js
import React from "react"
import App from "./App"

export default class ErrorBoundaries extends React.Component {
  constructor() {
    super()
    this.state = {
      hasError: false
    }
  }
  componentDidCatch(error) {
    console.log("componentDidCatch")
  }
  static getDerivedStateFromError() {
    console.log("getDerivedStateFromError")
    return {
      hasError: true
    }
  }
  render() {
    if (this.state.hasError) {
      return &lt;div&gt;发生了错误&lt;/div&gt;
    }
    return &lt;App /&gt;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// App.js
import React from "react"

export default class App extends React.Component {
  render() {
    // throw new Error("lalala")
    return &lt;div&gt;App works&lt;/div&gt;
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// index.js
import React from "react"
import ReactDOM from "react-dom"
import ErrorBoundaries from "./ErrorBoundaries"

ReactDOM.render(&lt;ErrorBoundaries /&gt;, document.getElementById("root"))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-8-渲染属性"><a href="#1-8-渲染属性" class="headerlink" title="1.8 渲染属性"></a>1.8 渲染属性</h4><p>渲染属性是 React 中实现逻辑复用的一种高级技巧。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">// Resizeable.js
import React, { useEffect, useState } from "react"

function Resizeable({ render }) {
  const [sizes, setSizes] = useState([window.innerWidth, window.innerHeight])
  useEffect(() =&gt; {
    window.addEventListener("resize", () =&gt; {
      setSizes([window.innerWidth, window.innerHeight])
    })
  }, [])
  return render(sizes)
}

export default Resizeable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// index.js
import React from "react"
import ReactDOM from "react-dom"
import Resizeable from "Resizeable"
import App from "./App"

ReactDOM.render(
  &lt;Resizeable render={sizes =&gt; &lt;App sizes={sizes} /&gt;} /&gt;,
  document.getElementById("root")
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">// App.js
import React from "react"

function App({ sizes }) {
  return &lt;div&gt;{JSON.stringify(sizes)}&lt;/div&gt;
}

export default App<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-9-高阶组件"><a href="#1-9-高阶组件" class="headerlink" title="1.9  高阶组件"></a>1.9  高阶组件</h4><p>高阶组件用于共享代码，增加逻辑复用。</p>
<p>高阶组件是一种模式，一个函数接收组件作为参数，返回一个新的组件。</p>
<p>函数名称通常以with开头，接收的组件形参名称为 WrappedComponent，返回的组件名称和函数名称一样，只不过with中的w要大写。</p>
<pre class="line-numbers language-react" data-language="react"><code class="language-react">function withResizable(WrappedComponent, number) {
  class WithResizable extends Component {
    constructor() {
      this.state = {
        size: [window.innerWidth, window.innerHeight],
      };
    }
    onResize = () =&gt; {
      this.setState({
        size: [window.innerWidth * number, window.innerHeight],
      });
    };
    componentDidMount() {
      window.addEventListener("resize", this.onResize);
    }
    componentWillUnMount() {
      window.removeEventListener("resize", this.onResize);
    }
    render() {
      return &lt;WrappedComponent size={this.state.size} {...this.props} /&gt;;
    }
  }
  return WithResizable;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">class Foo extends Component {
  render () {
    const size = this.props.size;
    return &lt;div&gt;{size[0]} --- {size[1]}&lt;/div&gt;
  }
}

const WrapperedFoo = withResizable(Foo, 10);
export default WrapperedFoo;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-react" data-language="react"><code class="language-react">&lt;WrapperedFoo hello="world"/&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="2-配置路径别名"><a href="#2-配置路径别名" class="headerlink" title="2. 配置路径别名"></a>2. 配置路径别名</h3><ol>
<li><p>下载 <code>@craco/craco</code> 用于覆盖 <code>create-react-app</code> 脚手架工具自动生成的配置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> @craco/craco<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>在应用根目录下创建 <code>craco.config.js</code> 配置文件并加入路径别名配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  webpack<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"@component"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/components/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"@layouts"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/components/layouts"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"@pages"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/components/pages"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"@shared"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/components/shared"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"@state"</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"src/state"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>修改 <code>package.json</code> 文件中的应用启动命令</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"craco start"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"craco build"</span><span class="token punctuation">,</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"craco test"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在应用根目录下创建 <code>jsconfig.json</code> 文件，加入路径别名的配置，该配置用于让编译器识别路径别名。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"paths"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"@component/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src/components/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"@layouts/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src/components/layouts/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"@pages/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src/components/pages/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"@shared/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src/components/shared/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"@state/*"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./src/state/*"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>一般建议把不依赖props和state的函数提到你的组件外面，把那些仅被useEffect使用的函数放到useEffect里面。</p>
<p>如果在 useEffect 里面用到了组件内的函数或者通过 props 传递过来的函数，建议在创建函数的地方使用 useCallback 包裹函数并指定依赖项。</p>
<p>每次组件重新渲染，所有的东西都属于这次特定渲染，包括 props、state、事件处理函数、effect 等等。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">顾冷</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wuhongzhi5.github.io/2022/08/24/react/">https://wuhongzhi5.github.io/2022/08/24/react/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">顾冷</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/React/">
                                    <span class="chip bg-color">React</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    <article id="prenext-posts" class="prev-next articles">
        <div class="row article-row">
            
                    <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
                        <div class="article-badge left-badge text-color">
                            <i class="far fa-dot-circle"></i>&nbsp;本篇
                        </div>
                        <div class="card">
                            <a href="/2022/08/24/react/">
                                <div class="card-image">
                                    
                                            
                                                <img src="/medias/featureimages/15.jpg"
                                                    class="responsive-img" alt="React">
                                                
                                                    <span class="card-title">
                                                        React
                                                    </span>
                                </div>
                            </a>
                            <div class="card-content article-content">
                                <div class="summary block-with-text">
                                    
                                                
                                                    
                                </div>
                                <div class="publish-info">
                                    <span class="publish-date">
                                        <i class="far fa-clock fa-fw icon-date"></i>
                                        2022-08-24
                                    </span>
                                    <span class="publish-author">
                                        
                                                                <i class="fas fa-user fa-fw"></i>
                                                                顾冷
                                                                    
                                    </span>
                                </div>
                            </div>

                            
                                <div class="card-action article-tags">
                                    
                                        <a href="/tags/React/">
                                            <span class="chip bg-color">
                                                React
                                            </span>
                                        </a>
                                        
                                </div>
                                
                        </div>
                    </div>
                    
                        
                            <div class="article col s12 m6" data-aos="fade-up">
                                <div class="article-badge right-badge text-color">
                                    下一篇&nbsp;<i class="fas fa-chevron-right"></i>
                                </div>
                                <div class="card">
                                    <a href="/2021/11/16/hello-world/">
                                        <div class="card-image">
                                            
                                                    
                                                        <img src="/medias/featureimages/12.jpg"
                                                            class="responsive-img" alt="Hello World">
                                                        
                                                            <span class="card-title">
                                                                Hello World
                                                            </span>
                                        </div>
                                    </a>
                                    <div class="card-content article-content">
                                        <div class="summary block-with-text">
                                            
                                                        
                                                            
                                        </div>
                                        <div class="publish-info">
                                            <span class="publish-date">
                                                <i class="far fa-clock fa-fw icon-date"></i>
                                                2021-11-16
                                            </span>
                                            <span class="publish-author">
                                                
                                                                        <i class="fas fa-user fa-fw"></i>
                                                                        顾冷
                                                                            
                                            </span>
                                        </div>
                                    </div>
                                    
                                        <div class="card-action article-tags">
                                            
                                                <a href="/tags/Hello-World/">
                                                    <span class="chip bg-color">
                                                        Hello World
                                                    </span>
                                                </a>
                                                
                                        </div>
                                        
                                </div>
                            </div>
                            
        </div>
    </article>
</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录
            </div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

    <div id="floating-toc-btn" class="hide-on-med-and-down">
        <a class="btn-floating btn-large bg-color">
            <i class="fas fa-list-ul"></i>
        </a>
    </div>
    

        <script src="/libs/tocbot/tocbot.min.js"></script>
        <script>
            $(function () {
                tocbot.init({
                    tocSelector: '#toc-content',
                    contentSelector: '#articleContent',
                    headingsOffset: -($(window).height() * 0.4 - 45),
                    collapseDepth: Number('0'),
                    headingSelector: 'h2, h3, h4'
                });

                // modify the toc link href to support Chinese.
                let i = 0;
                let tocHeading = 'toc-heading-';
                $('#toc-content a').each(function () {
                    $(this).attr('href', '#' + tocHeading + (++i));
                });

                // modify the heading title id to support Chinese.
                i = 0;
                $('#articleContent').children('h2, h3, h4').each(function () {
                    $(this).attr('id', tocHeading + (++i));
                });

                // Set scroll toc fixed.
                let tocHeight = parseInt($(window).height() * 0.4 - 64);
                let $tocWidget = $('.toc-widget');
                let tocWidget = $(".toc-widget").height();
                $(window).scroll(function () {
                    let scroll = $(window).scrollTop();
                    /* add post toc fixed. */
                    if (scroll > tocHeight && tocWidget >= 500) {
                        $tocWidget.addClass('toc-fixed2');
                    } else if (scroll > tocHeight) {
                        $tocWidget.addClass('toc-fixed');
                    }
                    else {
                        $tocWidget.removeClass('toc-fixed');
                        $tocWidget.removeClass('toc-fixed2');
                    }
                });

        
                    /* 修复文章卡片 div 的宽度. */
                    let fixPostCardWidth = function (srcId, targetId) {
                        let srcDiv = $('#' + srcId);
                        if (srcDiv.length === 0) {
                            return;
                        }

                        let w = srcDiv.width();
                        if (w >= 450) {
                            w = w + 21;
                        } else if (w >= 350 && w < 450) {
                            w = w + 18;
                        } else if (w >= 300 && w < 350) {
                            w = w + 16;
                        } else {
                            w = w + 14;
                        }
                        $('#' + targetId).width(w);
                    };

                    // 切换TOC目录展开收缩的相关操作.
                    const expandedClass = 'expanded';
                    let $tocAside = $('#toc-aside');
                    let $mainContent = $('#main-content');
                    $('#floating-toc-btn .btn-floating').click(function () {
                        if ($tocAside.hasClass(expandedClass)) {
                            $tocAside.removeClass(expandedClass).hide();
                            $mainContent.removeClass('l9');
                        } else {
                            $tocAside.addClass(expandedClass).show();
                            $mainContent.addClass('l9');
                        }
                        fixPostCardWidth('artDetail', 'prenext-posts');
                    });
        
    });
        </script>
    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="tencent"
                   type="playlist"
                   id="2316847709"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

            
                <div class="container row center-align"
                    style="margin-bottom: 0px !important;">
                    <div class="col s12 m8 l8 copy-right">
                        Copyright&nbsp;&copy;
                        
                            <span id="year">
                                2019-2022
                            </span>
                            
                                    <span id="year">
                                        2019
                                    </span>
                                    <a href="/about" target="_blank">
                                        顾冷
                                    </a>
                                    |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
                                    |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery"
                                        target="_blank">Matery</a>
                                    <br>
                                    
                                            
                                                
                                                    
                                                        
                                                            <!-- 
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
             -->
                                                            <span>QQ:1035568475</span>
                                                            <br>
                                                            
                                                                    <br>
                                                                    
                    </div>
                    <div class="col s12 m4 l4 social-link social-statis">
                        
    <a href="https://github.com/wuhongzhi5" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1035568475@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1035568475" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1035568475" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>


                    </div>
                </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
